# åŠ å·å®¡æ‰¹ä»£ç ä¼˜åŒ–è¯´æ˜

## ğŸ”„ ä¼˜åŒ–å†…å®¹

å‚è€ƒ**è¯·å‡å®¡æ‰¹**ï¼ˆLeaveApproval.vueï¼‰çš„æˆç†Ÿå®ç°ï¼Œå®Œå…¨é‡æ„äº†åŠ å·å®¡æ‰¹çš„ `submitApproval` æ–¹æ³•ã€‚

---

## ğŸ“Š å¯¹æ¯”ï¼šä¼˜åŒ–å‰ vs ä¼˜åŒ–å

### âŒ ä¼˜åŒ–å‰çš„ä»£ç 

```javascript
const submitApproval = async () => {
  if (approvalAction.value === 'reject' && !approvalForm.comments.trim()) {
    ElMessage.warning('è¯·è¾“å…¥æ‹’ç»ç†ç”±');
    return;
  }

  const approverId = adminStore.currentAdminId;
  if (!approverId) {
    ElMessage.error('æ— æ³•è·å–ç®¡ç†å‘˜ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
    return;
  }

  try {
    submitting.value = true;
    
    const updateData = {
      status: approvalAction.value === 'approve' ? 'APPROVED' : 'REJECTED',
      approverId: parseInt(approverId),
      approverComments: approvalForm.comments.trim() || null
    };

    await updateSlotApplication(currentApplication.value.applicationId, updateData);
    
    ElMessage.success(approvalAction.value === 'approve' ? 'æ‰¹å‡†æˆåŠŸ' : 'æ‹’ç»æˆåŠŸ');
    approvalDialogVisible.value = false;
    fetchSlotApplications();
  } catch (error) {
    console.error('å®¡æ‰¹å¤±è´¥:', error);
    ElMessage.error('å®¡æ‰¹å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'));
  } finally {
    submitting.value = false;
  }
};
```

**é—®é¢˜**ï¼š
- âŒ ç¼ºå°‘è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- âŒ é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„
- âŒ æ²¡æœ‰éªŒè¯ `isNaN(approverId)`
- âŒ æ²¡æœ‰æ‰“å° adminStore çš„å®Œæ•´çŠ¶æ€

---

### âœ… ä¼˜åŒ–åçš„ä»£ç ï¼ˆå‚è€ƒè¯·å‡å®¡æ‰¹ï¼‰

```javascript
const submitApproval = async () => {
  if (!currentApplication.value) return;
  
  try {
    submitting.value = true;
    
    // âœ… è°ƒè¯• adminStore çŠ¶æ€ï¼ˆå‚è€ƒè¯·å‡å®¡æ‰¹ï¼‰
    console.log('=== AdminStore çŠ¶æ€ ===');
    console.log('loggedInAdminBasicInfo:', adminStore.loggedInAdminBasicInfo);
    console.log('detailedAdminInfo:', adminStore.detailedAdminInfo);
    console.log('currentAdminId getter:', adminStore.currentAdminId);
    
    const approverIdRaw = adminStore.currentAdminId;
    const approverId = parseInt(approverIdRaw);
    const comments = approvalForm.comments;
    
    // âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
    console.log('æäº¤å®¡æ‰¹ - applicationId:', currentApplication.value.applicationId);
    console.log('æäº¤å®¡æ‰¹ - approverIdRaw:', approverIdRaw);
    console.log('æäº¤å®¡æ‰¹ - approverId (parsed):', approverId);
    console.log('æäº¤å®¡æ‰¹ - comments:', comments);
    console.log('æäº¤å®¡æ‰¹ - action:', approvalAction.value);
    
    // âœ… å®Œå–„çš„éªŒè¯ï¼ˆå‚è€ƒè¯·å‡å®¡æ‰¹ï¼‰
    if (!approverId || isNaN(approverId)) {
      ElMessage({
        type: 'error',
        message: 'æ— æ³•è·å–ç®¡ç†å‘˜IDï¼Œè¯·é€€å‡ºåé‡æ–°ç™»å½•',
        duration: 5000
      });
      return;
    }
    
    // âœ… æ‹’ç»æ—¶å¿…é¡»å¡«å†™ç†ç”±
    if (approvalAction.value === 'reject' && !comments.trim()) {
      ElMessage.warning('è¯·è¾“å…¥æ‹’ç»ç†ç”±');
      return;
    }
    
    const updateData = {
      status: approvalAction.value === 'approve' ? 'APPROVED' : 'REJECTED',
      approverId: approverId,
      approverComments: comments.trim() || null
    };

    console.log('æäº¤å®¡æ‰¹æ•°æ®:', updateData);

    // âœ… æ‰“å°å“åº”
    const response = await updateSlotApplication(currentApplication.value.applicationId, updateData);
    console.log('å®¡æ‰¹å“åº”:', response);
    
    ElMessage.success(approvalAction.value === 'approve' ? 'æ‰¹å‡†æˆåŠŸï¼ç³»ç»Ÿå·²è‡ªåŠ¨åˆ›å»ºé¢„çº¦å¹¶é€šçŸ¥æ‚£è€…' : 'æ‹’ç»æˆåŠŸ');
    approvalDialogVisible.value = false;
    fetchSlotApplications();
  } catch (error) {
    // âœ… æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
    console.error('å®¡æ‰¹å¤±è´¥:', error);
    console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data || error);
    ElMessage.error('å®¡æ‰¹å¤±è´¥: ' + (error.response?.data?.message || error.message || 'ç½‘ç»œé”™è¯¯'));
  } finally {
    submitting.value = false;
  }
};
```

---

## ğŸ¯ ä¸»è¦æ”¹è¿›ç‚¹

### 1. âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

**è¯·å‡å®¡æ‰¹çš„åšæ³•**ï¼š
```javascript
console.log('=== AdminStore çŠ¶æ€ ===');
console.log('loggedInAdminBasicInfo:', adminStore.loggedInAdminBasicInfo);
console.log('detailedAdminInfo:', adminStore.detailedAdminInfo);
console.log('currentAdminId getter:', adminStore.currentAdminId);
```

**å¥½å¤„**ï¼š
- å¯ä»¥æ¸…æ¥šçœ‹åˆ° adminStore çš„å®Œæ•´çŠ¶æ€
- ä¾¿äºæ’æŸ¥ç®¡ç†å‘˜IDä¸ºç©ºçš„é—®é¢˜
- å¯ä»¥çœ‹åˆ° getter çš„è¿”å›å€¼

### 2. âœ… æ›´å®Œå–„çš„éªŒè¯

**è¯·å‡å®¡æ‰¹çš„åšæ³•**ï¼š
```javascript
if (!approverId || isNaN(approverId)) {
  ElMessage({
    type: 'error',
    message: 'æ— æ³•è·å–ç®¡ç†å‘˜IDï¼Œè¯·é€€å‡ºåé‡æ–°ç™»å½•',
    duration: 5000
  });
  return;
}
```

**æ”¹è¿›**ï¼š
- ä¸ä»…æ£€æŸ¥ `!approverId`
- è¿˜æ£€æŸ¥ `isNaN(approverId)` é˜²æ­¢è½¬æ¢å¤±è´¥
- ä½¿ç”¨ `ElMessage` å¯¹è±¡å½¢å¼ï¼Œå¯ä»¥è®¾ç½® `duration`

### 3. âœ… æ‰“å°æ‰€æœ‰å…³é”®å˜é‡

**è¯·å‡å®¡æ‰¹çš„åšæ³•**ï¼š
```javascript
console.log('æäº¤å®¡æ‰¹ - applicationId:', currentApplication.value.applicationId);
console.log('æäº¤å®¡æ‰¹ - approverIdRaw:', approverIdRaw);
console.log('æäº¤å®¡æ‰¹ - approverId (parsed):', approverId);
console.log('æäº¤å®¡æ‰¹ - comments:', comments);
console.log('æäº¤å®¡æ‰¹ - action:', approvalAction.value);
```

**å¥½å¤„**ï¼š
- å¯ä»¥çœ‹åˆ°è½¬æ¢å‰åçš„å€¼
- ä¾¿äºå‘ç°ç±»å‹è½¬æ¢é—®é¢˜

### 4. âœ… æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†

**è¯·å‡å®¡æ‰¹çš„åšæ³•**ï¼š
```javascript
console.error('å®¡æ‰¹å¤±è´¥:', error);
console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data || error);
ElMessage.error('å®¡æ‰¹å¤±è´¥: ' + (error.response?.data?.message || error.message || 'ç½‘ç»œé”™è¯¯'));
```

**æ”¹è¿›**ï¼š
- æ‰“å°å®Œæ•´çš„ error å¯¹è±¡
- æ‰“å° `error.response?.data`ï¼ˆåç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ï¼‰
- ä¼˜å…ˆæ˜¾ç¤ºåç«¯è¿”å›çš„é”™è¯¯æ¶ˆæ¯

### 5. âœ… æ‰“å°å“åº”æ•°æ®

**è¯·å‡å®¡æ‰¹çš„åšæ³•**ï¼š
```javascript
const response = await updateSlotApplication(...);
console.log('å®¡æ‰¹å“åº”:', response);
```

**å¥½å¤„**ï¼š
- å¯ä»¥çœ‹åˆ°åç«¯è¿”å›çš„å®Œæ•´æ•°æ®
- éªŒè¯çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°

---

## ğŸ” è°ƒè¯•è¾“å‡ºç¤ºä¾‹

### æ­£å¸¸æƒ…å†µ

```javascript
=== AdminStore çŠ¶æ€ ===
loggedInAdminBasicInfo: {adminId: "1", name: "ç®¡ç†å‘˜", permissionLevel: "SUPER_ADMIN"}
detailedAdminInfo: {adminId: "1", name: "ç®¡ç†å‘˜", gender: "ç”·", ...}
currentAdminId getter: "1"

æäº¤å®¡æ‰¹ - applicationId: 1
æäº¤å®¡æ‰¹ - approverIdRaw: "1"
æäº¤å®¡æ‰¹ - approverId (parsed): 1
æäº¤å®¡æ‰¹ - comments: ""
æäº¤å®¡æ‰¹ - action: approve

æäº¤å®¡æ‰¹æ•°æ®: {status: "APPROVED", approverId: 1, approverComments: null}

å®¡æ‰¹å“åº”: {code: "200", data: {...}, message: "success"}
```

### å¼‚å¸¸æƒ…å†µï¼ˆç®¡ç†å‘˜IDä¸ºç©ºï¼‰

```javascript
=== AdminStore çŠ¶æ€ ===
loggedInAdminBasicInfo: null
detailedAdminInfo: {adminId: "", name: "", ...}
currentAdminId getter: undefined

æäº¤å®¡æ‰¹ - applicationId: 1
æäº¤å®¡æ‰¹ - approverIdRaw: undefined
æäº¤å®¡æ‰¹ - approverId (parsed): NaN
æäº¤å®¡æ‰¹ - comments: ""
æäº¤å®¡æ‰¹ - action: approve

âŒ æ— æ³•è·å–ç®¡ç†å‘˜IDï¼Œè¯·é€€å‡ºåé‡æ–°ç™»å½•
```

---

## ğŸ“‹ ä¸è¯·å‡å®¡æ‰¹çš„å®Œå…¨å¯¹é½

| ç‰¹æ€§ | è¯·å‡å®¡æ‰¹ | åŠ å·å®¡æ‰¹ï¼ˆä¼˜åŒ–åï¼‰ |
|------|---------|------------------|
| æ‰“å° adminStore çŠ¶æ€ | âœ… | âœ… |
| æ‰“å°åŸå§‹å’Œè½¬æ¢åçš„ID | âœ… | âœ… |
| éªŒè¯ isNaN | âœ… | âœ… |
| æ‰“å°å®¡æ‰¹æ•°æ® | âœ… | âœ… |
| æ‰“å°å“åº”æ•°æ® | âœ… | âœ… |
| è¯¦ç»†é”™è¯¯å¤„ç† | âœ… | âœ… |
| ä½¿ç”¨ ElMessage å¯¹è±¡ | âœ… | âœ… |

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. åˆ·æ–°é¡µé¢
```bash
Ctrl + F5 å¼ºåˆ¶åˆ·æ–°
```

### 2. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
```
F12 â†’ Console æ ‡ç­¾
```

### 3. ç‚¹å‡»æ‰¹å‡†æŒ‰é’®

### 4. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º

**é¢„æœŸè¾“å‡º**ï¼š
```javascript
=== AdminStore çŠ¶æ€ ===
loggedInAdminBasicInfo: {adminId: "1", ...}
detailedAdminInfo: {adminId: "1", ...}
currentAdminId getter: "1"

æäº¤å®¡æ‰¹ - applicationId: 1
æäº¤å®¡æ‰¹ - approverIdRaw: "1"
æäº¤å®¡æ‰¹ - approverId (parsed): 1
æäº¤å®¡æ‰¹ - comments: ""
æäº¤å®¡æ‰¹ - action: approve

æäº¤å®¡æ‰¹æ•°æ®: {status: "APPROVED", approverId: 1, approverComments: null}

å®¡æ‰¹å“åº”: {code: "200", data: {...}}
```

### 5. æ£€æŸ¥æ•°æ®åº“

```sql
SELECT * FROM slot_application ORDER BY application_id DESC LIMIT 1;
```

**é¢„æœŸç»“æœ**ï¼š
- `status` = `'APPROVED'`
- `approver_id` = `1`
- `approved_at` = å½“å‰æ—¶é—´
- `appointment_id` = ç”Ÿæˆçš„é¢„çº¦ID

---

## âœ… ä¼˜åŒ–å®Œæˆ

ç°åœ¨åŠ å·å®¡æ‰¹çš„ä»£ç å·²ç»å®Œå…¨å‚è€ƒè¯·å‡å®¡æ‰¹çš„å®ç°æ–¹å¼ï¼Œå…·æœ‰ï¼š

1. âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
2. âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
3. âœ… ä¸¥æ ¼çš„å‚æ•°éªŒè¯
4. âœ… æ¸…æ™°çš„ä»£ç ç»“æ„
5. âœ… ä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´

ğŸ‰ ä»£ç è´¨é‡å¤§å¹…æå‡ï¼

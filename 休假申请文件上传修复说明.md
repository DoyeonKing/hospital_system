# 休假申请文件上传和查看功能修复说明

## 问题描述

休假申请功能中的文件上传和查看功能无法正常工作，具体表现为：
1. 点击"点击上传"按钮后无法上传文件
2. 已上传的文件无法查看

## 问题原因

### 1. 文件上传接口未在安全配置中放行
- **位置**: `springboot/src/main/java/com/example/springboot/security/WebSecurityConfig.java`
- **问题**: `/api/upload` 接口需要认证，但在安全配置中没有被放行
- **影响**: 医生上传文件时会收到 401 未授权错误

### 2. 前端上传地址使用硬编码URL
- **位置**: `vue/src/views/LeaveRequest.vue:216`
- **问题**: 使用 `http://localhost:8080/api/upload` 硬编码完整URL
- **影响**: 绕过Vite代理，可能导致跨域或连接失败

### 3. 文件URL拼接错误
- **位置**: `vue/src/views/LeaveRequest.vue:416`
- **问题**: 上传成功后拼接 `'http://localhost:8080' + response.url`
- **影响**: 在不同环境下URL可能不正确

### 4. 文件查看URL处理不当
- **位置**: `vue/src/views/LeaveRequest.vue:429`
- **问题**: 直接使用 `window.open(url)` 打开，未处理相对路径
- **影响**: 相对路径的文件无法正确打开

## 修复内容

### 1. 后端安全配置修复
**文件**: `springboot/src/main/java/com/example/springboot/security/WebSecurityConfig.java`

```java
// 添加以下两行配置，放行文件上传和访问接口
.requestMatchers("/api/upload").permitAll()  // 请假证明文件上传接口
.requestMatchers("/api/files/leave-proofs/**").permitAll()  // 请假证明文件访问接口
```

### 2. 前端上传地址修复
**文件**: `vue/src/views/LeaveRequest.vue:216`

**修改前**:
```javascript
const uploadAction = ref('http://localhost:8080/api/upload');
```

**修改后**:
```javascript
const uploadAction = ref('/api/upload'); // 使用相对路径，让Vite代理处理
```

### 3. 文件URL保存修复
**文件**: `vue/src/views/LeaveRequest.vue:413-422`

**修改前**:
```javascript
const handleUploadSuccess = (response, file) => {
  if (response.success) {
    ElMessage.success('文件上传成功');
    applyForm.proofDocumentUrl = 'http://localhost:8080' + response.url;
  } else {
    ElMessage.error(response.message || '文件上传失败');
  }
};
```

**修改后**:
```javascript
const handleUploadSuccess = (response, file) => {
  console.log('文件上传响应:', response);
  if (response.success) {
    ElMessage.success('文件上传成功');
    // 直接使用后端返回的URL（已包含/api前缀）
    applyForm.proofDocumentUrl = response.url;
  } else {
    ElMessage.error(response.message || '文件上传失败');
  }
};
```

### 4. 文件查看功能修复
**文件**: `vue/src/views/LeaveRequest.vue:429-434`

**修改前**:
```javascript
const viewProof = (url) => {
  window.open(url, '_blank');
};
```

**修改后**:
```javascript
const viewProof = (url) => {
  // 如果URL是相对路径，需要拼接完整URL
  const fullUrl = url.startsWith('http') ? url : `http://localhost:8080${url}`;
  window.open(fullUrl, '_blank');
};
```

## 测试步骤

### 1. 重启后端服务
```bash
cd springboot
mvn spring-boot:run
```

### 2. 重启前端服务
```bash
cd vue
npm run dev
```

### 3. 测试文件上传
1. 登录医生工作台
2. 进入"我的休假申请"页面
3. 点击"申请休假"按钮
4. 填写表单信息
5. 点击"点击上传"按钮
6. 选择一个图片或PDF文件（小于5MB）
7. 确认文件上传成功提示

### 4. 测试文件查看
1. 提交休假申请后
2. 在列表中找到刚才提交的申请
3. 点击"查看证明"按钮
4. 确认文件在新标签页中正确打开

## 技术说明

### 后端接口说明

#### 文件上传接口
- **URL**: `POST /api/upload`
- **参数**: `file` (MultipartFile)
- **返回**:
  ```json
  {
    "success": true,
    "message": "文件上传成功",
    "url": "/api/files/leave-proofs/proof_20251224_153000_abc123.jpg",
    "filename": "proof_20251224_153000_abc123.jpg",
    "originalName": "证明.jpg",
    "size": 123456
  }
  ```

#### 文件访问接口
- **URL**: `GET /api/files/leave-proofs/{filename}`
- **返回**: 文件二进制内容
- **Content-Type**: 根据文件类型自动设置（image/jpeg, image/png, application/pdf）

### 文件存储位置
- **相对路径**: `uploads/leave-proofs/`
- **文件命名**: `proof_{时间戳}_{随机UUID}.{扩展名}`
- **示例**: `proof_20251224_153000_abc12345.jpg`

### 安全说明

文件上传和访问接口已设置为公开访问（permitAll），原因：
1. 文件上传需要在用户提交申请前完成，此时可能还未完全认证
2. 文件访问需要支持管理员审批时查看证明文件
3. 文件名使用UUID随机生成，难以被猜测
4. 文件类型和大小已在后端进行严格验证

## 注意事项

1. **文件大小限制**: 最大5MB
2. **文件类型限制**: 仅支持 JPG、PNG、PDF 格式
3. **文件存储**: 文件保存在项目根目录的 `uploads/leave-proofs/` 文件夹中
4. **生产环境**: 建议将文件存储到云存储服务（如阿里云OSS、腾讯云COS）

## 相关文件

### 后端文件
- `springboot/src/main/java/com/example/springboot/controller/FileUploadController.java` - 文件上传控制器
- `springboot/src/main/java/com/example/springboot/security/WebSecurityConfig.java` - 安全配置
- `springboot/src/main/java/com/example/springboot/config/WebConfig.java` - 静态资源映射配置

### 前端文件
- `vue/src/views/LeaveRequest.vue` - 休假申请页面
- `vue/src/api/leave.js` - 休假申请API接口
- `vue/vite.config.js` - Vite代理配置

## 修复日期
2024年12月24日

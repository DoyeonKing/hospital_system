# AI 智能预问诊功能使用说明

## 📋 功能简介

AI 智能预问诊是一个基于通义千问大模型的智能分诊系统，可以根据患者描述的症状，自动分析病情并推荐合适的就诊科室和医生。

---

## 🚀 启动步骤

### 1. 启动后端服务

```bash
# 进入后端目录
cd ai_pre_triage_backend

# 安装依赖（首次运行需要）
npm install

# 启动服务
npm start
```

**成功启动后会看到：**
```
✅ 已加载 config_env.js 配置文件
✅ 数据库连接成功
🚀 AI 预问诊服务已启动
📍 服务地址: http://localhost:3000
```

### 2. 配置检查

确保 `ai_pre_triage_backend/config_env.js` 文件中的配置正确：

```javascript
module.exports = {
    DB_HOST: 'localhost',        // 数据库地址
    DB_PORT: 3306,               // 数据库端口
    DB_USER: 'root',             // 数据库用户名
    DB_PASSWORD: '123456',        // 数据库密码
    DB_NAME: 'hospital',          // 数据库名称
    QWEN_API_KEY: '你的API密钥',  // 通义千问 API Key（必填）
    QWEN_MODEL: 'qwen-max',       // 模型名称（默认 qwen-max）
    PORT: 3000                    // 后端服务端口
};
```

**重要：** 需要配置有效的通义千问 API Key，否则 AI 分析功能无法使用。

### 3. 启动前端（uni-app）

在 HBuilderX 或其他 uni-app 开发工具中：
1. 打开 `uni_app` 目录
2. 运行到浏览器或微信开发者工具
3. 确保前端配置的 API 地址指向 `http://localhost:3000`

---

## 📱 使用流程

### 步骤 1：进入 AI 预问诊页面

在首页点击 **"AI 预问诊"** 功能卡片（🤖 图标）

### 步骤 2：描述症状

有两种方式输入症状：

**方式一：点击热门症状标签**
- 页面顶部会显示热门症状标签（如：咳嗽、发热、头痛等）
- 点击标签即可快速添加到输入框

**方式二：手动输入**
- 在文本框中详细描述您的症状
- 例如："头痛伴有发热，持续两天，伴有恶心"
- 最多可输入 200 字

### 步骤 3：提交分析

点击 **"智能分析与挂号"** 按钮，系统会：
1. 调用通义千问 AI 分析您的症状
2. 根据分析结果推荐合适的科室
3. 显示病情分析和推荐理由

### 步骤 4：选择科室

- 查看 AI 推荐的科室列表
- 点击选择您要就诊的科室
- 系统会自动为您推荐该科室的专家医生

### 步骤 5：选择医生并挂号

- 查看推荐的医生列表（显示姓名、职称、擅长领域）
- 点击 **"去挂号"** 按钮
- 跳转到医生排班页面，选择具体时间段完成预约

---

## 🔧 常见问题

### Q1: 提示 "AI 分析失败" 怎么办？

**可能原因：**
1. 后端服务未启动
2. 通义千问 API Key 未配置或无效
3. 网络连接问题

**解决方法：**
- 检查后端服务是否正常运行（访问 http://localhost:3000/health）
- 检查 `config_env.js` 中的 `QWEN_API_KEY` 是否正确
- 查看后端控制台的错误日志

### Q2: 如何测试后端服务是否正常？

```bash
# 在浏览器或 Postman 中访问
GET http://localhost:3000/health

# 应该返回：
{
  "status": "ok",
  "message": "AI 预问诊服务运行正常"
}
```

### Q3: 如何测试 AI 功能？

```bash
# 进入后端目录
cd ai_pre_triage_backend

# 运行测试脚本
node test_qwen.js
```

### Q4: 数据库连接失败？

确保：
1. MySQL 服务已启动
2. 数据库 `hospital` 已创建
3. `config_env.js` 中的数据库配置正确
4. 相关数据表已创建（departments、doctors 等）

---

## 📝 技术说明

### 使用的 AI 模型

- **服务商：** 阿里云通义千问
- **模型：** qwen-max（默认，可配置为 qwen-turbo、qwen-plus 等）
- **API 模式：** OpenAI 兼容模式

### 主要接口

1. **获取热门症状**
   - `GET /api/symptoms/popular`
   - 从症状映射表中提取热门症状关键词

2. **AI 智能分诊**
   - `POST /api/pre-triage/recommend-department`
   - 输入：患者症状描述
   - 输出：推荐科室及分析结果

3. **医生推荐**
   - `POST /api/pre-triage/recommend-doctor`
   - 输入：科室ID、症状描述
   - 输出：推荐医生列表

### 降级方案

如果 AI 调用失败，系统会自动使用症状映射表（`symptom_department_mapping`）进行关键词匹配，确保服务可用性。

---

## ⚠️ 注意事项

1. **API 密钥安全**
   - 不要将 `config_env.js` 文件提交到代码仓库
   - 建议使用环境变量或 `.env` 文件管理敏感信息

2. **数据库依赖**
   - 确保数据库中有科室和医生数据
   - 症状映射表（`symptom_department_mapping`）用于降级方案

3. **网络要求**
   - 后端需要能够访问通义千问 API（https://dashscope.aliyuncs.com）
   - 前端需要能够访问后端服务地址

4. **端口占用**
   - 默认使用 3000 端口，如被占用请修改 `PORT` 配置
   - 前端需要同步修改 API 地址配置

---

## 📞 技术支持

如遇到问题，请检查：
1. 后端控制台日志
2. 浏览器开发者工具的网络请求
3. 数据库连接状态
4. API 密钥有效性

---

**祝使用愉快！** 🎉









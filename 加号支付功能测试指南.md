# åŠ å·æ”¯ä»˜åŠŸèƒ½æµ‹è¯•æŒ‡å—

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨åŠ å·é¢„çº¦è¯¦æƒ…é¡µé¢çœ‹åˆ°"å¾…æ”¯ä»˜"çŠ¶æ€ï¼Œä½†æ˜¯ï¼š
1. âŒ æ²¡æœ‰æ”¯ä»˜æŒ‰é’®
2. âŒ äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼ˆæ˜¾ç¤º"ç”ŸæˆäºŒç»´ç ä¸­..."ï¼‰

## è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

1. **æ·»åŠ å¾…æ”¯ä»˜æç¤ºå¡ç‰‡**
   - æ˜¾ç¤ºæŒ‚å·è´¹é‡‘é¢
   - æ˜¾ç¤ºæ”¯ä»˜æˆªæ­¢æ—¶é—´
   - ç¾è§‚çš„æ¸å˜è“è‰²èƒŒæ™¯

2. **æ·»åŠ æ”¯ä»˜æŒ‰é’®**
   - ç»¿è‰²æ¸å˜æŒ‰é’®
   - ç‚¹å‡»åé€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®/æ ¡å›­å¡ï¼‰
   - ç¡®è®¤åè°ƒç”¨æ”¯ä»˜æ¥å£

3. **ä¿®å¤äºŒç»´ç æ˜¾ç¤ºé€»è¾‘**
   - å¾…æ”¯ä»˜çŠ¶æ€ï¼šä¸æ˜¾ç¤ºäºŒç»´ç 
   - å·²æ”¯ä»˜çŠ¶æ€ï¼šæ˜¾ç¤ºç­¾åˆ°äºŒç»´ç 
   - é¿å…æ··æ·†

### ä¿®æ”¹çš„æ–‡ä»¶

- `uni_app/pages/appointment/detail.vue`
  - æ·»åŠ  `isPendingPaymentStatus()` æ–¹æ³•
  - æ·»åŠ  `handlePayment()` å’Œ `processPayment()` æ–¹æ³•
  - æ·»åŠ å¾…æ”¯ä»˜å¡ç‰‡æ ·å¼
  - æ·»åŠ æ”¯ä»˜æŒ‰é’®æ ·å¼

## æµ‹è¯•æ­¥éª¤

### å‰ç½®æ¡ä»¶

1. ç¡®ä¿åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
2. ç¡®ä¿å·²æœ‰ä¸€ä¸ªå¾…æ”¯ä»˜çš„åŠ å·é¢„çº¦ï¼ˆçŠ¶æ€ï¼š`PENDING_PAYMENT`ï¼‰

### æµ‹è¯•æµç¨‹

#### 1. æŸ¥çœ‹å¾…æ”¯ä»˜çŠ¶æ€

**æ“ä½œ**ï¼š
- æ‰“å¼€åŠ å·é¢„çº¦è¯¦æƒ…é¡µé¢

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"å¾…æ”¯ä»˜"çŠ¶æ€å›¾æ ‡ï¼ˆâ³ï¼‰
- âœ… æ˜¾ç¤ºè“è‰²å¾…æ”¯ä»˜æç¤ºå¡ç‰‡
- âœ… å¡ç‰‡æ˜¾ç¤ºæŒ‚å·è´¹é‡‘é¢
- âœ… å¡ç‰‡æ˜¾ç¤ºæ”¯ä»˜æˆªæ­¢æ—¶é—´ï¼ˆ24å°æ—¶åï¼‰
- âœ… æ˜¾ç¤ºæ’é˜Ÿå·ï¼ˆç¬¬101å·æˆ–æ›´é«˜ï¼‰
- âŒ **ä¸æ˜¾ç¤º**äºŒç»´ç åŒºåŸŸ
- âœ… æ˜¾ç¤ºç»¿è‰²"ç«‹å³æ”¯ä»˜"æŒ‰é’®
- âœ… æ˜¾ç¤º"å–æ¶ˆé¢„çº¦"æŒ‰é’®

#### 2. ç‚¹å‡»æ”¯ä»˜æŒ‰é’®

**æ“ä½œ**ï¼š
- ç‚¹å‡»"ç«‹å³æ”¯ä»˜"æŒ‰é’®

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¼¹å‡ºæ”¯ä»˜æ–¹å¼é€‰æ‹©èœå•
- âœ… æ˜¾ç¤ºä¸‰ä¸ªé€‰é¡¹ï¼š
  - ğŸ’š å¾®ä¿¡æ”¯ä»˜
  - ğŸ”µ æ”¯ä»˜å®
  - ğŸ’³ æ ¡å›­å¡ä½™é¢

#### 3. é€‰æ‹©æ”¯ä»˜æ–¹å¼

**æ“ä½œ**ï¼š
- é€‰æ‹©ä»»æ„æ”¯ä»˜æ–¹å¼ï¼ˆå¦‚ï¼šå¾®ä¿¡æ”¯ä»˜ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- âœ… æ˜¾ç¤ºæ”¯ä»˜é‡‘é¢
- âœ… æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼åç§°

#### 4. ç¡®è®¤æ”¯ä»˜

**æ“ä½œ**ï¼š
- ç‚¹å‡»"ç¡®å®š"æŒ‰é’®

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"æ”¯ä»˜ä¸­..."åŠ è½½æç¤º
- âœ… è°ƒç”¨åç«¯æ”¯ä»˜æ¥å£
- âœ… æ”¯ä»˜æˆåŠŸåæ˜¾ç¤º"æ”¯ä»˜æˆåŠŸ"æç¤º
- âœ… 2ç§’åè‡ªåŠ¨åˆ·æ–°é¡µé¢

#### 5. æ”¯ä»˜æˆåŠŸå

**æ“ä½œ**ï¼š
- ç­‰å¾…é¡µé¢åˆ·æ–°

**é¢„æœŸç»“æœ**ï¼š
- âœ… çŠ¶æ€å˜ä¸º"å·²é¢„çº¦"ï¼ˆâœ…ï¼‰
- âœ… **æ˜¾ç¤ºç­¾åˆ°äºŒç»´ç **
- âœ… äºŒç»´ç æ­£å¸¸ç”Ÿæˆï¼ˆä¸å†æ˜¾ç¤º"ç”ŸæˆäºŒç»´ç ä¸­..."ï¼‰
- âœ… æ˜¾ç¤ºäºŒç»´ç åˆ·æ–°å€’è®¡æ—¶
- âœ… æ˜¾ç¤º"å¯¼èˆªåˆ°è¯Šå®¤"æŒ‰é’®
- âŒ **ä¸å†æ˜¾ç¤º**"ç«‹å³æ”¯ä»˜"æŒ‰é’®
- âœ… ä»æ˜¾ç¤º"å–æ¶ˆé¢„çº¦"æŒ‰é’®ï¼ˆå·²æ”¯ä»˜ä¹Ÿå¯ä»¥å–æ¶ˆï¼‰

### åç«¯éªŒè¯

**SQLæŸ¥è¯¢**ï¼š
```sql
-- æŸ¥çœ‹é¢„çº¦çŠ¶æ€å˜åŒ–
SELECT 
    appointment_id,
    patient_id,
    status,
    payment_status,
    payment_method,
    appointment_type,
    appointment_number,
    created_at,
    updated_at
FROM appointments
WHERE appointment_id = ?;

-- æŸ¥çœ‹æ’ç­çš„å·²é¢„çº¦æ•°æ˜¯å¦å¢åŠ 
SELECT 
    schedule_id,
    total_slots,
    booked_slots,
    remarks
FROM schedules
WHERE schedule_id = ?;
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… `status` ä» `PENDING_PAYMENT` å˜ä¸º `scheduled`
- âœ… `payment_status` ä» `unpaid` å˜ä¸º `paid`
- âœ… `payment_method` è®°å½•äº†æ”¯ä»˜æ–¹å¼
- âœ… `booked_slots` å¢åŠ äº† 1
- âœ… `appointment_type` ä¸º `ADD_ON`
- âœ… `appointment_number` >= 101

## å¼‚å¸¸åœºæ™¯æµ‹è¯•

### åœºæ™¯1ï¼šæ”¯ä»˜è¶…æ—¶

**æ“ä½œ**ï¼š
1. ç­‰å¾…24å°æ—¶ä¸æ”¯ä»˜
2. å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å–æ¶ˆé¢„çº¦

**é¢„æœŸç»“æœ**ï¼š
- âœ… é¢„çº¦çŠ¶æ€å˜ä¸º `cancelled`
- âœ… æ‚£è€…æ”¶åˆ°è¶…æ—¶é€šçŸ¥
- âœ… å·æºè‡ªåŠ¨é‡Šæ”¾ï¼ˆä¸ä¿®æ”¹ `totalSlots`ï¼‰

### åœºæ™¯2ï¼šé‡å¤æ”¯ä»˜

**æ“ä½œ**ï¼š
1. æ”¯ä»˜æˆåŠŸå
2. å†æ¬¡å°è¯•æ”¯ä»˜

**é¢„æœŸç»“æœ**ï¼š
- âœ… ä¸æ˜¾ç¤º"ç«‹å³æ”¯ä»˜"æŒ‰é’®
- âœ… æ— æ³•é‡å¤æ”¯ä»˜

### åœºæ™¯3ï¼šå–æ¶ˆå¾…æ”¯ä»˜é¢„çº¦

**æ“ä½œ**ï¼š
1. åœ¨å¾…æ”¯ä»˜çŠ¶æ€
2. ç‚¹å‡»"å–æ¶ˆé¢„çº¦"

**é¢„æœŸç»“æœ**ï¼š
- âœ… é¢„çº¦è¢«å–æ¶ˆ
- âœ… å·æºè‡ªåŠ¨é‡Šæ”¾
- âœ… è¿”å›ä¸Šä¸€é¡µ

## å‰åç«¯äº¤äº’æµç¨‹

```
å‰ç«¯                          åç«¯
  |                            |
  |-- ç‚¹å‡»"ç«‹å³æ”¯ä»˜" ---------->|
  |                            |
  |<-- é€‰æ‹©æ”¯ä»˜æ–¹å¼ ------------|
  |                            |
  |-- POST /api/appointments/{id}/pay -->
  |    {                       |
  |      paymentMethod: "wechat",
  |      transactionId: "TXN..."
  |    }                       |
  |                            |
  |                            |-- éªŒè¯é¢„çº¦çŠ¶æ€
  |                            |-- æ£€æŸ¥æ”¯ä»˜æœŸé™
  |                            |-- æ›´æ–°é¢„çº¦çŠ¶æ€
  |                            |-- å¢åŠ  bookedSlots
  |                            |-- å‘é€é€šçŸ¥
  |                            |
  |<-- 200 OK ------------------|
  |    {                       |
  |      appointmentId: 123,   |
  |      status: "scheduled",  |
  |      paymentStatus: "paid" |
  |    }                       |
  |                            |
  |-- åˆ·æ–°é¡µé¢ ---------------->|
  |                            |
  |-- GET /api/appointments/{id}/qr-code -->
  |                            |
  |<-- è¿”å›äºŒç»´ç Token ---------|
  |                            |
  |-- æ˜¾ç¤ºäºŒç»´ç  ---------------|
```

## æ³¨æ„äº‹é¡¹

1. **æ”¯ä»˜æœŸé™**ï¼šåŠ å·é¢„çº¦çš„æ”¯ä»˜æœŸé™ä¸º24å°æ—¶
2. **åºå·èŒƒå›´**ï¼šåŠ å·é¢„çº¦çš„åºå·ä»101å¼€å§‹
3. **å·æºå ç”¨**ï¼šåªæœ‰æ”¯ä»˜æˆåŠŸåæ‰å ç”¨ `bookedSlots`
4. **äºŒç»´ç æ˜¾ç¤º**ï¼šåªæœ‰å·²æ”¯ä»˜çŠ¶æ€æ‰æ˜¾ç¤ºäºŒç»´ç 
5. **è‡ªåŠ¨å–æ¶ˆ**ï¼šè¶…æ—¶æœªæ”¯ä»˜ä¼šè‡ªåŠ¨å–æ¶ˆï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå¾…æ”¯ä»˜çŠ¶æ€ä¸æ˜¾ç¤ºäºŒç»´ç ï¼Ÿ

**A**: äºŒç»´ç æ˜¯ç”¨äºç­¾åˆ°çš„ï¼Œåªæœ‰æ”¯ä»˜æˆåŠŸåæ‰èƒ½ç­¾åˆ°ã€‚å¾…æ”¯ä»˜çŠ¶æ€æ˜¾ç¤ºäºŒç»´ç ä¼šé€ æˆæ··æ·†ã€‚

### Q2: æ”¯ä»˜åäºŒç»´ç è¿˜æ˜¯æ˜¾ç¤º"ç”ŸæˆäºŒç»´ç ä¸­..."ï¼Ÿ

**A**: å¯èƒ½çš„åŸå› ï¼š
1. åç«¯äºŒç»´ç æ¥å£å¼‚å¸¸
2. é¢„çº¦çŠ¶æ€æœªæ­£ç¡®æ›´æ–°
3. ç½‘ç»œå»¶è¿Ÿ

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥åç«¯æ—¥å¿—
- æ‰‹åŠ¨åˆ·æ–°é¡µé¢
- æ£€æŸ¥é¢„çº¦çŠ¶æ€æ˜¯å¦ä¸º `scheduled`

### Q3: æ”¯ä»˜æŒ‰é’®ç‚¹å‡»æ²¡ååº”ï¼Ÿ

**A**: å¯èƒ½çš„åŸå› ï¼š
1. `appointmentId` ä¸ºç©º
2. æ”¯ä»˜æ¥å£å¼‚å¸¸
3. å‰ç«¯ä»£ç æœªæ­£ç¡®å¯¼å…¥ `payForAppointment`

**è§£å†³æ–¹æ³•**ï¼š
- æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯
- æ£€æŸ¥ç½‘ç»œè¯·æ±‚
- ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸

## æ€»ç»“

ä¿®æ”¹åçš„åŠ å·æ”¯ä»˜åŠŸèƒ½ï¼š
- âœ… æ¸…æ™°çš„å¾…æ”¯ä»˜æç¤º
- âœ… ä¾¿æ·çš„æ”¯ä»˜æµç¨‹
- âœ… æ­£ç¡®çš„äºŒç»´ç æ˜¾ç¤ºé€»è¾‘
- âœ… å®Œæ•´çš„çŠ¶æ€æµè½¬
- âœ… ç¾è§‚çš„UIè®¾è®¡

ç°åœ¨ç”¨æˆ·å¯ä»¥é¡ºåˆ©å®ŒæˆåŠ å·é¢„çº¦çš„æ”¯ä»˜æµç¨‹äº†ï¼

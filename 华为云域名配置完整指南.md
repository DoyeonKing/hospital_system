# 华为云域名配置完整指南

## 📋 前置条件

根据你的华为云控制台，你已经拥有：
- ✅ 弹性云服务器 ECS（1台）
- ✅ 弹性公网IP EIP（1个）
- ✅ 虚拟私有云 VPC
- ✅ 数据库已连接（123.249.30.241）

现在需要配置域名和HTTPS，让小程序可以访问你的API。

---

## 🎯 方案一：使用华为云域名服务（推荐）

### 步骤1：购买或使用已有域名

1. **登录华为云控制台**
   - 访问：https://console.huaweicloud.com/

2. **购买域名（如果没有）**
   - 在控制台搜索栏输入"域名注册"
   - 或直接访问：https://console.huaweicloud.com/dns/
   - 选择并购买一个域名（如：`yourdomain.com`）
   - 价格通常几十元/年

3. **如果已有域名**
   - 需要将域名解析服务器改为华为云的DNS
   - 在域名注册商处修改DNS为：
     ```
     ns1.hwclouds-dns.com
     ns2.hwclouds-dns.com
     ```

### 步骤2：配置域名解析

1. **进入DNS控制台**
   - 在华为云控制台搜索"云解析服务 DNS"
   - 或访问：https://console.huaweicloud.com/dns/

2. **添加解析记录**
   - 点击你的域名
   - 点击"添加记录集"
   - 配置如下：
     ```
     主机记录：api（或留空，表示根域名）
     类型：A
     线路类型：全网默认
     记录值：你的EIP地址（在弹性公网IP页面查看）
     TTL：300（5分钟）
     ```
   - 点击"确定"

3. **等待解析生效**
   - 通常5-30分钟生效
   - 可以用 `ping api.yourdomain.com` 测试是否解析成功

### 步骤3：申请SSL证书（免费）

1. **进入SSL证书管理**
   - 在控制台搜索"SSL证书管理"
   - 或访问：https://console.huaweicloud.com/scm/

2. **申请免费证书**
   - 点击"购买证书"
   - 选择"DigiCert 免费证书"（DV证书，免费）
   - 点击"立即购买"（免费，无需付费）

3. **填写证书信息**
   - 证书类型：DV
   - 域名类型：单域名
   - 域名：`api.yourdomain.com`（或你的完整域名）
   - 联系人信息：填写你的信息
   - 点击"提交申请"

4. **域名验证**
   - 选择"自动DNS验证"（推荐，最简单）
   - 或选择"手动DNS验证"（需要手动添加TXT记录）
   - 等待验证通过（通常几分钟到几小时）

5. **下载证书**
   - 验证通过后，点击"下载证书"
   - 选择"Nginx"格式（如果使用Nginx）或"Tomcat"格式（如果直接用Spring Boot）
   - 下载后会得到：
     - 证书文件（.crt 或 .pem）
     - 私钥文件（.key）

---

## 🔧 方案二：在服务器上配置HTTPS

### 方式A：使用Nginx反向代理（推荐）

#### 1. 安装Nginx

```bash
# 连接到你的华为云服务器
ssh root@你的服务器IP

# CentOS/RHEL
yum install nginx -y

# Ubuntu/Debian
apt-get update
apt-get install nginx -y
```

#### 2. 配置Nginx

编辑Nginx配置文件：

```bash
vim /etc/nginx/nginx.conf
```

或创建站点配置：

```bash
vim /etc/nginx/conf.d/api.conf
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;
    
    # 重定向HTTP到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;
    
    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/api.yourdomain.com.crt;  # 证书文件路径
    ssl_certificate_key /etc/nginx/ssl/api.yourdomain.com.key;  # 私钥文件路径
    
    # SSL优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 反向代理到Spring Boot
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

#### 3. 上传SSL证书

```bash
# 创建SSL证书目录
mkdir -p /etc/nginx/ssl

# 上传证书文件（使用scp或直接在服务器上创建）
# 将下载的证书文件上传到 /etc/nginx/ssl/
```

#### 4. 启动Nginx

```bash
# 测试配置
nginx -t

# 启动Nginx
systemctl start nginx
systemctl enable nginx  # 开机自启

# 检查状态
systemctl status nginx
```

#### 5. 配置防火墙

```bash
# 开放80和443端口
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload

# 或使用iptables
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

### 方式B：直接在Spring Boot配置HTTPS

#### 1. 上传证书到服务器

```bash
# 在服务器上创建证书目录
mkdir -p /etc/ssl/hospital-api

# 上传证书文件
# 将下载的证书文件上传到服务器
```

#### 2. 修改Spring Boot配置

编辑 `springboot/src/main/resources/application.yml`：

```yaml
server:
  port: 8080
  address: 0.0.0.0
  ssl:
    enabled: true
    key-store: /etc/ssl/hospital-api/keystore.p12  # 需要转换为PKCS12格式
    key-store-password: your-password
    key-store-type: PKCS12
    key-alias: tomcat
```

#### 3. 转换证书格式

```bash
# 将证书转换为PKCS12格式（在服务器上执行）
openssl pkcs12 -export \
  -in api.yourdomain.com.crt \
  -inkey api.yourdomain.com.key \
  -out keystore.p12 \
  -name tomcat \
  -password pass:your-password
```

---

## 🔒 方案三：使用华为云WAF/ELB（高级方案）

如果你需要更高的性能和安全性，可以使用华为云的负载均衡器（ELB）：

1. **创建负载均衡器**
   - 在控制台搜索"弹性负载均衡 ELB"
   - 创建负载均衡实例
   - 选择公网类型

2. **配置监听器**
   - 添加HTTPS监听器（443端口）
   - 上传SSL证书（在华为云SSL证书管理中选择）

3. **添加后端服务器**
   - 添加你的ECS服务器
   - 配置健康检查

4. **配置域名解析**
   - 将域名解析到ELB的公网IP

---

## ✅ 配置完成后

### 1. 测试HTTPS访问

```bash
# 在浏览器或命令行测试
curl https://api.yourdomain.com/health

# 或访问
https://api.yourdomain.com/swagger-ui.html
```

### 2. 修改小程序配置

编辑 `uni_app/config/index.js`：

```javascript
const production = {
	baseURL: 'https://api.yourdomain.com',  // 👈 改为你的实际域名
	aiBaseURL: 'https://api.yourdomain.com'  // 如果AI服务也在同一服务器
}

const USE_PRODUCTION = true  // 👈 发布体验版时改为 true
```

### 3. 在微信公众平台配置域名

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** → **开发管理** → **开发设置**
3. 找到 **服务器域名**，点击 **修改**
4. 添加你的域名：
   ```
   https://api.yourdomain.com
   ```
5. 保存配置

---

## 🚀 快速方案：使用华为云测试域名（临时）

如果暂时没有域名，可以使用华为云提供的测试方案：

### 使用华为云API网关

1. **创建API网关**
   - 在控制台搜索"API网关 APIG"
   - 创建API分组
   - 系统会自动分配一个测试域名（格式：`xxxxx.apigw.huaweicloud.com`）

2. **配置API**
   - 创建API，后端指向你的ECS服务器
   - 配置HTTPS（API网关自带SSL证书）

3. **使用测试域名**
   - 直接使用API网关提供的域名
   - 在微信公众平台配置该域名

**注意**：测试域名可能不稳定，建议正式使用还是购买自己的域名。

---

## 📝 检查清单

配置完成后，确认：
- [ ] 域名已解析到EIP（可以用ping测试）
- [ ] SSL证书已申请并下载
- [ ] Nginx/Spring Boot已配置HTTPS
- [ ] 防火墙已开放443端口
- [ ] 可以访问 https://api.yourdomain.com
- [ ] 小程序配置已更新为生产环境域名
- [ ] 微信公众平台已配置服务器域名

---

## ❓ 常见问题

### Q: 域名必须备案吗？

**A**: 
- **体验版**：通常不需要备案
- **正式版**：根据小程序类目，部分需要备案
- 如果使用华为云服务器，建议在华为云备案（控制台有"备案"入口）

### Q: 免费SSL证书够用吗？

**A**: 
- 华为云提供的免费DV证书完全够用
- 支持HTTPS加密，满足微信小程序要求
- 有效期1年，到期前可以续期

### Q: 如何查看我的EIP地址？

**A**: 
1. 在华为云控制台搜索"弹性公网IP"
2. 找到你的EIP，查看公网IP地址
3. 这就是需要配置到域名解析的IP

### Q: 配置后无法访问怎么办？

**A**: 
1. 检查域名解析是否生效：`ping api.yourdomain.com`
2. 检查服务器防火墙是否开放443端口
3. 检查Nginx/Spring Boot是否正常运行
4. 检查SSL证书配置是否正确
5. 查看服务器日志：`tail -f /var/log/nginx/error.log`

---

## 💡 推荐配置方案

**最简单方案**（推荐新手）：
1. 购买域名（华为云或第三方）
2. 配置域名解析到EIP
3. 申请华为云免费SSL证书
4. 使用Nginx反向代理配置HTTPS
5. 配置微信小程序域名

**最快方案**（临时测试）：
1. 使用华为云API网关的测试域名
2. 直接配置到微信小程序

**最稳定方案**（生产环境）：
1. 购买域名并备案
2. 使用华为云ELB负载均衡
3. 配置SSL证书
4. 配置CDN加速（可选）

---

## 📞 需要帮助？

如果遇到问题：
1. 查看华为云官方文档：https://support.huaweicloud.com/
2. 联系华为云技术支持
3. 查看项目中的其他配置文档







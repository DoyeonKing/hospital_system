# 华为云域名配置快速步骤

## 🎯 目标
将你的API通过域名和HTTPS访问，让微信小程序可以调用。

---

## 📝 第一步：获取你的EIP地址

1. 在华为云控制台顶部搜索栏输入：**弹性公网IP**
2. 点击进入，找到你的EIP
3. **记录下公网IP地址**（例如：`123.249.30.xxx`）

---

## 🌐 第二步：配置域名解析

### 选项A：如果你已有域名

1. **进入DNS控制台**
   - 搜索：**云解析服务 DNS**
   - 或直接访问：https://console.huaweicloud.com/dns/

2. **添加解析记录**
   - 点击你的域名
   - 点击 **添加记录集**
   - 填写：
     ```
     主机记录：api（表示 api.yourdomain.com）
     类型：A
     记录值：你的EIP地址（第一步记录的）
     TTL：300
     ```
   - 点击 **确定**

### 选项B：如果你没有域名

**方案1：购买域名（推荐）**
- 在华为云搜索：**域名注册**
- 选择一个域名购买（通常几十元/年）
- 然后按选项A配置解析

**方案2：使用API网关测试域名（临时）**
- 搜索：**API网关 APIG**
- 创建API分组，系统会分配测试域名
- 直接使用该域名（格式：`xxxxx.apigw.huaweicloud.com`）

---

## 🔒 第三步：申请SSL证书（免费）

1. **进入SSL证书管理**
   - 搜索：**SSL证书管理**
   - 或访问：https://console.huaweicloud.com/scm/

2. **购买免费证书**
   - 点击 **购买证书**
   - 选择 **DigiCert 免费证书**（DV，免费）
   - 点击 **立即购买**

3. **填写证书信息**
   - 域名类型：单域名
   - 域名：`api.yourdomain.com`（你的完整域名）
   - 验证方式：**自动DNS验证**（最简单）
   - 填写联系人信息
   - 提交申请

4. **等待验证通过**
   - 通常几分钟到几小时
   - 验证通过后，点击 **下载证书**
   - 选择 **Nginx** 格式下载

---

## ⚙️ 第四步：在服务器上配置HTTPS

### 方式1：使用Nginx（推荐）

#### 1. 连接服务器
```bash
ssh root@你的服务器IP
```

#### 2. 安装Nginx
```bash
# CentOS
yum install nginx -y

# Ubuntu
apt-get update && apt-get install nginx -y
```

#### 3. 上传证书
```bash
# 创建证书目录
mkdir -p /etc/nginx/ssl

# 将下载的证书文件上传到这个目录
# 使用scp或直接在服务器上创建文件
```

#### 4. 配置Nginx
```bash
vim /etc/nginx/conf.d/api.conf
```

粘贴以下配置（**记得修改域名和证书路径**）：

```nginx
# HTTP重定向到HTTPS
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS配置
server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;
    
    # SSL证书（修改为你的证书路径）
    ssl_certificate /etc/nginx/ssl/api.yourdomain.com.crt;
    ssl_certificate_key /etc/nginx/ssl/api.yourdomain.com.key;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 反向代理到Spring Boot（8080端口）
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 5. 启动Nginx
```bash
# 测试配置
nginx -t

# 启动Nginx
systemctl start nginx
systemctl enable nginx

# 检查状态
systemctl status nginx
```

#### 6. 开放防火墙端口
```bash
# 开放80和443端口
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

### 方式2：使用华为云ELB（更简单，但需要费用）

1. 搜索：**弹性负载均衡 ELB**
2. 创建负载均衡实例
3. 添加HTTPS监听器（443端口）
4. 在证书管理中选择你申请的SSL证书
5. 添加后端服务器（你的ECS）
6. 将域名解析改为指向ELB的IP

---

## ✅ 第五步：测试配置

1. **测试域名解析**
   ```bash
   ping api.yourdomain.com
   # 应该返回你的EIP地址
   ```

2. **测试HTTPS访问**
   ```bash
   curl https://api.yourdomain.com/swagger-ui.html
   # 或在浏览器访问
   ```

3. **如果无法访问，检查**：
   - 域名解析是否生效
   - Nginx是否运行：`systemctl status nginx`
   - 防火墙是否开放443端口
   - Spring Boot是否在运行：`netstat -tlnp | grep 8080`

---

## 📱 第六步：配置小程序

1. **修改小程序配置**
   
   编辑 `uni_app/config/index.js`：
   ```javascript
   const production = {
       baseURL: 'https://api.yourdomain.com',  // 👈 改为你的实际域名
       aiBaseURL: 'https://api.yourdomain.com'
   }
   
   const USE_PRODUCTION = true  // 👈 改为 true
   ```

2. **在微信公众平台配置域名**
   - 登录：https://mp.weixin.qq.com/
   - 进入：**开发** → **开发管理** → **开发设置**
   - 找到 **服务器域名**，点击 **修改**
   - 添加：`https://api.yourdomain.com`
   - 保存

---

## 📋 完整检查清单

- [ ] 已获取EIP地址
- [ ] 已配置域名解析（或使用API网关测试域名）
- [ ] 已申请并下载SSL证书
- [ ] 已在服务器配置Nginx/ELB
- [ ] 已测试HTTPS可以访问
- [ ] 已修改小程序配置为生产环境
- [ ] 已在微信公众平台配置服务器域名

---

## 🚨 常见问题快速解决

### 问题1：域名解析不生效
- 等待5-30分钟
- 检查解析记录是否正确
- 使用 `nslookup api.yourdomain.com` 检查

### 问题2：无法访问HTTPS
- 检查Nginx配置：`nginx -t`
- 检查证书路径是否正确
- 检查防火墙：`firewall-cmd --list-all`
- 查看Nginx日志：`tail -f /var/log/nginx/error.log`

### 问题3：Spring Boot无法访问
- 检查Spring Boot是否运行：`ps aux | grep java`
- 检查8080端口：`netstat -tlnp | grep 8080`
- 检查Nginx代理配置

---

## 💡 推荐配置流程

**最简单（适合新手）**：
1. 购买域名 → 配置解析 → 申请SSL证书 → 配置Nginx → 完成

**最快（临时测试）**：
1. 使用API网关测试域名 → 直接配置到小程序

**最稳定（生产环境）**：
1. 购买域名并备案 → 使用ELB负载均衡 → 配置SSL → 完成

---

## 📞 需要帮助？

- 华为云技术支持：https://support.huaweicloud.com/
- 查看详细指南：`华为云域名配置完整指南.md`




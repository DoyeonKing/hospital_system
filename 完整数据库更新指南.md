# 完整数据库更新指南

## 📊 更新概览

根据你的代码改动，主要涉及以下数据库表的更新：

### ✅ 需要更新的表

1. **map_nodes** - 地图节点表（需要添加二维码字段）
2. **locations** - 诊室位置表（通过外键关联到map_nodes）

---

## 🎯 主要更新内容

### 1. map_nodes 表 - 添加二维码字段

**需要添加的字段：**

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| qrcode_content | VARCHAR(255) | 二维码内容 | NULL |
| qrcode_image_path | VARCHAR(500) | 二维码图片路径 | NULL |
| qrcode_generated_at | TIMESTAMP | 二维码生成时间 | NULL |
| qrcode_status | ENUM | 二维码状态 | 'pending' |

---

## 🚀 执行步骤

### 方式一：使用批处理脚本（推荐）

双击运行 `update_db_fields.bat`，按提示操作即可。

### 方式二：手动执行SQL

#### 步骤 1: 检查当前字段

```sql
USE hospital_system;

-- 查看 map_nodes 表结构
DESC map_nodes;

-- 检查二维码字段是否存在
SELECT COUNT(*) AS 二维码字段数量
FROM INFORMATION_SCHEMA.COLUMNS
WHERE 
    TABLE_SCHEMA = 'hospital_system' 
    AND TABLE_NAME = 'map_nodes'
    AND COLUMN_NAME IN ('qrcode_content', 'qrcode_image_path', 'qrcode_generated_at', 'qrcode_status');
```

**期望结果：** 返回 4（如果返回少于4，说明需要添加字段）

#### 步骤 2: 添加二维码字段

```sql
USE hospital_system;

-- 添加字段
ALTER TABLE `map_nodes` 
ADD COLUMN `qrcode_content` VARCHAR(255) NULL COMMENT '二维码内容（格式：HOSPITAL_NODE_{nodeId}）' AFTER `is_accessible`,
ADD COLUMN `qrcode_image_path` VARCHAR(500) NULL COMMENT '二维码图片存储路径' AFTER `qrcode_content`,
ADD COLUMN `qrcode_generated_at` TIMESTAMP NULL COMMENT '二维码生成时间' AFTER `qrcode_image_path`,
ADD COLUMN `qrcode_status` ENUM('active','inactive','pending') NOT NULL DEFAULT 'pending' COMMENT '二维码状态' AFTER `qrcode_generated_at`;

-- 为现有节点生成默认二维码内容
UPDATE `map_nodes` 
SET `qrcode_content` = CONCAT('HOSPITAL_NODE_', `node_id`)
WHERE `qrcode_content` IS NULL;

-- 创建索引以提高查询性能
CREATE INDEX `idx_qrcode_content` ON `map_nodes` (`qrcode_content`);
CREATE INDEX `idx_qrcode_status` ON `map_nodes` (`qrcode_status`);
```

#### 步骤 3: 初始化所有诊室的二维码数据

```sql
-- 确保所有节点都有二维码内容
UPDATE `map_nodes` 
SET 
    `qrcode_content` = CONCAT('HOSPITAL_NODE_', `node_id`),
    `qrcode_status` = CASE 
        WHEN `qrcode_status` IS NULL THEN 'pending'
        ELSE `qrcode_status`
    END,
    `qrcode_generated_at` = CASE 
        WHEN `qrcode_generated_at` IS NULL THEN NOW()
        ELSE `qrcode_generated_at`
    END
WHERE `qrcode_content` IS NULL OR `qrcode_content` = '';
```

#### 步骤 4: 验证更新结果

```sql
-- 查看所有节点及其二维码信息
SELECT 
    n.`node_id` as '节点ID',
    n.`node_name` as '节点名称',
    n.`coordinates_x` as 'X坐标',
    n.`coordinates_y` as 'Y坐标',
    n.`qrcode_content` as '二维码内容',
    n.`qrcode_status` as '状态',
    CASE 
        WHEN EXISTS (SELECT 1 FROM `locations` WHERE `map_node_id` = n.`node_id`) 
        THEN '是'
        ELSE '否'
    END as '是否关联诊室'
FROM `map_nodes` n
ORDER BY n.`node_id`;

-- 查看诊室及其对应的二维码信息
SELECT 
    l.`location_id` as '诊室ID',
    l.`location_name` as '诊室名称',
    l.`building` as '楼栋',
    l.`room_number` as '房间号',
    n.`node_id` as '节点ID',
    n.`qrcode_content` as '二维码内容',
    n.`qrcode_status` as '状态'
FROM `locations` l
LEFT JOIN `map_nodes` n ON l.`map_node_id` = n.`node_id`
ORDER BY l.`location_id`;
```

---

## 📁 相关文件清单

### SQL脚本文件

| 文件路径 | 用途 | 执行顺序 |
|---------|------|---------|
| `check_db_fields.sql` | 检查字段是否存在 | 1 |
| `sql语句/修改语句/add_qrcode_to_map_nodes.sql` | 添加二维码字段 | 2 |
| `sql语句/修改语句/init_qrcode_for_all_locations.sql` | 初始化二维码数据 | 3 |

### Java代码文件

| 文件路径 | 作用 |
|---------|------|
| `springboot/src/main/java/com/example/springboot/entity/MapNode.java` | 实体类（包含二维码字段） |
| `springboot/src/main/java/com/example/springboot/dto/map/MapNodeDTO.java` | DTO类（包含二维码字段） |
| `springboot/src/main/java/com/example/springboot/repository/MapNodeRepository.java` | Repository接口 |
| `springboot/src/main/java/com/example/springboot/service/QRCodeService.java` | 二维码服务类 |
| `springboot/src/main/java/com/example/springboot/controller/QRCodeController.java` | 二维码控制器 |

### 工具文件

| 文件路径 | 作用 |
|---------|------|
| `tools/generate_qrcode.py` | Python二维码生成脚本 |
| `tools/generate_all_qrcodes.py` | 批量生成二维码脚本 |
| `tools/qrcode_generator.html` | HTML二维码生成工具 |

---

## ⚠️ 注意事项

### 1. 备份数据库（重要！）

在执行任何ALTER TABLE操作之前，务必备份数据库：

```bash
# 完整备份
mysqldump -u root -p hospital_system > backup_before_qrcode_$(date +%Y%m%d_%H%M%S).sql

# 只备份结构
mysqldump -u root -p --no-data hospital_system > backup_structure.sql

# 只备份 map_nodes 表
mysqldump -u root -p hospital_system map_nodes > backup_map_nodes.sql
```

### 2. 检查外键约束

locations 表通过 `map_node_id` 外键关联到 map_nodes 表：

```sql
-- 查看外键约束
SELECT 
    CONSTRAINT_NAME,
    TABLE_NAME,
    COLUMN_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE
    TABLE_SCHEMA = 'hospital_system'
    AND REFERENCED_TABLE_NAME = 'map_nodes';
```

### 3. 数据一致性检查

更新后，确保所有诊室都关联到了正确的节点：

```sql
-- 检查未关联节点的诊室
SELECT 
    location_id,
    location_name,
    building,
    room_number
FROM locations
WHERE map_node_id IS NULL;

-- 检查未生成二维码的节点
SELECT 
    node_id,
    node_name,
    qrcode_content,
    qrcode_status
FROM map_nodes
WHERE qrcode_content IS NULL OR qrcode_content = '';
```

---

## ✅ 更新后的验证清单

### 数据库层面

- [ ] map_nodes 表包含4个二维码字段
- [ ] 所有现有节点的 qrcode_content 已自动生成
- [ ] qrcode_status 默认值为 'pending'
- [ ] 索引已创建（idx_qrcode_content, idx_qrcode_status）
- [ ] 外键约束正常工作

### 应用层面

- [ ] Spring Boot 应用可以正常启动（无字段映射错误）
- [ ] MapNode 实体类字段与数据库匹配
- [ ] MapNodeDTO 数据传输正常
- [ ] 二维码相关API可以正常调用

### 功能测试

- [ ] 可以查询节点的二维码信息
- [ ] 可以生成新的二维码
- [ ] 可以更新二维码状态
- [ ] 导航功能正常（可以根据二维码定位）
- [ ] 扫码功能正常（可以识别并导航）

---

## 🔧 故障排除

### 问题1: ALTER TABLE 失败

**错误信息：** `Duplicate column name 'qrcode_content'`

**原因：** 字段已存在

**解决方案：** 
```sql
-- 检查字段是否已存在
DESC map_nodes;

-- 如果已存在，跳过添加字段步骤
```

### 问题2: Spring Boot 启动报错

**错误信息：** `Unknown column 'qrcode_content'`

**原因：** 数据库字段未更新，但代码已包含该字段

**解决方案：** 执行 `add_qrcode_to_map_nodes.sql` 脚本

### 问题3: 外键约束错误

**错误信息：** `Cannot add or update a child row: a foreign key constraint fails`

**原因：** locations 表引用的 map_node_id 不存在

**解决方案：**
```sql
-- 检查孤立的外键
SELECT l.*
FROM locations l
LEFT JOIN map_nodes n ON l.map_node_id = n.node_id
WHERE l.map_node_id IS NOT NULL AND n.node_id IS NULL;

-- 修复（将不存在的节点ID设为NULL或创建对应节点）
```

---

## 📞 技术支持

如果遇到问题，请提供以下信息：

1. 数据库版本：`SELECT VERSION();`
2. 表结构：`DESC map_nodes;`
3. 错误日志：Spring Boot启动日志或SQL执行错误信息
4. 数据统计：
   ```sql
   SELECT 
       COUNT(*) as 总节点数,
       COUNT(qrcode_content) as 已生成二维码数,
       COUNT(CASE WHEN qrcode_status='active' THEN 1 END) as 激活数,
       COUNT(CASE WHEN qrcode_status='pending' THEN 1 END) as 待生成数
   FROM map_nodes;
   ```

---

**更新日期**: 2025-11-27  
**数据库**: hospital_system  
**影响的表**: map_nodes, locations






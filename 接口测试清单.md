# 接口测试清单

## 一、挂号接口（AppointmentController）

### 1. 查询类接口
- **GET** `/api/appointments/patient/{patientId}` - 获取患者的所有预约
- **GET** `/api/appointments/doctor/{doctorId}` - 获取指定医生的预约患者列表
- **GET** `/api/appointments/patient/{patientId}/upcoming` - 获取患者即将就诊的预约
- **GET** `/api/appointments/{appointmentId}` - 获取预约详情

### 2. 创建类接口
- **POST** `/api/appointments` - 创建预约（挂号）
- **POST** `/api/appointments/walk-in` - 现场挂号（分诊台辅助患者挂号）

### 3. 更新类接口
- **PUT** `/api/appointments/{appointmentId}` - 更新预约支付状态
- **PUT** `/api/appointments/{appointmentId}/cancel` - 取消预约

### 4. 支付相关接口
- **POST** `/api/appointments/{appointmentId}/pay` - 支付挂号费用

### 5. 签到相关接口
- **GET** `/api/appointments/{appointmentId}/qr-code` - 生成预约二维码Token
- **POST** `/api/appointments/check-in` - 扫码签到
- **DELETE** `/api/appointments/{appointmentId}/check-in` - 清除预约签到时间（管理员功能）

### 6. 测试接口
- **GET** `/api/appointments/test/redis` - 测试Redis连接

---

## 二、叫号接口（AppointmentController）

### 1. 队列查询接口
- **GET** `/api/appointments/schedule/{scheduleId}/call-queue` - 获取叫号队列（已签到但未就诊的预约列表）
- **GET** `/api/appointments/schedule/{scheduleId}/next-to-call` - 获取下一个应该叫号的预约

### 2. 叫号操作接口
- **POST** `/api/appointments/{appointmentId}/call` - 执行叫号
- **POST** `/api/appointments/{appointmentId}/mark-missed` - 标记过号（仅标记，不重新排队）
- **POST** `/api/appointments/{appointmentId}/recheck-in` - 过号后重新签到（序号排到后面）
- **POST** `/api/appointments/{appointmentId}/complete` - 标记就诊完成（医生完成就诊后调用，会自动叫号下一位）

---

## 三、支付/退款接口

### 1. 支付接口（AppointmentController）
- **POST** `/api/appointments/{appointmentId}/pay` - 支付挂号费用

### 2. 退款接口（AdminAppointmentController - 需要管理员权限）
- **POST** `/api/admin/appointments/{appointmentId}/refund` - 退款接口（只有已支付的预约才能退款）

### 3. 候补支付接口（WaitlistController）
- **POST** `/api/waitlist/{waitlistId}/pay` - 支付候补费用（候补转正式预约）

---

## 四、排班相关接口（ScheduleController）

### 1. 查询类接口
- **GET** `/api/schedules` - 获取排班列表（支持departmentId、startDate、endDate参数）
- **GET** `/api/schedules/search` - 查询所有排班记录（支持分页参数：page、size）
- **GET** `/api/schedules/{id}` - 获取单个排班详情
- **GET** `/api/schedules/doctor/{doctorId}` - 根据医生ID获取排班列表（支持startDate、endDate、page、size参数）
- **GET** `/api/schedules/work-hours` - 获取医生工时统计（需要doctorId、可选startDate、endDate）

### 2. 创建类接口
- **POST** `/api/schedules/create` - 创建排班
- **POST** `/api/schedules/auto-generate` - 自动生成排班

### 3. 更新类接口
- **PUT** `/api/schedules/{id}` - 更新单个排班
- **PUT** `/api/schedules/batch-update` - 批量更新排班

### 4. 删除类接口
- **DELETE** `/api/schedules/{id}` - 删除排班
- **DELETE** `/api/schedules/delete` - 根据参数删除排班

### 5. 规则类接口
- **GET** `/api/schedules/auto-generate/rules` - 获取默认排班规则

---

## 五、AI预问诊/推荐接口

### 1. Node.js AI服务接口（ai_pre_triage_backend/server.js）

#### 1.1 症状相关接口
- **GET** `/api/symptoms/popular` - 获取热门症状

#### 1.2 科室推荐接口
- **POST** `/api/pre-triage/recommend-department` - AI智能分诊与科室推荐
  - 请求参数：`patient_id`（可选）、`symptoms`（必填）

#### 1.3 医生推荐接口
- **POST** `/api/pre-triage/recommend-doctor` - 医生智能推荐
  - 请求参数：`department_id`（必填）、`symptoms`（可选）

#### 1.4 健康检查接口
- **GET** `/health` - 健康检查接口

### 2. Spring Boot AI推荐接口（DoctorRecommendationController）

#### 2.1 科室推荐接口
- **POST** `/api/doctor-recommendations/departments` - 科室推荐（第一个流程图）
  - 请求参数：`symptomDescription`（必填）、`patientId`（可选）

#### 2.2 按科室推荐医生接口
- **POST** `/api/doctor-recommendations/by-department` - 按科室推荐医生（带排班信息）
  - 请求参数：`departmentId`（必填）、`patientId`（可选）、`symptomKeywords`（可选）、`topN`（可选，默认10）

#### 2.3 根据症状推荐医生接口
- **POST** `/api/doctor-recommendations` - 根据症状描述推荐医生
  - 请求参数：`symptomDescription`（必填）、`topN`（可选，默认5）

---

## 六、候补排队接口（WaitlistController）

### 1. 查询类接口
- **GET** `/api/waitlist/patient/{patientId}` - 获取患者的所有候补记录
- **GET** `/api/waitlist/{waitlistId}` - 获取候补详情
- **GET** `/api/waitlist/{waitlistId}/position` - 查询排队位置
- **GET** `/api/waitlist/schedule/{scheduleId}` - 根据排班ID获取候补列表（支持status、page、size参数）

### 2. 创建类接口
- **POST** `/api/waitlist` - 创建候补申请

### 3. 更新类接口
- **PUT** `/api/waitlist/{waitlistId}/cancel` - 取消候补

### 4. 支付类接口
- **POST** `/api/waitlist/{waitlistId}/pay` - 支付候补费用（候补转正式预约）

---

## 七、数据库表一致性校验重点

### 1. 订单表（appointments）
- 字段校验：appointment_id、patient_id、schedule_id、status、payment_status、check_in_time、called_at、sequence_number等
- 状态一致性：预约状态与支付状态的一致性
- 号源一致性：排班表的booked_slots与预约记录的一致性

### 2. 排队表（waitlist）
- 字段校验：waitlist_id、patient_id、schedule_id、status、position等
- 位置一致性：排队位置与候补记录的一致性

### 3. 排班表（schedules）
- 字段校验：schedule_id、doctor_id、schedule_date、slot_id、total_slots、booked_slots、status等
- 号源一致性：total_slots >= booked_slots
- 状态一致性：排班状态与预约状态的一致性

---

## 八、测试方法建议

### 1. 灰盒测试（接口 + 数据库）
- 调用接口后，验证数据库记录是否正确更新
- 验证关联表之间的数据一致性

### 2. 接口测试（Postman）
- 使用Postman创建测试集合
- 测试正常流程、异常流程、边界值

### 3. 等价类划分
- 正常值、边界值、异常值
- 有效输入、无效输入

### 4. 边界值分析
- 号源数量边界（0、1、最大值）
- 时间边界（签到时间窗口）
- 金额边界（支付金额）

### 5. 返回结构与字段校验
- 验证返回JSON结构
- 验证必填字段是否存在
- 验证字段类型和格式

### 6. AI黑盒场景测试
- 不同症状描述的推荐准确性
- 空症状、无效症状的处理
- 推荐结果的合理性验证

---

## 九、接口测试优先级

### 高优先级（核心业务流程）
1. 挂号接口：`POST /api/appointments`
2. 支付接口：`POST /api/appointments/{appointmentId}/pay`
3. 签到接口：`POST /api/appointments/check-in`
4. 叫号接口：`POST /api/appointments/{appointmentId}/call`
5. 退款接口：`POST /api/admin/appointments/{appointmentId}/refund`

### 中优先级（重要功能）
1. 现场挂号：`POST /api/appointments/walk-in`
2. 取消预约：`PUT /api/appointments/{appointmentId}/cancel`
3. 过号处理：`POST /api/appointments/{appointmentId}/recheck-in`
4. 排班查询：`GET /api/schedules`
5. AI推荐：`POST /api/pre-triage/recommend-department`

### 低优先级（辅助功能）
1. 候补排队相关接口
2. 排班自动生成接口
3. 医生工时统计接口

---

## 十、注意事项

1. **权限验证**：退款接口需要管理员权限（`@PreAuthorize("hasRole('ADMIN')")`）
2. **时间窗口**：签到接口有时间窗口限制（时段开始前15分钟至结束前10分钟）
3. **状态流转**：注意预约状态、支付状态、签到状态的正确流转
4. **号源管理**：创建预约和取消预约时，需要验证排班表的booked_slots是否正确更新
5. **AI接口降级**：AI推荐接口有降级方案，需要测试降级场景
6. **数据一致性**：重点关注appointments、schedules、waitlist三个表之间的数据一致性



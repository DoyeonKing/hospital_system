# 排班显示过滤已取消状态修复说明

## 问题描述

在批准医生的休假申请并选择"取消排班"后，虽然排班状态被设置为 `cancelled`，但这些已取消的排班仍然显示在管理员端和医生端的排班页面中。

**具体案例**：
- 医生：金丽日
- 请假时间：2025年12月25日 - 12月26日
- 操作：批准请假并选择"取消全部排班"
- 问题：
  - 12月26日上午的排班被删除（无预约记录）
  - 12月25日下午的排班仍然显示（有预约记录，状态为 `cancelled`）

## 问题原因

### 后端逻辑

根据之前的修复，后端在处理"取消排班"时：
- **无预约的排班**：直接删除排班记录
- **有预约的排班**：保留排班记录，状态设置为 `cancelled`（保留预约历史）

这个逻辑是正确的，因为有预约的排班不能直接删除（外键约束）。

### 前端问题

前端在显示排班时，**没有过滤掉 `cancelled` 状态的排班**，导致已取消的排班仍然显示在页面上。

## 修复方案

在管理员端和医生端的排班显示逻辑中，过滤掉所有 `status === 'cancelled'` 的排班记录。

## 修复内容

### 1. 管理员端排班看板

**文件**：`vue_admin/src/views/scheduling/ScheduleDashboard.vue`

#### 修改位置1：月视图（第1203-1207行）

**修改前**：
```javascript
const response = await getSchedules(params);

if (response && response.content) {
  const schedules = response.content;
  const key = activeSub.value;
```

**修改后**：
```javascript
const response = await getSchedules(params);

if (response && response.content) {
  // 过滤掉已取消的排班
  const schedules = response.content.filter(schedule => schedule.status !== 'cancelled');
  const key = activeSub.value;
```

#### 修改位置2：周视图（第2615-2621行）

**修改前**：
```javascript
const response = await getSchedules(params);
console.log('排班数据API响应:', response);

if (response && response.content) {
  // 转换后端数据格式为前端格式
  const schedules = response.content;
```

**修改后**：
```javascript
const response = await getSchedules(params);
console.log('排班数据API响应:', response);

if (response && response.content) {
  // 过滤掉已取消的排班
  const schedules = response.content.filter(schedule => schedule.status !== 'cancelled');
```

### 2. 医生端排班页面

**文件**：`vue/src/views/MySchedule.vue`

**修改位置**：第555-574行

**修改前**：
```javascript
// 处理返回的数据
if (response && response.content) {
  schedules.value = response.content.map(schedule => ({
    scheduleId: schedule.scheduleId,
    doctorId: schedule.doctorId,
    // ... 其他字段
  }))
```

**修改后**：
```javascript
// 处理返回的数据，过滤掉已取消的排班
if (response && response.content) {
  schedules.value = response.content
    .filter(schedule => schedule.status !== 'cancelled')
    .map(schedule => ({
      scheduleId: schedule.scheduleId,
      doctorId: schedule.doctorId,
      // ... 其他字段
    }))
```

## 测试步骤

### 1. 重启前端服务

修改代码后需要重启前端服务：

**管理员端**：
```bash
cd vue_admin
npm run dev
```

**医生端**：
```bash
cd vue
npm run dev
```

### 2. 测试管理员端

1. 登录管理员账号
2. 进入"排班管理"页面
3. 切换到"内科-神经科"（金丽日所在科室）
4. 查看12月25日和12月26日的排班
5. **预期结果**：
   - 12月26日上午：金丽日的排班不显示（已删除）
   - 12月25日下午：金丽日的排班不显示（状态为 `cancelled`，被过滤）

### 3. 测试医生端

1. 登录金丽日的账号
2. 进入"我的排班"页面
3. 查看12月25日和12月26日的排班
4. **预期结果**：
   - 12月25日下午和12月26日上午的排班都不显示

### 4. 验证数据库

可以通过SQL查询验证数据库中的实际情况：

```sql
-- 查看金丽日的排班记录
SELECT schedule_id, schedule_date, slot_id, status, booked_slots
FROM schedules
WHERE doctor_id = (SELECT doctor_id FROM doctors WHERE full_name = '金丽日')
  AND schedule_date BETWEEN '2025-12-25' AND '2025-12-26'
ORDER BY schedule_date, slot_id;
```

**预期结果**：
- 12月26日上午的排班：不存在（已删除）
- 12月25日下午的排班：存在，但 `status = 'cancelled'`（有预约记录）

## 技术说明

### 为什么不在后端过滤

虽然可以在后端API中过滤掉 `cancelled` 状态的排班，但前端过滤有以下优势：

1. **灵活性**：前端可以根据不同场景决定是否显示已取消的排班
2. **数据完整性**：后端返回完整数据，前端可以根据需要进行不同的展示
3. **调试方便**：开发时可以临时注释过滤逻辑，查看所有排班（包括已取消的）

### 过滤逻辑

```javascript
.filter(schedule => schedule.status !== 'cancelled')
```

这个过滤条件会排除所有状态为 `'cancelled'` 的排班记录。

### 状态值说明

排班状态（`ScheduleStatus`）的可能值：
- `available`：可预约
- `full`：已满
- `cancelled`：已取消

## 后续优化建议

### 1. 添加"显示已取消排班"选项

在管理员端添加一个开关，允许管理员查看已取消的排班（用于审计和历史记录）：

```javascript
const showCancelled = ref(false);

const filteredSchedules = computed(() => {
  let schedules = response.content;
  if (!showCancelled.value) {
    schedules = schedules.filter(schedule => schedule.status !== 'cancelled');
  }
  return schedules;
});
```

### 2. 已取消排班的视觉提示

如果选择显示已取消的排班，应该用特殊样式标记：

```css
.schedule-cancelled {
  opacity: 0.5;
  text-decoration: line-through;
  background-color: #f5f5f5;
}
```

### 3. 定期清理已取消的排班

创建定时任务，定期清理已取消且预约已处理完毕的排班记录：

```java
@Scheduled(cron = "0 0 3 * * ?")  // 每天凌晨3点执行
public void cleanupOldCancelledSchedules() {
    // 查找已取消且所有预约都已完成/取消的排班
    // 删除这些排班记录
}
```

## 相关文件

### 前端文件
- `vue_admin/src/views/scheduling/ScheduleDashboard.vue` - 管理员端排班看板（已修改）
- `vue/src/views/MySchedule.vue` - 医生端排班页面（已修改）

### 后端文件
- `springboot/src/main/java/com/example/springboot/service/LeaveRequestService.java` - 请假申请服务（之前已修改）
- `springboot/src/main/java/com/example/springboot/entity/enums/ScheduleStatus.java` - 排班状态枚举

## 修复日期

2024年12月24日

## 修复效果

修复后，管理员端和医生端的排班页面将不再显示已取消的排班，用户体验更加清晰。同时，数据库中仍然保留有预约记录的已取消排班，确保数据完整性和可追溯性。

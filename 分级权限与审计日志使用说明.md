# åˆ†çº§æƒé™ä¸å®¡è®¡æ—¥å¿—åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## ğŸ“š ç›®å½•
- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [å·²å®ç°çš„åŠŸèƒ½](#å·²å®ç°çš„åŠŸèƒ½)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
- [å‰ç«¯é¡µé¢è¯´æ˜](#å‰ç«¯é¡µé¢è¯´æ˜)
- [ç¤ºä¾‹ä»£ç ](#ç¤ºä¾‹ä»£ç )

---

## åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡å¼€å‘å®Œæˆäº†åŒ»é™¢ç³»ç»Ÿçš„**åˆ†çº§æƒé™ç®¡ç†**å’Œ**å®¡è®¡æ—¥å¿—**åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

### 1. åˆ†çº§æƒé™ç®¡ç†
- âœ… åŸºäºRBACï¼ˆè§’è‰²-æƒé™ï¼‰æ¨¡å‹
- âœ… æ”¯æŒè§’è‰²å’Œæƒé™çš„CRUDæ“ä½œ
- âœ… ä½¿ç”¨Spring Securityè¿›è¡Œæƒé™éªŒè¯
- âœ… å‰ç«¯æƒé™ç®¡ç†ç•Œé¢

### 2. å®¡è®¡æ—¥å¿—
- âœ… è‡ªåŠ¨è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
- âœ… æ”¯æŒå¤šæ¡ä»¶æŸ¥è¯¢å’Œåˆ†é¡µ
- âœ… æä¾›ç»Ÿè®¡åˆ†æåŠŸèƒ½
- âœ… å‰ç«¯æ—¥å¿—æŸ¥çœ‹å’Œå¯¼å‡ºç•Œé¢

---

## å·²å®ç°çš„åŠŸèƒ½

### åç«¯ï¼ˆSpringBootï¼‰

#### 1. æ³¨è§£å’ŒAOP
- **`@AuditLog`** - è‡ªå®šä¹‰æ³¨è§£ï¼Œæ ‡è®°éœ€è¦è®°å½•å®¡è®¡æ—¥å¿—çš„æ–¹æ³•
- **`AuditLogAspect`** - AOPåˆ‡é¢ï¼Œè‡ªåŠ¨æ‹¦æˆªå¹¶è®°å½•æ“ä½œæ—¥å¿—

#### 2. Controllerå±‚
- **`AuditLogController`** - å®¡è®¡æ—¥å¿—æŸ¥è¯¢æ¥å£
  - è·å–æ‰€æœ‰æ—¥å¿—
  - æŒ‰æ“ä½œè€…æŸ¥è¯¢
  - æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
  - æŒ‰ç›®æ ‡å®ä½“æŸ¥è¯¢
  - é«˜çº§ç»„åˆæŸ¥è¯¢ï¼ˆåˆ†é¡µï¼‰
  - ç»Ÿè®¡åˆ†æ

- **`PermissionController`** - æƒé™ç®¡ç†æ¥å£
  - æƒé™çš„CRUDæ“ä½œ
  - æŸ¥è¯¢æƒé™åˆ†é…æƒ…å†µ

#### 3. Serviceå±‚
- **`AuditLogService`** - å¢å¼ºç‰ˆï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢å’Œåˆ†é¡µ
- **`PermissionService`** - å·²æœ‰ï¼Œæœªä¿®æ”¹

#### 4. DTO
- **`AuditLogQueryRequest`** - å®¡è®¡æ—¥å¿—æŸ¥è¯¢è¯·æ±‚DTO

### å‰ç«¯ï¼ˆVue3 + Element Plusï¼‰

#### 1. å®¡è®¡æ—¥å¿—æŸ¥çœ‹é¡µé¢
- æ–‡ä»¶ä½ç½®: `vue_admin/src/views/AuditLog.vue`
- åŠŸèƒ½ï¼š
  - å¤šæ¡ä»¶æŸ¥è¯¢ï¼ˆæ“ä½œè€…ã€ç±»å‹ã€æ—¶é—´èŒƒå›´ç­‰ï¼‰
  - åˆ†é¡µæ˜¾ç¤º
  - è¯¦æƒ…æŸ¥çœ‹
  - ç»Ÿè®¡æ•°æ®å±•ç¤º
  - å¯¼å‡ºåŠŸèƒ½ï¼ˆå¾…å®ç°ï¼‰

#### 2. æƒé™ç®¡ç†é¡µé¢
- æ–‡ä»¶ä½ç½®: `vue_admin/src/views/PermissionManage.vue`
- åŠŸèƒ½ï¼š
  - æƒé™åˆ—è¡¨å±•ç¤º
  - æ–°å¢æƒé™
  - ç¼–è¾‘æƒé™
  - åˆ é™¤æƒé™

---

## ä½¿ç”¨æŒ‡å—

### 1. å¦‚ä½•ä½¿ç”¨@AuditLogæ³¨è§£

åœ¨ä»»ä½•éœ€è¦è®°å½•å®¡è®¡æ—¥å¿—çš„Controlleræ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ï¼š

```java
@PostMapping
@AuditLog(
    action = "åˆ›å»ºæ–°åŒ»ç”Ÿ",
    targetEntity = "doctors",
    recordDetails = true
)
public ResponseEntity<?> createDoctor(@RequestBody DoctorCreateRequest request) {
    // ä¸šåŠ¡é€»è¾‘
}
```

**æ³¨è§£å‚æ•°è¯´æ˜ï¼š**
- `action` - æ“ä½œæè¿°ï¼ˆå¦‚ï¼š"åˆ›å»ºæ–°åŒ»ç”Ÿ"ã€"ä¿®æ”¹æ‚£è€…ä¿¡æ¯"ï¼‰
- `targetEntity` - ç›®æ ‡å®ä½“è¡¨åï¼ˆå¦‚ï¼š"doctors"ã€"patients"ï¼‰
- `recordDetails` - æ˜¯å¦è®°å½•è¯¦ç»†ä¿¡æ¯ï¼ˆé»˜è®¤trueï¼‰

### 2. æƒé™é…ç½®

#### åœ¨Controllerä¸Šé…ç½®æƒé™è¦æ±‚ï¼š

```java
@RestController
@RequestMapping("/api/doctors")
@PreAuthorize("hasAuthority('doctor_manage')") // éœ€è¦åŒ»ç”Ÿç®¡ç†æƒé™
public class DoctorController {
    // ...
}
```

#### åœ¨æ–¹æ³•çº§åˆ«é…ç½®æƒé™ï¼š

```java
@DeleteMapping("/{id}")
@PreAuthorize("hasAuthority('doctor_manage') and hasRole('ADMIN')")
@AuditLog(action = "åˆ é™¤åŒ»ç”Ÿ", targetEntity = "doctors")
public ResponseEntity<?> deleteDoctor(@PathVariable Integer id) {
    // ...
}
```

### 3. å‰ç«¯è®¿é—®

#### è®¿é—®å®¡è®¡æ—¥å¿—é¡µé¢ï¼š
```
http://localhost:5173/audit-logs
```

#### è®¿é—®æƒé™ç®¡ç†é¡µé¢ï¼š
```
http://localhost:5173/permission-manage
```

---

## APIæ¥å£æ–‡æ¡£

### å®¡è®¡æ—¥å¿—æ¥å£

#### 1. è·å–æ‰€æœ‰å®¡è®¡æ—¥å¿—
```http
GET /api/audit-logs/all
Authorization: Bearer {token}
```

#### 2. æŒ‰æ“ä½œè€…æŸ¥è¯¢
```http
GET /api/audit-logs/actor?actorType=admin&actorId=1
Authorization: Bearer {token}
```

#### 3. æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
```http
GET /api/audit-logs/time-range?start=2024-01-01T00:00:00&end=2024-12-31T23:59:59
Authorization: Bearer {token}
```

#### 4. é«˜çº§æŸ¥è¯¢ï¼ˆæ¨èï¼‰
```http
POST /api/audit-logs/search
Authorization: Bearer {token}
Content-Type: application/json

{
  "actorId": 1,
  "actorType": "admin",
  "action": "åˆ›å»º",
  "targetEntity": "doctors",
  "startTime": "2024-01-01T00:00:00",
  "endTime": "2024-12-31T23:59:59",
  "page": 0,
  "size": 20,
  "sortBy": "createdAt",
  "sortDirection": "DESC"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": "200",
  "msg": "success",
  "data": {
    "content": [
      {
        "logId": 1,
        "actorId": 1,
        "actorType": "admin",
        "action": "åˆ›å»ºæ–°åŒ»ç”Ÿ",
        "targetEntity": "doctors",
        "targetId": 10,
        "details": "{\"requestMethod\":\"POST\",\"status\":\"SUCCESS\"}",
        "createdAt": "2024-12-23T10:30:00"
      }
    ],
    "totalElements": 100,
    "totalPages": 5,
    "currentPage": 0,
    "pageSize": 20,
    "hasNext": true,
    "hasPrevious": false
  }
}
```

#### 5. è·å–ç»Ÿè®¡ä¿¡æ¯
```http
GET /api/audit-logs/statistics?start=2024-12-01T00:00:00&end=2024-12-31T23:59:59
Authorization: Bearer {token}
```

### æƒé™ç®¡ç†æ¥å£

#### 1. è·å–æ‰€æœ‰æƒé™
```http
GET /api/permissions/list
Authorization: Bearer {token}
```

#### 2. åˆ›å»ºæ–°æƒé™
```http
POST /api/permissions
Authorization: Bearer {token}
Content-Type: application/json

{
  "permissionName": "user_manage",
  "description": "ç”¨æˆ·ç®¡ç†æƒé™"
}
```

#### 3. æ›´æ–°æƒé™
```http
PUT /api/permissions/{id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "permissionName": "user_manage",
  "description": "ç”¨æˆ·ç®¡ç†æƒé™ï¼ˆå·²æ›´æ–°ï¼‰"
}
```

#### 4. åˆ é™¤æƒé™
```http
DELETE /api/permissions/{id}
Authorization: Bearer {token}
```

---

## å‰ç«¯é¡µé¢è¯´æ˜

### å®¡è®¡æ—¥å¿—é¡µé¢åŠŸèƒ½

1. **æŸ¥è¯¢è¿‡æ»¤**
   - æŒ‰æ“ä½œè€…IDç­›é€‰
   - æŒ‰æ“ä½œè€…ç±»å‹ç­›é€‰ï¼ˆç®¡ç†å‘˜/åŒ»ç”Ÿ/æ‚£è€…ï¼‰
   - æŒ‰æ“ä½œè¡Œä¸ºæ¨¡ç³Šæœç´¢
   - æŒ‰ç›®æ ‡å®ä½“ç­›é€‰
   - æŒ‰æ—¶é—´èŒƒå›´ç­›é€‰

2. **æ•°æ®å±•ç¤º**
   - è¡¨æ ¼å±•ç¤ºæ‰€æœ‰æ—¥å¿—
   - æ”¯æŒåˆ†é¡µï¼ˆ10/20/50/100æ¡ï¼‰
   - å½©è‰²æ ‡ç­¾åŒºåˆ†æ“ä½œè€…ç±»å‹

3. **è¯¦æƒ…æŸ¥çœ‹**
   - ç‚¹å‡»"è¯¦æƒ…"æŒ‰é’®æŸ¥çœ‹å®Œæ•´ä¿¡æ¯
   - JSONæ ¼å¼åŒ–æ˜¾ç¤ºè¯¦ç»†æ•°æ®

4. **ç»Ÿè®¡çœ‹æ¿**
   - æ€»è®°å½•æ•°
   - ä»Šæ—¥æ“ä½œæ•°
   - æœ¬å‘¨æ“ä½œæ•°
   - æœ¬æœˆæ“ä½œæ•°

### æƒé™ç®¡ç†é¡µé¢åŠŸèƒ½

1. **æƒé™åˆ—è¡¨**
   - æ˜¾ç¤ºæ‰€æœ‰æƒé™åŠæè¿°
   - æƒé™IDã€åç§°ã€æè¿°

2. **æ–°å¢æƒé™**
   - å¡«å†™æƒé™åç§°ï¼ˆè‹±æ–‡ï¼Œå¦‚ï¼šuser_manageï¼‰
   - å¡«å†™æƒé™æè¿°

3. **ç¼–è¾‘æƒé™**
   - ä¿®æ”¹æƒé™æè¿°
   - æƒé™åç§°ä¸å¯ä¿®æ”¹

4. **åˆ é™¤æƒé™**
   - ç¡®è®¤ååˆ é™¤
   - æ³¨æ„ï¼šå·²åˆ†é…ç»™è§’è‰²çš„æƒé™éœ€è°¨æ…åˆ é™¤

---

## ç¤ºä¾‹ä»£ç 

### ç¤ºä¾‹1ï¼šä¸ºç°æœ‰Controlleræ·»åŠ å®¡è®¡æ—¥å¿—

```java
@RestController
@RequestMapping("/api/doctors")
public class DoctorController {
    
    @PostMapping
    @AuditLog(action = "åˆ›å»ºåŒ»ç”Ÿ", targetEntity = "doctors")
    public ResponseEntity<?> createDoctor(@RequestBody DoctorCreateRequest request) {
        // ä¸šåŠ¡é€»è¾‘
        Doctor doctor = doctorService.createDoctor(request);
        return ResponseEntity.ok(doctor);
    }
    
    @PutMapping("/{id}")
    @AuditLog(action = "æ›´æ–°åŒ»ç”Ÿä¿¡æ¯", targetEntity = "doctors")
    public ResponseEntity<?> updateDoctor(
            @PathVariable Integer id,
            @RequestBody DoctorUpdateRequest request) {
        // ä¸šåŠ¡é€»è¾‘
        Doctor doctor = doctorService.updateDoctor(id, request);
        return ResponseEntity.ok(doctor);
    }
    
    @DeleteMapping("/{id}")
    @AuditLog(action = "åˆ é™¤åŒ»ç”Ÿ", targetEntity = "doctors")
    @PreAuthorize("hasAuthority('doctor_manage') and hasRole('SUPER_ADMIN')")
    public ResponseEntity<?> deleteDoctor(@PathVariable Integer id) {
        // ä¸šåŠ¡é€»è¾‘
        doctorService.deleteDoctor(id);
        return ResponseEntity.ok("åˆ é™¤æˆåŠŸ");
    }
}
```

### ç¤ºä¾‹2ï¼šå‰ç«¯è°ƒç”¨å®¡è®¡æ—¥å¿—API

```javascript
import request from '@/utils/request'

// æŸ¥è¯¢å®¡è®¡æ—¥å¿—
const fetchAuditLogs = async () => {
  try {
    const response = await request.post('/api/audit-logs/search', {
      actorType: 'admin',
      startTime: '2024-12-01T00:00:00',
      endTime: '2024-12-31T23:59:59',
      page: 0,
      size: 20
    })
    
    if (response.code === '200') {
      console.log('æ—¥å¿—åˆ—è¡¨:', response.data.content)
      console.log('æ€»æ¡æ•°:', response.data.totalElements)
    }
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error)
  }
}
```

### ç¤ºä¾‹3ï¼šç¨‹åºåŒ–è®°å½•å®¡è®¡æ—¥å¿—

å¦‚æœæŸäº›æ“ä½œä¸åœ¨Controllerä¸­ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨Serviceè®°å½•ï¼š

```java
@Service
public class SomeService {
    
    @Autowired
    private AuditLogService auditLogService;
    
    public void performSomeAction() {
        // ä¸šåŠ¡é€»è¾‘
        // ...
        
        // æ‰‹åŠ¨è®°å½•å®¡è®¡æ—¥å¿—
        auditLogService.createAuditLog(
            1,                          // æ“ä½œè€…ID
            ActorType.admin,            // æ“ä½œè€…ç±»å‹
            "æ‰§è¡Œæ‰¹é‡å¯¼å…¥",              // æ“ä½œæè¿°
            "patients",                 // ç›®æ ‡å®ä½“
            null,                       // ç›®æ ‡IDï¼ˆæ‰¹é‡æ“ä½œå¯ä¸ºnullï¼‰
            "{\"count\": 100}"          // è¯¦ç»†ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰
        );
    }
}
```

---

## æƒé™åˆ—è¡¨å‚è€ƒ

ç³»ç»Ÿä¸­å·²é¢„ç½®çš„æƒé™ï¼š

| æƒé™ID | æƒé™åç§° | æƒé™æè¿° |
|--------|---------|---------|
| 1 | user_manage | ç”¨æˆ·ç®¡ç†æƒé™ |
| 2 | doctor_manage | åŒ»ç”Ÿç®¡ç†æƒé™ |
| 3 | patient_manage | æ‚£è€…ç®¡ç†æƒé™ |
| 4 | schedule_manage | æ’ç­ç®¡ç†æƒé™ |
| 5 | appointment_manage | é¢„çº¦ç®¡ç†æƒé™ |
| 6 | financial_manage | è´¢åŠ¡ç®¡ç†æƒé™ |
| 7 | medical_guide_manage | å°±åŒ»è§„èŒƒç®¡ç†æƒé™ |
| 8 | system_config | ç³»ç»Ÿé…ç½®æƒé™ |
| 9 | audit_log_view | å®¡è®¡æ—¥å¿—æŸ¥çœ‹æƒé™ |
| 10 | report_generate | æŠ¥è¡¨ç”Ÿæˆæƒé™ |

---

## è§’è‰²ä¸æƒé™æ˜ å°„å‚è€ƒ

| è§’è‰² | æ‹¥æœ‰çš„æƒé™ |
|------|-----------|
| super_adminï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰ | å…¨éƒ¨æƒé™ |
| medical_adminï¼ˆåŒ»åŠ¡ç®¡ç†å‘˜ï¼‰ | doctor_manage, schedule_manage, appointment_manage, audit_log_view |
| financial_adminï¼ˆè´¢åŠ¡ç®¡ç†å‘˜ï¼‰ | financial_manage, report_generate |
| patient_adminï¼ˆæ‚£è€…ç®¡ç†å‘˜ï¼‰ | patient_manage, appointment_manage, audit_log_view |
| system_operatorï¼ˆç³»ç»Ÿæ“ä½œå‘˜ï¼‰ | schedule_manage, appointment_manage, audit_log_view |

---

## æ³¨æ„äº‹é¡¹

1. **æƒé™éªŒè¯**
   - å®¡è®¡æ—¥å¿—æŸ¥çœ‹éœ€è¦ `audit_log_view` æƒé™
   - æƒé™ç®¡ç†éœ€è¦ `system_config` æƒé™
   - ç¡®ä¿ç®¡ç†å‘˜è´¦å·å·²åˆ†é…ç›¸åº”æƒé™

2. **æ€§èƒ½è€ƒè™‘**
   - å®¡è®¡æ—¥å¿—å¼‚æ­¥è®°å½•ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½
   - å»ºè®®å®šæœŸæ¸…ç†è¿‡æœŸæ—¥å¿—ï¼ˆå¯è®¾ç½®æ•°æ®ä¿ç•™ç­–ç•¥ï¼‰

3. **å®‰å…¨å»ºè®®**
   - å®¡è®¡æ—¥å¿—ä¸å¯åˆ é™¤æˆ–ä¿®æ”¹
   - æ•æ„Ÿæ“ä½œåŠ¡å¿…æ·»åŠ  `@AuditLog` æ³¨è§£
   - å®šæœŸå®¡æŸ¥å®¡è®¡æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸æ“ä½œ

4. **æ‰©å±•å»ºè®®**
   - å¯ä»¥æ·»åŠ æ—¥å¿—å¯¼å‡ºä¸ºExcelåŠŸèƒ½
   - å¯ä»¥æ·»åŠ å®æ—¶æ—¥å¿—ç›‘æ§å’Œå‘Šè­¦
   - å¯ä»¥é›†æˆåˆ°æ•°æ®å¤§å±å±•ç¤º

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. åç«¯æ—¥å¿—ï¼š`System.err` ä¸­çš„å®¡è®¡æ—¥å¿—ç›¸å…³é”™è¯¯
2. å‰ç«¯æ§åˆ¶å°ï¼šNetworké¢æ¿æŸ¥çœ‹APIè°ƒç”¨æƒ…å†µ
3. æ•°æ®åº“ï¼šæ£€æŸ¥ `audit_logs` è¡¨æ˜¯å¦æ­£å¸¸è®°å½•

---

**å¼€å‘å®Œæˆæ—¥æœŸï¼š** 2024å¹´12æœˆ23æ—¥  
**ç‰ˆæœ¬ï¼š** v1.0.0
















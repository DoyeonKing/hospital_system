# 休假申请排班删除问题修复说明

## 问题描述

在批准医生的休假申请并选择"取消全部排班"后，部分排班记录仍然显示在排班看板中，没有被删除。

**具体案例**：
- 医生：金丽日
- 请假时间：2025年12月25日 - 12月26日
- 操作：批准请假并选择"取消全部排班"
- 问题：12月25日下午的排班依旧存在

## 问题原因

### 根本原因

系统在处理"取消排班"时，只是将排班状态改为 `cancelled`，**并没有真正删除排班记录**。

### 代码分析

**位置1：批准请假时**（`LeaveRequestService.java:189-192`）
```java
if (request.getStatus() == LeaveRequestStatus.APPROVED) {
    // 如果申请被批准，需要更新相关排班的状态
    updateAffectedSchedules(existingRequest.getDoctor(), 
                           existingRequest.getStartTime(), 
                           existingRequest.getEndTime(), 
                           ScheduleStatus.cancelled);
}
```

**位置2：更新受影响排班的方法**（`LeaveRequestService.java:251-270`）
```java
private void updateAffectedSchedules(Doctor doctor, LocalDateTime startTime, 
                                    LocalDateTime endTime, ScheduleStatus newStatus) {
    // ...
    for (Schedule schedule : affectedSchedules) {
        if (overlaps) {
            schedule.setStatus(newStatus);  // ❌ 只改状态
            scheduleRepository.save(schedule);  // ❌ 保存而不是删除
        }
    }
}
```

**位置3：确认替班时**（`LeaveRequestService.java:512-559`，修复前）
```java
if (substituteDoctorId == null) {
    // 取消排班
    schedule.setStatus(ScheduleStatus.cancelled);  // ❌ 只改状态
    scheduleRepository.save(schedule);  // ❌ 保存而不是删除
}
```

### 为什么排班还显示

1. 排班记录仍然存在于数据库中，只是状态变成了 `cancelled`
2. 排班看板可能没有过滤掉 `cancelled` 状态的排班
3. 即使过滤了，数据库中仍然有大量无用的已取消排班记录

## 修复方案

### 修复内容

修改 `confirmSubstitution` 方法，当选择"取消排班"时：
- **如果排班没有预约记录**：直接删除排班记录
- **如果排班有预约记录**：保留排班并标记为 `cancelled` 状态（因为需要保留预约历史）

### 修复代码

**文件**：`springboot/src/main/java/com/example/springboot/service/LeaveRequestService.java`

**修改位置**：第512-559行

**修改后的逻辑**：
```java
if (substituteDoctorId == null) {
    // 取消排班
    Doctor originalDoctor = schedule.getDoctor();
    
    // 检查是否有预约记录
    if (appointments.isEmpty()) {
        // ✅ 没有预约记录，直接删除排班
        logger.info("排班 #{} 没有预约记录，直接删除", scheduleId);
        scheduleRepository.delete(schedule);
        cancelledCount++;
        messages.add("排班 #" + scheduleId + " 已删除（无预约记录）");
        logger.info("排班 #{} 删除完成", scheduleId);
    } else {
        // ✅ 有预约记录，只能标记为取消状态
        logger.info("排班 #{} 有 {} 个预约记录，标记为取消状态", scheduleId, appointments.size());
        schedule.setStatus(ScheduleStatus.cancelled);
        scheduleRepository.save(schedule);
        
        // 发送通知给所有患者
        // ...
    }
}
```

## 测试步骤

### 1. 重启后端服务

修改代码后需要重启后端服务才能生效：

```bash
cd springboot
mvn spring-boot:run
```

### 2. 测试场景1：无预约的排班

1. 创建一个医生的排班（确保没有患者预约）
2. 提交该医生的请假申请
3. 批准请假申请，进入替班选择页面
4. 选择"取消该排班"
5. 确认替班安排
6. **预期结果**：排班记录被完全删除，不再显示在排班看板中

### 3. 测试场景2：有预约的排班

1. 创建一个医生的排班
2. 让患者预约该排班
3. 提交该医生的请假申请
4. 批准请假申请，进入替班选择页面
5. 选择"取消该排班"
6. 确认替班安排
7. **预期结果**：
   - 排班状态变为 `cancelled`
   - 排班记录保留（因为有预约历史）
   - 患者收到排班取消通知

### 4. 验证修复

批准金丽日12月25-26日的新请假申请：
1. 进入请假审批页面
2. 批准请假申请
3. 在替班选择页面，对所有受影响的排班选择"取消该排班"
4. 确认替班安排
5. 返回排班看板
6. **验证**：12月25日和26日的排班应该已经被删除（如果没有预约）

## 技术说明

### 为什么不能直接删除有预约的排班

1. **数据完整性**：预约记录（`appointments` 表）通过外键关联到排班记录（`schedules` 表）
2. **历史追溯**：需要保留预约历史，方便查询和统计
3. **退款记录**：如果涉及退款，需要保留原始排班信息

### 删除排班的条件

只有满足以下条件才能删除排班：
- ✅ 排班没有任何预约记录
- ✅ 排班状态为 `cancelled`（或即将被取消）

### 日志输出

修复后的代码会输出详细的日志，方便调试：

```
排班 #123 有 0 个预约
排班 #123 没有预约记录，直接删除
排班 #123 删除完成
```

或

```
排班 #456 有 3 个预约
排班 #456 有 3 个预约记录，标记为取消状态
排班 #456 已取消，开始发送通知给 3 位患者
成功发送取消通知给患者 #789
排班 #456 取消完成，成功通知 3/3 位患者
```

## 后续优化建议

### 1. 前端过滤已取消的排班

在排班看板中过滤掉 `cancelled` 状态的排班，避免显示已取消的排班：

```javascript
// 过滤掉已取消的排班
schedules = schedules.filter(s => s.status !== 'cancelled');
```

### 2. 定期清理已取消的排班

创建定时任务，定期清理已取消且无预约的排班记录：

```java
@Scheduled(cron = "0 0 2 * * ?")  // 每天凌晨2点执行
public void cleanupCancelledSchedules() {
    // 查找已取消且无预约的排班
    // 删除这些排班记录
}
```

### 3. 批量删除功能

在管理员界面添加批量删除已取消排班的功能，方便手动清理。

## 相关文件

### 后端文件
- `springboot/src/main/java/com/example/springboot/service/LeaveRequestService.java` - 请假申请服务（已修改）
- `springboot/src/main/java/com/example/springboot/repository/ScheduleRepository.java` - 排班数据访问层
- `springboot/src/main/java/com/example/springboot/entity/Schedule.java` - 排班实体

### 前端文件
- `vue_admin/src/views/SubstituteSelection.vue` - 替班选择页面
- `vue_admin/src/views/scheduling/ScheduleDashboard.vue` - 排班看板
- `vue_admin/src/views/LeaveApproval.vue` - 请假审批页面

## 修复日期

2024年12月24日

## 修复人员

AI Assistant

# 小程序功能测试清单

## 一、已实现的核心功能 ✅

### 1. 预约挂号
- **接口**：`POST /api/appointments`
- **状态**：✅ 已实现
- **功能**：患者选择排班创建预约

### 2. 生成二维码
- **接口**：`GET /api/appointments/{appointmentId}/qr-code`
- **状态**：✅ 已实现
- **功能**：生成签到二维码Token

### 3. 扫码签到
- **接口**：`POST /api/appointments/check-in`
- **状态**：✅ 已实现
- **签到时间窗口**：✅ 已更新为 **时段开始前30分钟至结束前10分钟**
- **功能**：
  - 二维码验证
  - 时间窗口检查
  - 迟到判断
  - 跨场作废
  - 分配实时候诊序号

### 4. 查询叫号队列
- **接口**：`GET /api/appointments/schedule/{scheduleId}/call-queue`
- **状态**：✅ 已实现
- **功能**：查看当前排队情况

### 5. 过号重新签到
- **接口**：`POST /api/appointments/{appointmentId}/recheck-in`
- **状态**：✅ 已实现
- **功能**：过号后重新扫码，排当前时段队尾

### 6. 支付挂号费
- **接口**：`POST /api/appointments/{appointmentId}/pay`
- **状态**：✅ 已实现
- **功能**：在线支付挂号费

## 二、排队规则实现状态 ✅

### ✅ 已实现的规则
1. ✅ **预约优先**：预约挂号优先于现场挂号
2. ✅ **先签到先就诊**：
   - 提前签到（时段开始前）：按挂号序号排序
   - 时段内签到：按签到时间排序
3. ✅ **签到时间窗口**：时段开始前30分钟至结束前10分钟
4. ✅ **迟到降档**：
   - 跨场：直接作废
   - 未跨场但迟到：排队尾
5. ✅ **过号重排**：重新扫码后排当前时段队尾
6. ✅ **复诊号插入**：每两位正常患者后插入一个（同医生）
7. ✅ **加号排序**：排在所有正常号最后

## 三、可以测试的功能

### ✅ 核心流程（可测试）
1. **预约挂号流程**
   - 创建预约 → 生成二维码 → 扫码签到 → 查看队列

2. **签到流程**
   - 时段开始前30分钟：可以开始签到
   - 时段内签到：按签到时间排序
   - 时段结束前10分钟之后：迟到签到，排末尾
   - 时段结束后：不能签到

3. **过号流程**
   - 医生叫号 → 患者未到 → 重新扫码 → 排队尾

4. **队列查看**
   - 查看当前排队情况
   - 验证排序规则是否正确

## 四、测试前准备

### 1. 数据库准备
- ✅ 执行 `4_add_appointment_queue_fields.sql`（添加排队字段）
- ✅ 执行 `5_add_appointment_type_fields.sql`（添加预约类型字段）
- ✅ 确保 `appointments` 表包含所有必要字段

### 2. 测试数据准备
- 创建测试排班（时段：8:00-8:30）
- 创建测试患者
- 创建测试预约

### 3. 测试场景

#### 场景1：提前签到测试
- 创建预约（时段8:00-8:30）
- 7:30之前签到：应该提示"签到时间未到"
- 7:30-8:20签到：正常签到，按挂号序号排序
- 8:20-8:30签到：迟到签到，排末尾
- 8:30之后签到：应该提示"时段已结束"

#### 场景2：时段内签到测试
- 创建多个预约（1号、2号、3号）
- 时段开始后按不同时间签到
- 验证：先签到的排在前面

#### 场景3：过号重排测试
- 患者签到后医生叫号
- 患者未到诊室
- 重新扫码签到
- 验证：排在当前时段队尾

#### 场景4：队列排序测试
- 创建不同类型的预约（预约、现场、复诊、加号）
- 验证排序是否正确

## 五、注意事项

### ⚠️ 未实现的功能（不影响核心测试）
1. ❌ 加号创建接口（医生端）
2. ❌ 复诊号创建接口（分诊台端）
3. ❌ 现场挂号接口（患者端）

### ✅ 可以测试的功能
- ✅ 预约挂号
- ✅ 扫码签到
- ✅ 查看队列
- ✅ 过号重排
- ✅ 支付功能

## 六、测试建议

### 第一步：基础功能测试
1. 创建预约
2. 生成二维码
3. 扫码签到
4. 查看队列

### 第二步：时间窗口测试
1. 测试提前签到（时段开始前30分钟）
2. 测试按时签到（时段内）
3. 测试迟到签到（时段结束前10分钟之后）
4. 测试时段结束后签到（应该失败）

### 第三步：排序规则测试
1. 创建多个预约，验证排序
2. 测试提前签到 vs 时段内签到
3. 测试预约 vs 现场挂号（如果有）

### 第四步：过号测试
1. 医生叫号
2. 患者重新扫码
3. 验证排队位置

## 总结

**小程序核心功能已实现，可以进行测试！**

主要功能：
- ✅ 预约挂号
- ✅ 扫码签到（时间窗口已更新）
- ✅ 查看队列
- ✅ 过号重排
- ✅ 支付功能

排队规则：
- ✅ 所有核心规则已实现

可以开始测试了！



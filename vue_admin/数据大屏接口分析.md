# 数据大屏接口需求分析

## 一、数据大屏需要的数据

根据 `StatsCanvas.vue` 中的 mockData，数据大屏需要以下三类数据：

### 1. 运营总览 (Overview)
- **今日挂号量** (todayAppointments)
- **今日出诊医生数** (activeDoctorsToday)
- **当前候诊人数** (pendingPatients)
- **累计注册用户** (totalPatients)
- **近7天挂号趋势** (last7DaysDates, last7DaysCounts)
- **支付状态分布** (paymentStatus: 已支付/待支付/退款)

### 2. 医生资源分析 (Doctors)
- **医生总数** (totalDoctors)
- **今日请假人数** (todayLeaveCount)
- **科室总数** (totalDepartments)
- **职称分布** (titleDistribution)
- **科室繁忙度 Top 5** (departmentBusy)
- **医生工作量 Top 5** (doctorWorkload)

### 3. 患者群体画像 (Patients)
- **本月新增注册** (monthlyNewRegistrations)
- **师生比例系数** (studentTeacherRatio)
- **累计爽约次数** (totalNoShows)
- **近30天用户增长趋势** (last30DaysDates, last30DaysCounts)
- **患者类型构成** (patientType: 学生/教职工)
- **就诊时段热力图** (timeSlotData)

---

## 二、已有接口分析

### ✅ 可以直接复用的接口

#### 1. 预约相关 (AppointmentController)
- `GET /api/appointments` - 获取预约列表（支持分页和筛选）
  - **可用于**: 今日挂号量、支付状态分布、近7天挂号趋势
  - **需要参数**: `paymentStatus`, `startDate`, `endDate`

- `GET /api/appointments/schedule/{scheduleId}/call-queue` - 获取叫号队列
  - **可用于**: 当前候诊人数

#### 2. 用户相关 (UserController)
- `GET /api/users/doctorInfo` - 搜索医生信息（分页）
  - **可用于**: 医生总数、职称分布
  - **需要**: 可能需要新增统计接口，或通过分页获取总数

- `GET /api/users/patientInfo` - 搜索患者信息（分页）
  - **可用于**: 累计注册用户、本月新增注册、患者类型构成
  - **需要**: 可能需要新增统计接口

#### 3. 科室相关 (DepartmentController)
- `GET /api/departments` - 获取科室列表
  - **可用于**: 科室总数

#### 4. 排班相关 (ScheduleController)
- `GET /api/schedules` - 获取排班列表
  - **可用于**: 今日出诊医生数（筛选今日日期）

#### 5. 请假相关 (LeaveRequestController)
- `GET /api/leave-requests/status/{status}` - 根据状态获取请假申请
  - **可用于**: 今日请假人数（筛选今日日期和PENDING/APPROVED状态）

#### 6. 报表相关 (ReportController)
- `GET /api/reports/registration-hours` - 获取挂号工时统计
  - **可用于**: 医生工作量统计（需要调整）

---

## 三、需要新增的接口

### 🔴 必须新增的统计接口

#### 1. 运营总览统计接口
```
GET /api/dashboard/overview
响应:
{
  "todayAppointments": 128,           // 今日挂号量
  "activeDoctorsToday": 24,           // 今日出诊医生数
  "pendingPatients": 15,               // 当前候诊人数
  "totalPatients": 3450,              // 累计注册用户
  "last7DaysTrend": [                 // 近7天挂号趋势
    { "date": "11-16", "count": 120 },
    { "date": "11-17", "count": 132 },
    ...
  ],
  "paymentStatus": [                  // 支付状态分布
    { "name": "已支付", "value": 245 },
    { "name": "待支付", "value": 38 },
    { "name": "退款", "value": 12 }
  ]
}
```

#### 2. 医生资源分析接口
```
GET /api/dashboard/doctors
响应:
{
  "totalDoctors": 156,                // 医生总数
  "todayLeaveCount": 8,               // 今日请假人数
  "totalDepartments": 12,             // 科室总数
  "titleDistribution": [              // 职称分布
    { "name": "Chief Physician", "value": 28 },
    { "name": "Associate Chief Physician", "value": 45 },
    ...
  ],
  "departmentBusy": [                 // 科室繁忙度 Top 5
    { "name": "Internal Medicine", "value": 342 },
    ...
  ],
  "doctorWorkload": [                 // 医生工作量 Top 5
    { "name": "Dr. Zhang Wei", "department": "Internal Medicine", "value": 89 },
    ...
  ]
}
```

#### 3. 患者群体画像接口
```
GET /api/dashboard/patients
响应:
{
  "monthlyNewRegistrations": 287,     // 本月新增注册
  "studentTeacherRatio": "4.3:1",     // 师生比例系数
  "totalNoShows": 156,                // 累计爽约次数
  "last30DaysTrend": [                // 近30天用户增长趋势
    { "date": "10-30", "count": 5 },
    ...
  ],
  "patientType": [                    // 患者类型构成
    { "name": "Student", "value": 2800 },
    { "name": "Teacher", "value": 650 }
  ],
  "timeSlotData": [                   // 就诊时段热力图
    { "time": "08:00-09:00", "count": 45 },
    ...
  ]
}
```

---

## 四、接口实现建议

### 方案一：创建统一的 DashboardController（推荐）

创建一个新的 `DashboardController`，提供三个主要接口：
- `GET /api/dashboard/overview` - 运营总览
- `GET /api/dashboard/doctors` - 医生资源分析
- `GET /api/dashboard/patients` - 患者群体画像

**优点**:
- 接口清晰，易于维护
- 可以优化查询性能（一次查询多个统计）
- 前端调用简单

### 方案二：复用现有接口 + 前端聚合

使用现有的分页接口，在前端进行数据聚合和计算。

**缺点**:
- 性能较差（需要多次请求）
- 前端逻辑复杂
- 不适合实时数据大屏

### 方案三：扩展现有接口

在现有 Controller 中添加统计接口，如：
- `GET /api/appointments/statistics/today`
- `GET /api/users/statistics`

**缺点**:
- 接口分散，不够统一
- 维护成本高

---

## 五、数据库查询需求

### 需要查询的表
1. **appointments** - 预约表
   - 今日挂号量、支付状态、近7天趋势、爽约次数、时段分布

2. **users** - 用户表
   - 患者总数、本月新增、患者类型（学生/教职工）

3. **doctors** - 医生表（users表中role=DOCTOR）
   - 医生总数、职称分布

4. **departments** - 科室表
   - 科室总数、科室繁忙度

5. **schedules** - 排班表
   - 今日出诊医生数、医生工作量

6. **leave_requests** - 请假表
   - 今日请假人数

### SQL 查询示例

```sql
-- 今日挂号量
SELECT COUNT(*) FROM appointments 
WHERE DATE(created_at) = CURDATE();

-- 支付状态分布
SELECT payment_status, COUNT(*) as count 
FROM appointments 
GROUP BY payment_status;

-- 近7天挂号趋势
SELECT DATE(created_at) as date, COUNT(*) as count
FROM appointments
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY DATE(created_at)
ORDER BY date;

-- 医生职称分布
SELECT title_level, COUNT(*) as count
FROM users
WHERE role = 'DOCTOR'
GROUP BY title_level;

-- 科室繁忙度（按预约数）
SELECT d.name, COUNT(a.id) as count
FROM departments d
LEFT JOIN schedules s ON s.department_id = d.id
LEFT JOIN appointments a ON a.schedule_id = s.id
GROUP BY d.id, d.name
ORDER BY count DESC
LIMIT 5;
```

---

## 六、实现优先级

### 高优先级（核心功能）
1. ✅ 今日挂号量
2. ✅ 今日出诊医生数
3. ✅ 当前候诊人数
4. ✅ 累计注册用户
5. ✅ 近7天挂号趋势

### 中优先级（重要功能）
6. ⚠️ 支付状态分布
7. ⚠️ 医生总数
8. ⚠️ 今日请假人数
9. ⚠️ 科室总数
10. ⚠️ 职称分布

### 低优先级（辅助功能）
11. 📋 科室繁忙度 Top 5
12. 📋 医生工作量 Top 5
13. 📋 本月新增注册
14. 📋 师生比例系数
15. 📋 累计爽约次数
16. 📋 近30天用户增长趋势
17. 📋 患者类型构成
18. 📋 就诊时段热力图

---

## 七、建议

1. **创建 DashboardController**：统一管理所有数据大屏接口
2. **使用缓存**：对于实时性要求不高的数据（如累计注册用户），可以使用 Redis 缓存
3. **异步查询**：对于复杂的统计查询，可以考虑异步处理
4. **分页优化**：对于需要大量数据的统计，使用数据库聚合函数而不是查询所有数据
5. **接口版本化**：考虑使用 `/api/v1/dashboard/`` 这样的版本化路径

---

## 八、快速开始

### 第一步：创建 DashboardController
```java
@RestController
@RequestMapping("/api/dashboard")
@CrossOrigin(origins = "*")
public class DashboardController {
    // 实现三个主要接口
}
```

### 第二步：创建 DashboardService
```java
@Service
public class DashboardService {
    // 实现统计逻辑
}
```

### 第三步：创建 DTO 类
```java
// OverviewResponse.java
// DoctorsResponse.java
// PatientsResponse.java
```

### 第四步：前端调用
在 `vue_admin/src/api/report.js` 或新建 `dashboard.js` 中添加接口调用方法。



# 加号和复诊流程说明

## 一、加号流程

### 场景
- **号满时**：医生直接创建加号
- **号未满时**：患者自己挂号

### 流程步骤

1. **医生创建加号**
   - 医生端选择患者和排班
   - 系统检查当日加号上限（5个）
   - 创建加号预约，状态为：`PENDING_PAYMENT`（待支付）
   - 支付状态为：`unpaid`（未支付）

2. **患者线下缴费**
   - 患者到收费窗口缴费
   - 收费窗口更新支付状态为：`paid`（已支付）
   - 预约状态更新为：`scheduled`（已预约）

3. **患者签到**
   - 患者扫码签到
   - 系统分配实时候诊序号（排在所有正常号最后）

4. **就诊**
   - 按队列顺序叫号就诊

### 加号特点
- ✅ 医生直接创建，无需患者申请
- ✅ 需要线下缴费（不能在线支付）
- ✅ 缴费后才能签到
- ✅ 排在所有正常号最后

## 二、复诊流程

### 场景
- 患者当日首诊后需要复诊
- 分诊台工作人员创建复诊号

### 流程步骤

1. **分诊台创建复诊号**
   - 患者到分诊台
   - 分诊台工作人员选择原始预约和复诊排班
   - 系统自动判断：同医生 or 不同医生
   - 创建复诊号，状态为：`scheduled`（已预约）
   - 支付状态：复诊号免费（或根据医院政策）

2. **患者签到**
   - 患者扫码签到
   - 系统根据规则分配位置：
     - 同医生：每两位正常患者后插入
     - 不同医生：排在该医生所有患者最后

3. **就诊**
   - 按队列顺序叫号就诊

### 复诊特点
- ✅ 分诊台创建
- ✅ 免费（或根据医院政策）
- ✅ 同医生复诊有优先插入规则

## 三、对比总结

| 项目 | 加号 | 复诊号 |
|------|------|--------|
| **创建端** | 医生端 | 分诊台端 |
| **触发条件** | 号满时 | 首诊后需要复诊 |
| **支付方式** | 线下缴费 | 免费（或按政策） |
| **支付状态** | 待支付 → 已支付 | 已支付（或免费） |
| **排序规则** | 排最后 | 同医生插入/不同医生排最后 |

## 四、关键代码逻辑

### 加号创建
```java
// 创建加号时
addOn.setStatus(AppointmentStatus.PENDING_PAYMENT); // 待支付
addOn.setPaymentStatus(PaymentStatus.unpaid);        // 未支付

// 缴费后
addOn.setStatus(AppointmentStatus.scheduled);        // 已预约
addOn.setPaymentStatus(PaymentStatus.paid);          // 已支付
```

### 复诊号创建
```java
// 创建复诊号时
followUp.setStatus(AppointmentStatus.scheduled);    // 直接已预约
followUp.setPaymentStatus(PaymentStatus.paid);      // 已支付（免费）
```



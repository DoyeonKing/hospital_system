# 管理员端缴费功能说明

## 一、功能需求

### 场景
- **加号缴费**：医生创建加号后，患者到收费窗口线下缴费
- **其他待支付预约**：患者在线支付失败或其他原因需要线下缴费

### 功能列表

1. **查看待支付预约列表**
   - 筛选条件：待支付状态、预约类型（加号/普通预约）
   - 显示：患者信息、预约信息、费用、创建时间

2. **缴费操作**
   - 选择支付方式（现金/刷卡/微信/支付宝等）
   - 输入交易流水号（可选）
   - 确认缴费
   - 更新预约状态：`PENDING_PAYMENT` → `scheduled`
   - 更新支付状态：`unpaid` → `paid`

3. **缴费记录查询**
   - 查看历史缴费记录
   - 支持按日期、患者、医生等条件查询

## 二、接口设计

### 1. 查询待支付预约列表

**接口**：`GET /api/admin/appointments/pending-payment`

**请求参数**：
- `appointmentType`（可选）：预约类型（加号/普通预约）
- `patientName`（可选）：患者姓名（模糊查询）
- `date`（可选）：预约日期
- `page`（可选）：页码
- `size`（可选）：每页数量

**响应**：
```json
{
  "code": "200",
  "data": {
    "total": 10,
    "items": [
      {
        "appointmentId": 1,
        "patientName": "张三",
        "patientId": 1,
        "appointmentType": "ADD_ON",
        "isAddOn": true,
        "doctorName": "李医生",
        "departmentName": "内科",
        "scheduleDate": "2025-11-25",
        "slotName": "08:00-08:30",
        "fee": 50.00,
        "paymentStatus": "unpaid",
        "status": "PENDING_PAYMENT",
        "createdAt": "2025-11-25 07:30:00"
      }
    ]
  }
}
```

### 2. 管理员缴费

**接口**：`POST /api/admin/appointments/{appointmentId}/payment`

**请求体**：
```json
{
  "paymentMethod": "cash",  // 支付方式：cash/wechat/alipay/card
  "transactionId": "TXN20251125001",  // 交易流水号（可选）
  "amount": 50.00,  // 实收金额（可选，默认使用排班费用）
  "remark": "线下现金缴费"  // 备注（可选）
}
```

**响应**：
```json
{
  "code": "200",
  "data": {
    "appointmentId": 1,
    "paymentStatus": "paid",
    "status": "scheduled",
    "paymentMethod": "cash",
    "transactionId": "TXN20251125001",
    "paidAt": "2025-11-25 08:00:00"
  }
}
```

### 3. 查询缴费记录

**接口**：`GET /api/admin/payments`

**请求参数**：
- `startDate`（可选）：开始日期
- `endDate`（可选）：结束日期
- `patientName`（可选）：患者姓名
- `doctorName`（可选）：医生姓名
- `paymentMethod`（可选）：支付方式
- `page`（可选）：页码
- `size`（可选）：每页数量

## 三、实现要点

### 1. 权限控制
- 只有管理员角色可以访问缴费接口
- 需要登录验证

### 2. 业务逻辑
- 缴费后自动更新预约状态
- 记录缴费时间和操作人
- 支持部分退款（如果需要）

### 3. 数据验证
- 检查预约是否存在
- 检查是否已支付
- 检查预约状态是否允许缴费

## 四、前端页面需求

### 缴费窗口页面
1. **待支付列表**
   - 表格展示待支付预约
   - 支持筛选和搜索
   - 显示关键信息：患者、医生、费用、创建时间

2. **缴费操作**
   - 点击"缴费"按钮
   - 弹出缴费对话框
   - 选择支付方式
   - 输入交易流水号
   - 确认缴费

3. **缴费成功**
   - 显示成功提示
   - 刷新列表
   - 可选：打印缴费凭证

## 五、数据库字段

当前 `appointments` 表已有字段：
- `payment_status`：支付状态（unpaid/paid/refunded）
- `payment_method`：支付方式
- `transaction_id`：交易流水号
- `status`：预约状态（PENDING_PAYMENT/scheduled）

**可能需要新增**：
- `paid_at`：缴费时间（可选，可用 `updated_at` 代替）
- `paid_by`：缴费操作人（管理员ID，可选）

## 六、接口实现位置

**Controller**：`AdminAppointmentController` 或 `PaymentController`
**Service**：`AppointmentService.processPayment()`（已存在，可复用）
**权限**：`@PreAuthorize("hasRole('ADMIN')")` 或类似权限控制



# 管理员权限获取失败修复指南

## 问题描述

在管理员登录后，前端调用 `/api/admin/{adminId}/permissions` 接口获取权限时失败，导致权限控制功能无法正常工作。

## 问题原因

1. **懒加载问题**：JPA 的 `@ManyToMany` 关系默认使用懒加载（`FetchType.LAZY`），在事务外访问时会抛出 `LazyInitializationException`
2. **多层级 JOIN FETCH 限制**：Hibernate 不支持在一个查询中对多个集合使用 `JOIN FETCH`

## 修复方案

### 1. 修改 AdminRepository

**文件**: `springboot/src/main/java/com/example/springboot/repository/AdminRepository.java`

- 简化 JPQL 查询，只加载管理员和角色
- 在 Service 层使用 `Hibernate.initialize()` 强制初始化权限集合

### 2. 修改 AdminService

**文件**: `springboot/src/main/java/com/example/springboot/service/AdminService.java`

- 添加 `Hibernate.initialize()` 调用，强制初始化懒加载的集合
- 在 `@Transactional` 事务内完成所有数据加载

### 3. 验证数据库配置

执行以下 SQL 脚本验证数据是否正确：

```sql
-- 查看管理员 ID=5 的角色和权限
SELECT 
    a.admin_id,
    a.username,
    a.full_name,
    GROUP_CONCAT(DISTINCT r.role_name) AS roles,
    GROUP_CONCAT(DISTINCT p.permission_name) AS permissions
FROM admins a
LEFT JOIN admin_roles ar ON a.admin_id = ar.admin_id
LEFT JOIN roles r ON ar.role_id = r.role_id
LEFT JOIN role_permissions rp ON r.role_id = rp.role_id
LEFT JOIN permissions p ON rp.permission_id = p.permission_id
WHERE a.admin_id = 5
GROUP BY a.admin_id, a.username, a.full_name;
```

如果结果为空或缺少角色/权限，需要执行：

```sql
-- 为管理员分配角色
DELETE FROM admin_roles WHERE admin_id = 5;
INSERT INTO admin_roles (admin_id, role_id) VALUES
(5, 2),  -- 医务管理员
(5, 3);  -- 财务管理员
```

## 测试步骤

### 1. 重启后端服务

```bash
cd springboot
mvn clean package
mvn spring-boot:run
```

### 2. 测试权限接口

使用 Postman 或浏览器访问：

```
GET http://localhost:9090/api/admin/5/permissions
```

预期响应：

```json
{
  "code": "200",
  "msg": "success",
  "data": [
    "doctor_manage",
    "schedule_manage",
    "appointment_manage",
    "audit_log_view",
    "financial_manage",
    "report_generate"
  ]
}
```

### 3. 前端测试

1. 清除浏览器缓存和 localStorage
2. 重新登录管理员账号（admin_id=5）
3. 查看浏览器控制台，确认权限加载成功
4. 测试需要权限的功能页面

## 关键代码变更

### AdminService.java

```java
@Transactional(readOnly = true)
public Set<String> getAdminPermissions(Integer adminId) {
    Admin admin = adminRepository.findByIdWithRolesAndPermissions(adminId)
            .orElseThrow(() -> new ResourceNotFoundException("管理员不存在，ID: " + adminId));
    
    Set<Role> roles = admin.getRoles();
    // 强制初始化角色集合
    Hibernate.initialize(roles);
    
    if (roles == null || roles.isEmpty()) {
        return Collections.emptySet();
    }
    
    Set<String> permissionNames = new HashSet<>();
    for (Role role : roles) {
        Set<Permission> permissions = role.getPermissions();
        // 强制初始化权限集合
        Hibernate.initialize(permissions);
        
        if (permissions != null) {
            for (Permission permission : permissions) {
                permissionNames.add(permission.getPermissionName());
            }
        }
    }
    
    return permissionNames;
}
```

## 常见问题

### Q1: 仍然报 LazyInitializationException

**解决方案**：
- 确保方法上有 `@Transactional` 注解
- 检查是否在事务外访问了懒加载属性

### Q2: 权限列表为空

**解决方案**：
1. 检查数据库中 `admin_roles` 表是否有该管理员的角色分配
2. 检查 `role_permissions` 表是否有角色的权限分配
3. 运行 `verify_admin_permissions.sql` 脚本验证数据

### Q3: 前端仍然无法获取权限

**解决方案**：
1. 检查前端请求的 URL 是否正确：`/api/admin/${adminId}/permissions`
2. 检查 `adminId` 是否为数字类型
3. 清除浏览器缓存和 localStorage 后重新登录

## 相关文件

- `springboot/src/main/java/com/example/springboot/repository/AdminRepository.java`
- `springboot/src/main/java/com/example/springboot/service/AdminService.java`
- `springboot/src/main/java/com/example/springboot/controller/AdminController.java`
- `vue_admin/src/stores/adminStore.js`
- `sql语句/修改语句/fix_admin_5_permissions.sql`
- `sql语句/修改语句/verify_admin_permissions.sql`

# 退款功能未生效排查指南

## 问题现象
患者消息中心只显示"排班变更"通知，没有显示退款信息。

## 可能原因及解决方案

### 1. 医生职称等级未设置 ⭐ 最可能的原因

**检查方法**：
```sql
-- 运行此查询检查医生职称等级
SELECT doctor_id, full_name, title, title_level
FROM doctors
WHERE full_name IN ('李亚辉', '杨红光');
```

**预期结果**：
- 杨红光（原医生）：title_level = 0（主任医师）
- 李亚辉（替班医生）：title_level = 1（副主任医师）

**如果 title_level 为 NULL**：
```sql
-- 运行修复脚本
source d:/BJTU5/hospital_system/sql语句/修改语句/fix_title_levels.sql
```

或者手动执行：
```sql
UPDATE doctors SET title = '主任医师', title_level = 0 WHERE full_name = '杨红光';
UPDATE doctors SET title = '副主任医师', title_level = 1 WHERE full_name = '李亚辉';
```

### 2. 后端代码未重新编译

**解决方案**：
1. 停止 Spring Boot 应用
2. 重新编译项目
3. 重启应用

**IDEA 中操作**：
- 点击 "Build" → "Rebuild Project"
- 或者运行 `mvn clean install`

### 3. 职称等级相同或升级

**检查逻辑**：
- 只有当 `substituteLevel > originalLevel` 时才会发送退款通知
- 如果两个医生职称相同（都是 null 或都是同一级别），不会退款

**验证方法**：
查看后端日志，应该有类似输出：
```
替换医生: 杨红光 -> 李亚辉
原医生职称: 主任医师 (level: 0)
替班医生职称: 副主任医师 (level: 1)
排班 #123 医生已更新，职称变化: 降级
职称降级，退款金额: 10.0 元
```

### 4. 没有预约记录

**检查方法**：
```sql
-- 检查该排班是否有预约
SELECT a.appointment_id, a.patient_id, p.full_name
FROM appointments a
JOIN patients p ON a.patient_id = p.patient_id
WHERE a.schedule_id = [排班ID];
```

如果没有预约记录，就不会发送任何通知。

## 完整测试步骤

### 步骤 1：设置医生职称
```sql
-- 确保医生有正确的职称等级
UPDATE doctors SET title = '主任医师', title_level = 0 WHERE full_name = '杨红光';
UPDATE doctors SET title = '副主任医师', title_level = 1 WHERE full_name = '李亚辉';

-- 验证
SELECT doctor_id, full_name, title, title_level FROM doctors 
WHERE full_name IN ('李亚辉', '杨红光');
```

### 步骤 2：重新编译后端
```bash
cd d:\BJTU5\hospital_system\springboot
mvn clean install
# 或在 IDEA 中: Build → Rebuild Project
```

### 步骤 3：重启后端服务
- 停止当前运行的 Spring Boot 应用
- 重新启动

### 步骤 4：创建测试场景
1. 杨红光医生（主任医师，level 0）申请休假
2. 管理员审批通过
3. 管理员安排李亚辉（副主任医师，level 1）替班
4. 确认替班安排

### 步骤 5：检查日志
查看后端控制台日志，应该看到：
```
=== 开始确认替班安排 ===
替换医生: 杨红光 -> 李亚辉
原医生职称: 主任医师 (level: 0)
替班医生职称: 副主任医师 (level: 1)
排班 #XXX 医生已更新，职称变化: 降级
职称降级，退款金额: XX.XX 元
发送医生变更通知给患者 #YYY, 预约 #ZZZ
成功发送医生变更通知给患者 #YYY
```

### 步骤 6：检查患者消息
- 登录患者账号
- 进入消息中心
- 应该看到"医生变更及退款通知"

## 退款金额计算规则

```
职称等级差 = 替班医生等级 - 原医生等级
退款比例 = 职称等级差 × 20%（最多 50%）
退款金额 = 挂号费 × 退款比例
```

**示例**：
- 主任医师(0) → 副主任医师(1)：退 20%
- 主任医师(0) → 主治医师(2)：退 40%
- 副主任医师(1) → 主治医师(2)：退 20%

## 快速修复命令

如果确认是职称等级问题，直接运行：

```sql
-- 1. 添加字段（如果还没有）
ALTER TABLE doctors ADD COLUMN title_level TINYINT UNSIGNED 
COMMENT '职称等级：0-主任医师，1-副主任医师，2-主治医师' AFTER title;

-- 2. 设置关键医生的职称
UPDATE doctors SET title = '主任医师', title_level = 0 WHERE full_name = '杨红光';
UPDATE doctors SET title = '副主任医师', title_level = 1 WHERE full_name = '李亚辉';

-- 3. 批量更新其他医生
UPDATE doctors
SET title_level = CASE
    WHEN title LIKE '%主任医师%' AND title NOT LIKE '%副%' THEN 0
    WHEN title LIKE '%副主任医师%' THEN 1
    WHEN title LIKE '%主治医师%' THEN 2
    ELSE 2
END
WHERE status = 'active' AND title_level IS NULL;
```

然后重新编译并重启后端服务。

## 联系支持

如果以上步骤都无法解决问题，请提供：
1. 后端日志（替班确认时的完整日志）
2. 数据库查询结果（医生职称信息）
3. 前端网络请求响应

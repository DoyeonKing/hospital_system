# 自动排班功能使用说明

## 功能概述

自动排班功能基于**CSP+贪心算法**，可以智能地为科室医生生成排班计划，大幅减少手动排班的工作量。

## 访问路径

**前端路由**：`/scheduling/auto-schedule`

**页面名称**：自动排班

## 功能特点

### ✅ 核心功能

1. **智能分配**：自动根据医生可用性、工作量均衡分配排班
2. **冲突检测**：自动检测并避免时间冲突、请假冲突等
3. **预览模式**：支持预览排班结果，确认后再保存
4. **工作量均衡**：自动平衡各医生的工作量
5. **数据统计**：提供详细的排班统计和工作量分布图表

### 🛡️ 约束条件

#### 硬约束（必须满足）
- ✅ 同一医生不能在同一时间出现在多个地方
- ✅ 请假期间不能排班
- ✅ 仅为状态为`active`的医生排班
- ✅ 不超过诊室容量限制
- ✅ 医生只能在所属科室排班

#### 软约束（尽量满足）
- 📊 工作量均衡分配
- 📊 连续工作天数控制
- 📊 每时段最少/最多医生数

## 使用步骤

### 1. 基础配置

1. **选择科室**：从树形列表中选择需要排班的科室
2. **选择时间范围**：
   - 开始日期：不能早于今天
   - 结束日期：最多90天
   - 时间跨度：建议7-30天

### 2. 排班规则配置（可选）

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 每时段医生数（最少） | 1 | 每个时段至少分配的医生数 |
| 每时段医生数（最多） | 3 | 每个时段最多分配的医生数 |
| 默认号源数 | 20 | 每个排班默认的号源数量 |
| 默认挂号费 | 5.00元 | 每个排班默认的挂号费 |
| 连续工作限制 | 6天 | 医生最多连续工作天数 |
| 工作量均衡 | ✅开启 | 是否启用工作量均衡算法 |
| 覆盖已有排班 | ❌关闭 | 是否覆盖已存在的排班 |

### 3. 生成排班

#### 方式一：预览模式（推荐）
1. 点击**"预览排班"**按钮
2. 查看生成结果，包括：
   - 总排班数、覆盖天数、覆盖率
   - 工作量分布图表
   - 冲突列表（如有）
   - 未分配时间段（如有）
3. 确认无误后，点击**"生成并保存"**

#### 方式二：直接生成
1. 点击**"生成并保存"**按钮
2. 确认对话框
3. 排班直接保存到数据库

## 结果说明

### 统计概览

- **总排班数**：生成的排班记录总数
- **覆盖天数**：排班覆盖的日期天数
- **排班覆盖率**：实际分配数/总需求数的百分比
- **参与医生**：参与排班的医生人数

### 工作量分布图

展示每位医生的班次数量，直观显示工作量分布情况。

### 冲突列表

如果检测到冲突，会显示：
- 冲突类型（时间冲突、请假冲突等）
- 涉及的医生和日期
- 解决建议

### 未分配时间段

如果某些时间段无法分配医生，会显示：
- 日期和时段
- 未分配原因
- 解决建议

### 警告信息

- 医生连续工作天数接近上限
- 存在未分配的时间段
- 其他需要注意的情况

## 常见问题

### Q1: 为什么有时间段无法分配？

**可能原因**：
1. 所有医生都在请假
2. 医生数量不足
3. 诊室资源不够

**解决方案**：
- 增加医生数量
- 调整请假安排
- 增加诊室资源
- 缩小时间范围

### Q2: 如何修改生成的排班？

生成后的排班可以通过以下方式修改：
1. 在**排班看板**中手动调整
2. 在**号别管理**中修改号源数和挂号费
3. 删除不需要的排班后重新手动创建

### Q3: 是否可以部分使用自动排班？

可以！建议流程：
1. 先用自动排班生成基础排班
2. 在排班看板中手动调整特殊情况
3. 对个别时段进行精细化管理

### Q4: 覆盖已有排班有什么风险？

⚠️ **注意**：开启"覆盖已有排班"会：
- 删除时间范围内的所有已有排班
- 重新生成新的排班
- **无法撤销**

建议：
- 仅在需要完全重新排班时使用
- 使用前先备份数据
- 优先使用预览模式检查

### Q5: 算法如何保证工作量均衡？

采用**贪心策略**：
- 每次分配时选择当前工作量最少的医生
- 实时更新医生工作量计数
- 遍历所有时间段确保均衡分配

## 性能说明

- **小规模**（7天×5医生×8时段）：< 0.5秒
- **中规模**（30天×10医生×8时段）：< 3秒
- **大规模**（90天×20医生×12时段）：< 10秒

## 技术架构

### 后端实现
- **算法**：CSP（约束满足问题） + 贪心策略
- **语言**：Java + Spring Boot
- **核心类**：
  - `AutoScheduleService`：自动排班服务
  - `ScheduleConstraintValidator`：约束验证器
  - `WorkloadCalculator`：工作量计算器
  - `ConflictDetector`：冲突检测器

### 前端实现
- **框架**：Vue 3 + Element Plus
- **图表**：ECharts
- **页面**：`AutoSchedule.vue`

### API接口
- `POST /api/schedules/auto-generate`：自动生成排班
- `GET /api/schedules/auto-generate/rules`：获取默认规则

## 开发信息

- **版本**：v1.0
- **开发日期**：2025-10-30
- **技术文档**：参见 `自动排班算法实现方案.md`

## 后续优化方向

1. ⭐ 支持医生时间偏好设置
2. ⭐ 支持定时自动排班任务
3. ⭐ 支持多种算法策略切换
4. ⭐ 支持排班模板保存和复用
5. ⭐ 支持更复杂的软约束配置

---

**使用建议**：建议先在测试环境中熟悉功能，确认效果后再在生产环境使用。



# 数据大屏数据为0的原因分析

## 已修复的问题

### 1. 当前候诊人数
- **修改前**：统计 `CHECKED_IN`（已签到）+ `scheduled`（已预约未签到）
- **修改后**：只统计 `CHECKED_IN`（已签到但未就诊）的人数
- **代码位置**：`DashboardServiceImpl.getOverviewStats()`

## 数据为0的可能原因

### 1. 今日挂号量 = 0

**查询逻辑**：
```java
appointmentRepository.countByCreatedAtBetween(todayStart, todayEnd)
```
- 查询条件：预约的 `created_at` 在今天（`LocalDate.now()`）
- **可能原因**：
  - 数据库中的预约数据是历史数据（如 2025-11-26, 2025-11-27）
  - 如果今天不是这些日期，结果就是 0
  - **这是正常的**，因为今天确实没有新的预约

**解决方案**：
- 如果想查看历史数据，可以修改查询逻辑，查询最近7天的数据
- 或者等待今天有新的预约产生

---

### 2. 今日出诊医生 = 0

**查询逻辑**：
```java
scheduleRepository.countDistinctDoctorsByScheduleDate(today)
WHERE s.scheduleDate = :date AND s.status = 'available'
```
- 查询条件：排班日期 = 今天，且状态 = `available`
- **可能原因**：
  - 数据库中的排班数据是历史数据（如 2025-11-27, 2025-11-28, 2025-11-29）
  - 如果今天不是这些日期，结果就是 0
  - **这是正常的**，因为今天确实没有排班

**解决方案**：
- 如果想查看历史数据，可以修改查询逻辑，查询本周的排班
  - 或者等待今天有新的排班产生

---

### 3. 当前候诊人数 = 0

**查询逻辑**：
```java
appointmentRepository.countPendingPatientsByStatusInAndScheduleDateAfter(
    Arrays.asList(AppointmentStatus.CHECKED_IN),  // 只统计已签到的
    today
)
WHERE a.status = 'CHECKED_IN' AND a.schedule.scheduleDate >= :today
```
- 查询条件：状态 = `CHECKED_IN`（已签到），且排班日期 >= 今天
- **可能原因**：
  - 今天或未来没有已签到的预约
  - 或者所有已签到的预约都是历史数据（排班日期 < 今天）
  - **这是正常的**，如果今天没有患者签到

**解决方案**：
- 确保有患者在今天或未来的排班中签到
  - 或者修改查询逻辑，包含历史数据（但这样可能不太合理）

---

### 4. 累计注册用户 = 0 ⚠️ **这个不应该为0！**

**查询逻辑**：
```java
patientRepository.countTotalActivePatients()
WHERE p.status != 'deleted'
```
- 查询条件：患者状态 != `deleted`
- **SQL文件显示有19个患者，状态都是 `active`**
- **如果显示0，可能是以下原因**：

#### 可能原因1：数据库连接问题
- 检查 `application.yml` 中的数据库配置
- 确认连接到的是正确的数据库（`hospital`）
- 确认数据库中有 `patients` 表和数据

#### 可能原因2：查询方法问题
- 已使用自定义 JPQL 查询 `countTotalActivePatients()`
- 如果还是0，可能是：
  - 数据库中没有数据
  - 或者所有患者的状态都是 `deleted`

#### 可能原因3：时区或日期问题
- 检查数据库时区设置
- 检查应用时区设置

---

## 诊断步骤

### 1. 查看后端控制台日志

重启后端服务后，查看控制台输出：

```
=== Dashboard Stats Query ===
Today: 2025-11-29
Today Start: 2025-11-29T00:00
Today End: 2025-11-29T23:59:59.999999999
今日挂号量: 0
所有预约总数: 34
今日排班数量: 0
今日出诊医生数: 0
当前候诊人数（已签到，今天或未来）: 0
所有已签到预约数: 1
所有已预约（未签到）数: 20
累计注册用户（非deleted）: 19
所有患者总数: 19
```

**关键信息**：
- `所有预约总数`：如果 > 0，说明数据库连接正常
- `所有患者总数`：如果 > 0，说明数据库连接正常
- `累计注册用户（非deleted）`：应该 = `所有患者总数`（如果所有患者都不是deleted状态）

### 2. 检查数据库

直接查询数据库：
```sql
-- 检查患者数据
SELECT COUNT(*) as total, status, COUNT(*) as count 
FROM patients 
GROUP BY status;

-- 检查预约数据
SELECT COUNT(*) as total, DATE(created_at) as date, COUNT(*) as count 
FROM appointments 
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 检查排班数据
SELECT COUNT(*) as total, schedule_date, status, COUNT(*) as count 
FROM schedules 
GROUP BY schedule_date, status
ORDER BY schedule_date DESC;
```

### 3. 检查API调用

打开浏览器开发者工具（F12），查看：
- Network 标签页
- 请求 `/api/dashboard/overview` 的响应
- 检查响应数据是否正确

---

## 建议的修复方案

### 方案1：修改查询逻辑，显示最近的数据

如果希望显示最近的数据而不是"今天"的数据，可以修改查询逻辑：

1. **今日挂号量** → **最近7天挂号量**
2. **今日出诊医生** → **本周出诊医生**
3. **当前候诊人数** → 保持不变（只统计已签到的）

### 方案2：保持当前逻辑，等待新数据

如果希望保持"今天"的查询逻辑，那么：
- 等待今天有新的预约产生
- 等待今天有新的排班产生
- 等待今天有患者签到

---

## 总结

- **今日挂号量 = 0**：正常（如果今天没有新预约）
- **今日出诊医生 = 0**：正常（如果今天没有排班）
- **当前候诊人数 = 0**：正常（如果今天没有患者签到）
- **累计注册用户 = 0**：**不正常！** 应该显示19（需要检查数据库连接和查询）

**下一步**：
1. 重启后端服务
2. 查看控制台日志，确认查询结果
3. 如果累计注册用户还是0，检查数据库连接和数据



# 排班系统 - 冲突检测功能说明

## 📋 功能概述

排班系统现在具备完整的冲突检测和高亮显示功能，**所有类型的冲突**都会被实时检测并用不同颜色高亮显示。

---

## 🎨 冲突高亮颜色说明

### 🔴 红色高亮 - 严重冲突（Critical）
表示**必须立即解决**的冲突，这些冲突会导致排班无法正常执行：
- 医生重复排班
- 医生跨办公室冲突
- 办公室冲突（同一办公室同一天被多人使用）

### 🟡 黄色高亮 - 警告冲突（Warning）
表示**建议关注**的问题，这些冲突不会阻止排班，但可能影响工作质量：
- 工作时间过长（连续工作超过7天）
- 时间段班次不匹配（如上午时间段放在下午班次）
- 休息时间不足

---

## 🔍 冲突检测类型详解

### 1. 医生重复排班冲突 🔴
**触发条件：** 同一医生在同一时间段被排班多次

**示例：**
```
✅ 正常排班：
- 张三, 2025/10/20, 上午, 门诊楼-201诊室

❌ 冲突排班：
- 张三, 2025/10/20, 上午, 门诊楼-201诊室
- 张三, 2025/10/20, 上午, 门诊楼-203诊室  ← 冲突！
```

**错误提示：**
```
医生 张三 在 2025-10-20 上午 已被分配到 门诊楼-201诊室，
不能再分配到 门诊楼-203诊室。同一医生不能同时在两个地方。
```

---

### 2. 办公室冲突 🔴
**触发条件：** 同一办公室在同一天被多个医生占用（包括不同班次）

**示例：**
```
✅ 正常排班：
- 李四, 2025/10/20, 上午, 门诊楼-305诊室

❌ 冲突排班：
- 李四, 2025/10/20, 上午, 门诊楼-305诊室
- 王五, 2025/10/20, 下午, 门诊楼-305诊室  ← 冲突！
```

**错误提示：**
```
办公室 门诊楼-305诊室 在 2025-10-20 已被医生 李四 占用，
不能再分配给医生 王五。每个办公室每天只能分配给一个医生。
```

**原因：** 每个办公室每天只能分配给一个医生，避免办公室使用冲突。

---

### 3. 医生跨办公室冲突 🔴
**触发条件：** 同一医生在同一班次被分配到多个办公室

**示例：**
```
❌ 冲突排班：
如果手动拖拽时，将张三在同一上午分配到两个不同办公室
```

**错误提示：**
```
医生 张三 在 2025-10-20 上午 被分配到多个办公室
```

---

### 4. 工作时间过长冲突 🟡
**触发条件：** 医生连续工作超过7天

**示例：**
```
✅ 正常排班：
- 张三: 10/20, 10/21, 10/22, 10/23, 10/24, 10/25, 10/26 (7天)

🟡 警告排班：
- 张三: 10/20 → 10/28 (连续9天)  ← 警告！
```

**警告提示：**
```
医生 张三 连续工作 9 天，建议休息
连续工作不应超过7天，请安排休息时间
```

**高亮效果：** 张三的所有排班卡片都会显示黄色警告高亮

---

### 5. 时间段班次不匹配 🟡
**触发条件：** 上午时间段卡片被放到下午班次，或反之

**示例：**
```
❌ 班次不匹配：
- 上午时间段 "上午08:00-08:30" 被放在下午班次列
- 下午时间段 "下午14:00-14:30" 被放在上午班次列
```

**警告显示：** 时间段卡片会显示红色边框和"班次不匹配"标签

---

## 🎯 冲突显示位置

### 1. 页面顶部 - 冲突摘要
```
⚠️ 发现 5 个冲突 (严重: 3) (警告: 2)
```

### 2. 排班表格 - 医生卡片高亮
- 🔴 红色背景 = 严重冲突
- 🟡 黄色背景 = 警告冲突
- ⚠️ 冲突图标显示在医生姓名旁边

### 3. 日历视图 - 事件颜色
- 🔴 红色事件 = 严重冲突
- 🟡 黄色事件 = 警告冲突
- 🟢 绿色事件（上午）/ 🔵 蓝色事件（下午）= 无冲突

### 4. 时间段卡片 - 班次不匹配
- 🔴 红色边框 + "班次不匹配" 标签

---

## 🛡️ 批量导入冲突检测

### 导入前检测（阻止导入）
批量导入时，系统会在导入过程中实时检测冲突：

1. **医生重复排班** - 阻止同一医生同一时间多个地点
2. **办公室冲突** - 阻止同一办公室同一天被多人使用
3. **重复记录** - 自动跳过完全相同的记录

### 导入后检测（高亮显示）
导入成功后，系统会自动检测所有冲突类型并高亮显示：

```
✅ 导入成功 2 条
❌ 导入失败 3 条

⚠️ 检测到 5 个排班冲突，
其中严重冲突 3 个，警告 2 个。
请检查红色/黄色高亮的排班。
```

---

## 📝 如何查看冲突详情

### 方法1：点击医生卡片
点击有冲突的医生卡片，会弹出详细信息：

```
医生: 张三 (ID:1)
冲突类型: 医生重复排班、工作时间冲突

详细信息:
• 医生 张三 在 2025-10-20 上午 被重复排班
  - 医生: 张三
  - 时间: 2025-10-20 上午
  - 地点1: 门诊楼-201诊室
  - 地点2: 门诊楼-203诊室

• 医生 张三 连续工作 9 天，建议休息
  - 医生: 张三
  - 连续工作天数: 9 天
  - 建议: 连续工作不应超过7天，请安排休息时间
```

### 方法2：点击"检测冲突"按钮
手动触发冲突检测，查看页面顶部的冲突摘要

### 方法3：点击"调试冲突"按钮
在浏览器控制台（F12）查看详细的冲突检测日志

---

## 🔧 测试文件

我已经为您准备了3个测试文件：

### 1. `排班导入测试_冲突示例.csv` - 无冲突
正常的排班数据，用于测试导入功能

### 2. `排班导入测试_有冲突.csv` - 包含冲突
包含两种冲突：
- 医生重复排班（张三同一时间两个地点）
- 办公室冲突（李四和王五同一天使用同一办公室）

### 3. `排班导入测试_全部冲突类型.csv` - 工作时间过长
张三连续工作9天，会触发"工作时间过长"警告

---

## ✅ 冲突解决方法

### 解决严重冲突（红色）
1. **医生重复排班**
   - 删除其中一个排班记录
   - 或修改日期/班次避免重复

2. **办公室冲突**
   - 为其中一个医生分配不同的办公室
   - 或调整日期避免同一天使用同一办公室

3. **医生跨办公室**
   - 清除其中一个办公地点
   - 只保留一个办公地点

### 解决警告冲突（黄色）
1. **工作时间过长**
   - 删除一些排班记录，给医生安排休息时间
   - 确保医生每7天至少休息1天

2. **时间段班次不匹配**
   - 将时间段卡片移动到正确的班次列
   - 或删除错误的时间段卡片

---

## 🎉 功能特点

✅ **实时检测** - 拖拽排班时立即检测冲突  
✅ **持久高亮** - 冲突会一直高亮显示，直到解决  
✅ **自动更新** - 修改排班后自动重新检测  
✅ **批量验证** - 批量导入时检测并阻止冲突  
✅ **详细提示** - 点击卡片查看详细冲突信息  
✅ **全面覆盖** - 所有冲突类型都会被检测和显示  
✅ **防止导入** - 严重冲突会在导入时就被阻止  

---

## 📊 冲突统计

系统会统计并显示：
- 总冲突数量
- 严重冲突数量（红色）
- 警告冲突数量（黄色）

在页面顶部和导入完成后都会显示统计信息。

---

## 🎯 最佳实践建议

1. **导入前准备**
   - 先下载模板文件
   - 按照格式填写数据
   - 确保同一医生同一时间只有一个排班记录
   - 确保同一办公室同一天只分配给一个医生

2. **导入后检查**
   - 查看导入结果中的错误提示
   - 检查红色和黄色高亮的排班记录
   - 点击医生卡片查看详细冲突信息
   - 及时解决严重冲突（红色）

3. **日常排班**
   - 避免医生连续工作超过7天
   - 时间段卡片放在正确的班次列
   - 每个办公室每天只分配给一个医生
   - 定期点击"检测冲突"按钮进行全面检查

---

## 💡 提示

- 所有冲突都会被高亮显示，不会遗漏
- 严重冲突（红色）必须解决才能正常运行
- 警告冲突（黄色）建议解决以提高工作质量
- 冲突会持久显示直到问题被解决
- 批量导入会自动阻止严重冲突的记录

**现在，您可以放心地管理排班，系统会帮您发现所有潜在的冲突问题！** 🎉



# 室内导航子系统实现说明

## 概述

已成功实现医院挂号系统的室内导航子系统，完成了从"挂号预约"到"诊室导航"的完整业务闭环。

## 实现内容

### 第一部分：后端开发 (Spring Boot)

#### 1. DTO类（com.example.springboot.dto.map包）

- **MapGridDTO.java**: 地图网格数据传输对象
  - `width`: 网格宽度
  - `height`: 网格高度
  - `gridMatrix`: 网格矩阵（0=通路，1=障碍物）

- **MapNodeDTO.java**: 地图节点数据传输对象
  - `nodeId`: 节点ID
  - `name`: 节点名称
  - `x`, `y`: 网格坐标
  - `locationId`: 关联的Location表ID

- **MapConfigResponse.java**: 地图配置响应DTO
  - 包含网格数据和所有节点列表

#### 2. MapService服务

- **MapService.java**: 地图服务类
  - 初始化40x30网格地图
  - 设置障碍物（墙壁区域）
  - 预设5个关键节点：
    - Node 1: "医院大门" (20, 29)
    - Node 2: "分诊台" (20, 20)
    - Node 3: "电梯口" (35, 20)
    - Node 4: "内科诊室" (5, 10) - locationId=1
    - Node 5: "外科诊室" (5, 5) - locationId=2
  - 提供方法：
    - `getMapConfig()`: 获取地图配置
    - `getNodeByLocationId()`: 根据locationId查询节点
    - `getNodeByNodeId()`: 根据nodeId查询节点

#### 3. MapController控制器

- **MapController.java**: 地图API控制器
  - `GET /api/map/config`: 获取地图配置
  - `GET /api/map/target/{locationId}`: 根据诊室ID查询目标节点

### 第二部分：前端开发 (Uni-app)

#### 1. API接口文件

- **api/map.js**: 地图相关API封装
  - `getMapConfig()`: 获取地图配置
  - `getTargetNode(locationId)`: 获取目标节点

#### 2. 导航页面

- **pages/navigation/index.vue**: 导航主页面
  - 功能特性：
    - 接收locationId或appointmentId参数
    - 自动获取地图配置和目标节点
    - 内置A*路径规划算法（SimpleAStar类）
    - Canvas绘制地图和路径
    - 实时导航动画（小图标沿路径移动）
    - 调试模式（显示障碍物网格）
    - 控制面板（显示目标名称和剩余距离）

- **pages/navigation/index.json**: 页面配置

- **pages/navigation/README.md**: 使用说明文档

#### 3. 页面配置更新

- **pages.json**: 添加导航页面路由配置

### 第三部分：业务集成

#### 预约详情页修改

- **pages/appointment/detail.vue**: 
  - 更新`handleNavigation()`方法
  - 优先使用`appointment.schedule.locationId`
  - 支持直接传递locationId或appointmentId

## 技术特点

### 1. 鲁棒性
- 所有方法都有空值检查
- 异常处理完善
- 路径连通性验证（确保诊室不在墙内）

### 2. 算法实现
- 内置A*路径规划算法
- 支持四方向和对角线移动
- 自动避障

### 3. 可视化
- Canvas绘制地图
- 半透明网格调试模式
- 动态路径动画
- 起点、终点、当前位置标记

### 4. 用户体验
- 实时显示剩余距离
- 显示目标诊室名称
- 加载状态提示
- 错误提示友好

## 文件清单

### 后端文件
```
springboot/src/main/java/com/example/springboot/
├── dto/map/
│   ├── MapGridDTO.java
│   ├── MapNodeDTO.java
│   └── MapConfigResponse.java
├── service/
│   └── MapService.java
└── controller/
    └── MapController.java
```

### 前端文件
```
uni_app/
├── api/
│   └── map.js
├── pages/
│   ├── navigation/
│   │   ├── index.vue
│   │   ├── index.json
│   │   └── README.md
│   └── appointment/
│       └── detail.vue (已修改)
└── pages.json (已更新)
```

## 使用说明

### 1. 安装依赖（可选）

如果需要使用pathfinding库（代码中已内置简化版A*算法，无需安装）：

```bash
cd uni_app
npm install pathfinding
```

### 2. 准备背景图片（可选）

将医院平面图放置在：
```
uni_app/static/images/hospital_floor_1.jpg
```

如果图片不存在，Canvas仍会正常显示路径。

### 3. 测试流程

1. 启动Spring Boot后端服务
2. 启动Uni-app前端项目
3. 进入预约详情页
4. 点击"导航到诊室"按钮
5. 查看导航页面，观察路径规划和动画效果

## API测试

### 获取地图配置
```bash
curl http://localhost:8080/api/map/config
```

### 获取目标节点
```bash
curl http://localhost:8080/api/map/target/1
```

## 扩展建议

1. **数据库集成**: 将地图数据存储到数据库，支持动态配置
2. **多楼层支持**: 扩展支持多楼层导航
3. **实时定位**: 集成蓝牙/iBeacon实现实时定位
4. **语音导航**: 添加语音提示功能
5. **3D可视化**: 使用Three.js实现3D地图展示

## 注意事项

1. 地图网格尺寸为40x30，如需修改请在`MapService.java`中调整
2. 节点坐标必须在网格范围内（0-39列，0-29行）
3. 确保诊室节点位置不在障碍物包围中
4. Canvas尺寸为750x600px，可根据实际需求调整

## 演示效果

- ✅ 地图网格正确显示
- ✅ 障碍物正确标记（调试模式下可见）
- ✅ 路径自动规划并避障
- ✅ 动态导航动画流畅
- ✅ 控制面板信息实时更新
- ✅ 从预约详情页无缝跳转

## 总结

已完整实现室内导航子系统，代码具有演示级鲁棒性，包含完整的错误处理和用户提示。系统支持从预约详情页直接跳转导航，实现了完整的业务闭环。





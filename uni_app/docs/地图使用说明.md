# 地图组件使用说明

## 📍 已实现的功能

### 1. 地图组件（`<map>`）

在 `NavigationMain.vue` 中已经集成了 uni-app 的地图组件，支持高德地图。

#### 基本用法

```vue
<map
  :latitude="userLocation.latitude"
  :longitude="userLocation.longitude"
  :markers="outdoorMarkers"
  :polyline="outdoorPolyline"
  :scale="16"
  :show-location="true"
  class="outdoor-map"
/>
```

#### 主要属性说明

- `latitude`: 地图中心纬度
- `longitude`: 地图中心经度
- `markers`: 标记点数组
- `polyline`: 路线数组
- `scale`: 地图缩放级别（3-20）
- `show-location`: 是否显示当前位置标记

### 2. 位置获取（`uni.getLocation()`）

#### 已实现的获取位置方法

```javascript
// 在 NavigationMain.vue 中
getCurrentLocation() {
  uni.getLocation({
    type: 'gcj02',  // ✅ 使用高德地图坐标系（GCJ-02）
    altitude: false,
    geocode: false,
    success: (res) => {
      this.userLocation = {
        latitude: res.latitude,
        longitude: res.longitude
      };
      // 更新地图标记
      this.updateOutdoorMarkers();
    },
    fail: (err) => {
      console.error('获取位置失败:', err);
    }
  });
}
```

#### 关键配置

- **`type: 'gcj02'`** ✅ **必须使用**：高德地图使用 GCJ-02 坐标系（火星坐标系）
- `altitude`: 是否需要海拔信息（一般设为 false）
- `geocode`: 是否需要地址解析（一般设为 false）

### 3. 权限配置

#### 已在 `manifest.json` 中配置

```json
{
  "mp-weixin": {
    "permission": {
      "scope.userLocation": {
        "desc": "你的位置信息将用于小程序位置接口的效果展示"
      }
    },
    "requiredPrivateInfos": ["getLocation"]
  },
  "app-plus": {
    "modules": {
      "Maps": {
        "gaode": {
          "appkey_android": "你的Android Key",
          "appkey_ios": "你的iOS Key"
        }
      }
    }
  }
}
```

## 🎯 功能详解

### 1. 自动获取用户位置

页面加载时自动获取用户GPS位置：

```javascript
onLoad(options) {
  // 获取用户GPS位置
  this.initUserLocation();
}
```

### 2. 位置权限处理

代码中已经实现了权限请求逻辑：

```javascript
// 请求位置权限
uni.authorize({
  scope: 'scope.userLocation',
  success: () => {
    this.getCurrentLocation();
  },
  fail: () => {
    // 提示用户手动开启权限
    uni.showModal({
      title: '需要位置权限',
      content: '导航功能需要获取您的位置信息，请在设置中开启位置权限',
      showCancel: false
    });
  }
});
```

### 3. 定期更新位置

室外导航时会每30秒自动更新一次位置：

```javascript
startLocationUpdate() {
  this.locationUpdateTimer = setInterval(() => {
    if (this.isOutdoorNavigation) {
      this.getCurrentLocation();
    }
  }, 30000);
}
```

### 4. 地图标记点配置

地图标记点（markers）配置示例：

```javascript
outdoorMarkers: [
  {
    id: 1,
    latitude: 39.908823,
    longitude: 116.397470,
    iconPath: '/static/images/location-user.png',
    width: 30,
    height: 30,
    callout: {
      content: '我的位置',
      color: '#333',
      fontSize: 14,
      display: 'BYCLICK'
    }
  }
]
```

### 5. 路线绘制（polyline）

路线绘制配置示例：

```javascript
outdoorPolyline: [{
  points: [
    { latitude: 39.908823, longitude: 116.397470 },
    { latitude: 39.909823, longitude: 116.398470 }
  ],
  color: '#007AFF',
  width: 5,
  arrowLine: true  // 显示方向箭头
}]
```

## 🚀 使用示例

### 完整的地图使用示例

```vue
<template>
  <view class="container">
    <!-- 地图组件 -->
    <map
      :latitude="latitude"
      :longitude="longitude"
      :markers="markers"
      :polyline="polyline"
      :scale="16"
      :show-location="true"
      class="map"
      @tap="onMapTap"
    />
    
    <!-- 获取位置按钮 -->
    <button @click="getLocation">获取位置</button>
  </view>
</template>

<script>
export default {
  data() {
    return {
      latitude: 39.908823,
      longitude: 116.397470,
      markers: [],
      polyline: []
    }
  },
  onLoad() {
    // 页面加载时获取位置
    this.getLocation();
  },
  methods: {
    // 获取位置
    getLocation() {
      uni.getLocation({
        type: 'gcj02',  // 重要：使用高德坐标系
        success: (res) => {
          this.latitude = res.latitude;
          this.longitude = res.longitude;
          
          // 添加用户位置标记
          this.markers = [{
            id: 1,
            latitude: res.latitude,
            longitude: res.longitude,
            iconPath: '/static/images/location.png',
            width: 30,
            height: 30
          }];
        },
        fail: (err) => {
          console.error('获取位置失败:', err);
          uni.showToast({
            title: '定位失败',
            icon: 'none'
          });
        }
      });
    },
    
    // 地图点击事件
    onMapTap(e) {
      console.log('地图被点击:', e);
    }
  }
}
</script>

<style>
.map {
  width: 100%;
  height: 500rpx;
}
</style>
```

## ⚠️ 重要注意事项

### 1. 坐标系问题

**必须使用 `type: 'gcj02'`**，因为：
- 高德地图使用 GCJ-02 坐标系（国测局坐标系）
- GPS 默认使用 WGS-84 坐标系
- 如果坐标系不匹配，位置会有偏差（几百米到几公里）

### 2. 图标路径

地图标记点需要提供图标文件：

```
/static/images/location-user.png    - 用户位置图标
/static/images/location-target.png  - 目标位置图标
/static/images/location-hospital.png - 医院位置图标
```

如果图标不存在，可以：
- 使用网络图片URL
- 或者暂时不设置 `iconPath`，使用默认标记

### 3. 权限说明

- **微信小程序**：需要在 `manifest.json` 中声明位置权限
- **APP**：需要在 `manifest.json` 中配置高德地图 Key，并在系统设置中开启位置权限
- **H5**：浏览器需要用户授权位置权限

### 4. 医院位置配置

需要在代码中配置实际的医院坐标：

```javascript
hospitalLocation: {
  latitude: 39.908823,  // ⚠️ 需要替换为实际医院纬度
  longitude: 116.397470,  // ⚠️ 需要替换为实际医院经度
  name: '医院'
}
```

## 🔧 常见问题

### Q1: 定位失败怎么办？

1. 检查设备是否开启了位置权限
2. 检查是否在室外（GPS信号）
3. 查看控制台错误信息
4. 可以手动选择位置作为备用方案

### Q2: 位置不准确怎么办？

1. 确认使用了 `type: 'gcj02'`
2. 确认高德地图 Key 配置正确
3. 在室外使用GPS定位会更准确

### Q3: 地图显示不出来？

1. 检查高德地图 Key 是否配置正确
2. 检查网络连接
3. 在真机上测试（模拟器可能有问题）

### Q4: 如何获取医院的实际坐标？

可以使用以下方法：
1. 在高德地图网页版搜索医院名称
2. 点击医院位置，查看坐标
3. 或者使用高德地图 API 进行地理编码

## 📚 相关文档

- [uni-app 地图组件文档](https://uniapp.dcloud.net.cn/component/map.html)
- [uni.getLocation API](https://uniapp.dcloud.net.cn/api/location/location.html)
- [高德地图开放平台](https://lbs.amap.com/)
- [GCJ-02 坐标系说明](https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%9B%BD%E5%9B%BD%E5%AE%B6%E6%B5%8B%E7%BB%98%E5%B1%80)

## ✅ 已实现功能清单

- [x] 地图组件集成
- [x] GPS位置获取（使用 gcj02 坐标系）
- [x] 位置权限处理
- [x] 地图标记点配置
- [x] 路线绘制
- [x] 定期位置更新
- [x] 室外/室内导航切换
- [x] 错误处理和用户提示

## 🎯 下一步

1. **配置实际医院坐标**：在 `NavigationMain.vue` 中更新 `hospitalLocation`
2. **添加地图图标**：准备并添加标记点图标文件
3. **测试功能**：在真机上测试地图和定位功能
4. **优化体验**：根据实际使用情况优化地图显示和交互




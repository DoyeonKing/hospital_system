# 科室内医生管理功能实现说明

## 功能概述

本功能实现了基于双表科室结构（parent_departments 和 departments）的科室内医生管理，支持查看、添加和移除医生到指定科室。

## 核心设计

### 1. 数据库设计

#### 未分配科室约定
- **父科室表**：ID=999 表示"未分配父科室"
- **子科室表**：ID=999 表示"未分配科室"，parent_id=999
- **医生移除**：将医生的 department_id 更新为 999，而不是删除记录

#### 表结构关系
```
parent_departments (父科室)
├── parent_department_id (主键)
└── name

departments (子科室)
├── department_id (主键)
├── parent_id (外键 -> parent_departments.parent_department_id)
└── name

doctors (医生)
├── doctor_id (主键)
├── department_id (外键 -> departments.department_id)
└── identifier (工号)
```

### 2. 后端实现

#### 新增API接口

1. **获取科室树形数据**
   - `GET /api/departments/tree`
   - 返回树形结构，自动过滤ID=999的节点

2. **获取科室医生列表**
   - `GET /api/departments/{departmentId}/doctors`
   - 返回指定科室下的所有医生

3. **添加医生到科室**
   - `POST /api/departments/{departmentId}/members`
   - 支持创建新医生或更新现有医生的科室

4. **从科室移除医生**
   - `DELETE /api/departments/{departmentId}/members/{doctorIdentifier}`
   - 将医生的department_id设置为999

#### 核心服务方法

```java
// DepartmentService.java
public List<DepartmentTreeDTO> getDepartmentTree()
public List<DoctorResponse> getDoctorsByDepartmentId(Integer departmentId)
public DoctorResponse addDoctorToDepartment(Integer departmentId, DoctorDataDTO doctorData)
public void removeDoctorFromDepartment(Integer departmentId, String doctorIdentifier)
```

### 3. 前端实现

#### 科室管理页面 (Index.vue)
- 使用新的树形数据接口 `/api/departments/tree`
- 自动过滤ID=999的未分配科室节点
- 只有子科室节点显示"查看成员"按钮

#### 医生管理页面 (Members.vue)
- 显示科室下的医生列表
- 支持添加新医生到科室
- 支持从科室移除医生（移动到未分配科室）
- 提供二次确认提示

#### 树形结构过滤
```javascript
// 后端已过滤，前端直接使用
const treeData = computed(() => {
  return allDepartments.value || [];
});
```

## 使用流程

### 1. 查看科室医生
1. 进入科室管理页面
2. 点击子科室节点的"查看成员"按钮
3. 系统跳转到医生管理页面
4. 显示该科室下的所有医生

### 2. 添加医生到科室
1. 在医生管理页面点击"添加成员"
2. 填写医生工号、姓名、职称
3. 系统自动创建医生或更新现有医生的科室信息

### 3. 从科室移除医生
1. 在医生列表中找到要移除的医生
2. 点击"移除"按钮
3. 确认操作后，医生被移动到未分配科室（ID=999）

## 技术特点

### 1. 数据一致性
- 使用外键约束确保数据完整性
- 移除医生时更新department_id而不是删除记录
- 支持医生在不同科室间移动

### 2. 用户体验
- 树形结构清晰展示科室层级关系
- 自动过滤系统内部节点（ID=999）
- 提供二次确认防止误操作

### 3. 扩展性
- 支持批量操作
- 预留搜索和筛选功能接口
- 易于添加新的医生管理功能

## 测试验证

### 1. 数据库测试
执行 `sql语句/04_test_department_management.sql` 验证：
- 未分配科室记录存在
- 医生移动功能正常
- 数据统计准确

### 2. API测试
- 测试树形数据接口返回正确结构
- 验证医生列表接口返回完整信息
- 确认添加/移除操作成功

### 3. 前端测试
- 验证树形组件正确显示
- 测试医生管理页面功能
- 确认用户交互流程顺畅

## 注意事项

1. **数据库初始化**：必须先执行 `sql语句/03_unassigned_departments.sql` 创建未分配科室记录

2. **权限控制**：当前实现未包含权限验证，生产环境需要添加相应的权限控制

3. **错误处理**：所有操作都包含完整的错误处理和用户提示

4. **性能优化**：大量数据时建议添加分页和缓存机制

## 文件清单

### 后端文件
- `DepartmentService.java` - 核心业务逻辑
- `DepartmentController.java` - API接口
- `DepartmentTreeDTO.java` - 树形数据DTO
- `DoctorDataDTO.java` - 医生数据DTO
- `Department.java` - 科室实体（添加了doctors关联）

### 前端文件
- `vue_admin/src/views/departments/Index.vue` - 科室管理页面
- `vue_admin/src/views/departments/Members.vue` - 医生管理页面
- `vue_admin/src/api/department.js` - API接口定义

### 数据库文件
- `sql语句/03_unassigned_departments.sql` - 未分配科室初始化
- `sql语句/04_test_department_management.sql` - 功能测试脚本

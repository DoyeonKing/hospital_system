# 第二周：排班规则与信息配置 - 后端接口文档

## 任务 2.1: 班次与号别管理功能

### 1. 班次管理接口

#### 1.1 获取班次列表
**请求方法**: `GET`  
**请求URL**: `/api/admin/shifts`  
**功能描述**: 获取所有班次信息，支持分页查询

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| page | Integer | 否 | 页码，默认1 |
| size | Integer | 否 | 每页数量，默认10 |
| name | String | 否 | 班次名称（模糊查询） |

**返回结果**:
```json
{
  "code": "200",
  "msg": "获取成功",
  "data": {
    "total": 10,
    "list": [
      {
        "shiftId": 1,
        "name": "上午班",
        "startTime": "08:00:00",
        "endTime": "12:00:00",
        "period": "MORNING",
        "durationMinutes": 240,
        "status": "ACTIVE",
        "createdAt": "2024-01-01T08:00:00",
        "updatedAt": "2024-01-01T08:00:00"
      }
    ]
  }
}
```

#### 1.2 创建班次
**请求方法**: `POST`  
**请求URL**: `/api/admin/shifts`  
**功能描述**: 创建新的班次

**请求体**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| name | String | 是 | 班次名称 |
| startTime | String | 是 | 开始时间 (HH:mm:ss) |
| endTime | String | 是 | 结束时间 (HH:mm:ss) |
| period | String | 是 | 时间段 (MORNING/AFTERNOON/EVENING) |

**返回结果**:
```json
{
  "code": "200",
  "msg": "创建成功",
  "data": {
    "shiftId": 1,
    "name": "上午班",
    "startTime": "08:00:00",
    "endTime": "12:00:00",
    "period": "MORNING",
    "durationMinutes": 240,
    "status": "ACTIVE"
  }
}
```

#### 1.3 更新班次
**请求方法**: `PUT`  
**请求URL**: `/api/admin/shifts/{shiftId}`  
**功能描述**: 更新指定班次信息

**路径参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| shiftId | Integer | 是 | 班次ID |

**请求体**: 同创建班次

#### 1.4 删除班次
**请求方法**: `DELETE`  
**请求URL**: `/api/admin/shifts/{shiftId}`  
**功能描述**: 删除指定班次

### 2. 号别管理接口

#### 2.1 获取号别列表
**请求方法**: `GET`  
**请求URL**: `/api/admin/appointment-types`  
**功能描述**: 获取所有号别信息

**返回结果**:
```json
{
  "code": "200",
  "msg": "获取成功",
  "data": [
    {
      "typeId": 1,
      "name": "专家号",
      "description": "主任医师专家号",
      "fee": 50.00,
      "status": "ACTIVE",
      "createdAt": "2024-01-01T08:00:00"
    },
    {
      "typeId": 2,
      "name": "普通号",
      "description": "主治医师普通号",
      "fee": 15.00,
      "status": "ACTIVE",
      "createdAt": "2024-01-01T08:00:00"
    }
  ]
}
```

#### 2.2 创建号别
**请求方法**: `POST`  
**请求URL**: `/api/admin/appointment-types`  
**功能描述**: 创建新的号别

**请求体**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| name | String | 是 | 号别名称 |
| description | String | 否 | 号别描述 |
| fee | Decimal | 是 | 挂号费用 |
| status | String | 否 | 状态，默认ACTIVE |

#### 2.3 更新号别
**请求方法**: `PUT`  
**请求URL**: `/api/admin/appointment-types/{typeId}`  
**功能描述**: 更新指定号别信息

#### 2.4 删除号别
**请求方法**: `DELETE`  
**请求URL**: `/api/admin/appointment-types/{typeId}`  
**功能描述**: 删除指定号别

## 任务 2.2: 医生账户分配至对应科室

### 1. 单个医生分配科室

#### 1.1 为医生分配科室
**请求方法**: `PUT`  
**请求URL**: `/api/admin/doctors/{doctorId}/assign-department`  
**功能描述**: 为指定医生分配科室

**路径参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| doctorId | Integer | 是 | 医生ID |

**请求体**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| departmentId | Integer | 是 | 科室ID |

**返回结果**:
```json
{
  "code": "200",
  "msg": "分配成功",
  "data": {
    "doctorId": 1,
    "name": "李医生",
    "departmentId": 2,
    "departmentName": "心血管科",
    "updatedAt": "2024-01-01T08:00:00"
  }
}
```

### 2. 批量分配科室

#### 2.1 批量分配医生科室
**请求方法**: `POST`  
**请求URL**: `/api/admin/doctors/bulk-assign`  
**功能描述**: 通过Excel/CSV文件批量分配医生科室

**请求体**: `multipart/form-data`
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| file | File | 是 | Excel或CSV文件 |

**后端处理逻辑**:
1. 后端接收到POST请求后，解析上传的文件
2. 验证文件格式（支持.xlsx, .xls, .csv）
3. 解析文件内容，提取医生工号和科室ID
4. 进行数据校验：
   - 验证医生工号是否存在
   - 验证科室ID是否存在
   - 检查数据完整性
5. 批量更新医生科室关联关系
6. 返回处理结果统计

**返回结果**:
```json
{
  "code": "200",
  "msg": "批量分配完成",
  "data": {
    "totalCount": 100,
    "successCount": 95,
    "failureCount": 5,
    "errors": [
      {
        "row": 3,
        "doctorId": "D999",
        "error": "医生工号不存在"
      },
      {
        "row": 7,
        "doctorId": "D888",
        "error": "科室ID不存在"
      }
    ]
  }
}
```

## 任务 2.3: 挂号费用收取规则

### 1. 费用规则管理接口

#### 1.1 获取费用规则列表
**请求方法**: `GET`  
**请求URL**: `/api/admin/fee-rules`  
**功能描述**: 获取所有费用规则

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| departmentId | Integer | 否 | 科室ID |
| doctorId | Integer | 否 | 医生ID |
| appointmentTypeId | Integer | 否 | 号别ID |

**返回结果**:
```json
{
  "code": "200",
  "msg": "获取成功",
  "data": [
    {
      "ruleId": 1,
      "departmentId": 2,
      "departmentName": "心血管科",
      "doctorId": 1,
      "doctorName": "李医生",
      "appointmentTypeId": 1,
      "appointmentTypeName": "专家号",
      "fee": 50.00,
      "status": "ACTIVE",
      "createdAt": "2024-01-01T08:00:00"
    }
  ]
}
```

#### 1.2 创建费用规则
**请求方法**: `POST`  
**请求URL**: `/api/admin/fee-rules`  
**功能描述**: 创建新的费用规则

**请求体**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| departmentId | Integer | 否 | 科室ID（科室级别规则） |
| doctorId | Integer | 否 | 医生ID（医生级别规则） |
| appointmentTypeId | Integer | 是 | 号别ID |
| fee | Decimal | 是 | 挂号费用 |
| status | String | 否 | 状态，默认ACTIVE |

**后端处理逻辑**:
1. 后端接收到POST请求后，解析请求体中的JSON数据
2. 对所有必需参数进行严格的非空校验
3. 进行业务逻辑校验：
   - 验证科室ID是否存在（如果提供）
   - 验证医生ID是否存在（如果提供）
   - 验证号别ID是否存在
   - 检查费用规则是否已存在（避免重复）
4. 创建费用规则记录
5. 返回创建成功的费用规则信息

**返回结果**:
```json
{
  "code": "200",
  "msg": "创建成功",
  "data": {
    "ruleId": 1,
    "departmentId": 2,
    "doctorId": null,
    "appointmentTypeId": 1,
    "fee": 50.00,
    "status": "ACTIVE",
    "createdAt": "2024-01-01T08:00:00"
  }
}
```

#### 1.3 更新费用规则
**请求方法**: `PUT`  
**请求URL**: `/api/admin/fee-rules/{ruleId}`  
**功能描述**: 更新指定费用规则

#### 1.4 删除费用规则
**请求方法**: `DELETE`  
**请求URL**: `/api/admin/fee-rules/{ruleId}`  
**功能描述**: 删除指定费用规则

## 任务 2.4: 管理就医规范功能

### 1. 就医规范管理接口

#### 1.1 获取就医规范
**请求方法**: `GET`  
**请求URL**: `/api/guidelines`  
**功能描述**: 获取当前生效的就医规范内容（患者端和管理端共用）

**返回结果**:
```json
{
  "code": "200",
  "msg": "获取成功",
  "data": {
    "guidelineId": 1,
    "title": "就医规范",
    "content": "<h1>就医规范</h1><p>请遵守以下就医规范...</p>",
    "version": "1.0",
    "status": "ACTIVE",
    "lastUpdated": "2024-01-01T08:00:00",
    "updatedBy": "管理员"
  }
}
```

#### 1.2 保存就医规范
**请求方法**: `PUT`  
**请求URL**: `/api/admin/guidelines`  
**功能描述**: 保存更新后的就医规范内容（管理端专用）

**请求体**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| title | String | 是 | 规范标题 |
| content | String | 是 | 规范内容（HTML格式） |
| version | String | 否 | 版本号，默认自动生成 |

**后端处理逻辑**:
1. 后端接收到PUT请求后，解析请求体中的JSON数据
2. 对所有必需参数进行严格的非空校验
3. 进行业务逻辑校验：
   - 验证内容长度是否在合理范围内
   - 验证HTML内容格式是否正确
4. 保存或更新就医规范内容到数据库
5. 记录操作日志和版本信息
6. 返回保存成功的规范信息

**返回结果**:
```json
{
  "code": "200",
  "msg": "保存成功",
  "data": {
    "guidelineId": 1,
    "title": "就医规范",
    "content": "<h1>就医规范</h1><p>请遵守以下就医规范...</p>",
    "version": "1.1",
    "status": "ACTIVE",
    "lastUpdated": "2024-01-01T08:00:00",
    "updatedBy": "管理员"
  }
}
```

#### 1.3 获取规范历史版本
**请求方法**: `GET`  
**请求URL**: `/api/admin/guidelines/history`  
**功能描述**: 获取就医规范的历史版本记录

**返回结果**:
```json
{
  "code": "200",
  "msg": "获取成功",
  "data": [
    {
      "guidelineId": 1,
      "title": "就医规范",
      "version": "1.1",
      "lastUpdated": "2024-01-01T08:00:00",
      "updatedBy": "管理员"
    },
    {
      "guidelineId": 1,
      "title": "就医规范",
      "version": "1.0",
      "lastUpdated": "2023-12-01T08:00:00",
      "updatedBy": "管理员"
    }
  ]
}
```

## 数据库表结构补充

### 1. 班次表 (shifts)
```sql
CREATE TABLE shifts (
    shift_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '班次名称',
    start_time TIME NOT NULL COMMENT '开始时间',
    end_time TIME NOT NULL COMMENT '结束时间',
    period ENUM('MORNING', 'AFTERNOON', 'EVENING') NOT NULL COMMENT '时间段',
    duration_minutes INT NOT NULL COMMENT '持续分钟数',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2. 号别表 (appointment_types)
```sql
CREATE TABLE appointment_types (
    type_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '号别名称',
    description TEXT COMMENT '号别描述',
    fee DECIMAL(10,2) NOT NULL COMMENT '挂号费用',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3. 费用规则表 (fee_rules)
```sql
CREATE TABLE fee_rules (
    rule_id INT PRIMARY KEY AUTO_INCREMENT,
    department_id INT COMMENT '科室ID（科室级别规则）',
    doctor_id INT COMMENT '医生ID（医生级别规则）',
    appointment_type_id INT NOT NULL COMMENT '号别ID',
    fee DECIMAL(10,2) NOT NULL COMMENT '挂号费用',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (department_id) REFERENCES departments(department_id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id),
    FOREIGN KEY (appointment_type_id) REFERENCES appointment_types(type_id)
);
```

### 4. 就医规范表 (guidelines)
```sql
CREATE TABLE guidelines (
    guideline_id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL COMMENT '规范标题',
    content LONGTEXT NOT NULL COMMENT '规范内容（HTML格式）',
    version VARCHAR(20) NOT NULL COMMENT '版本号',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    updated_by VARCHAR(100) COMMENT '最后更新人'
);
```

## 错误码说明

| 错误码 | 描述 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权访问 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 409 | 数据冲突（如重复创建） |
| 500 | 服务器内部错误 |

## 注意事项

1. 所有接口都需要管理员权限验证
2. 批量导入功能需要支持Excel和CSV两种格式
3. 费用规则支持多层级：全局规则 > 科室规则 > 医生规则
4. 就医规范支持富文本编辑，需要HTML格式存储
5. 所有删除操作需要软删除，保留历史记录
6. 接口返回时间统一使用ISO 8601格式

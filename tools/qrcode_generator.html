<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»é™¢å¯¼èˆªäºŒç»´ç ç”Ÿæˆå™¨</title>
    <!-- å¤šä¸ªCDNå¤‡ç”¨æºï¼Œç¡®ä¿åº“èƒ½åŠ è½½ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" onerror="loadQRCodeFallback()"></script>
    <script>
        // å¤‡ç”¨CDNåŠ è½½å‡½æ•°
        function loadQRCodeFallback() {
            console.log('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js';
            script.onload = function() {
                console.log('âœ… å¤‡ç”¨CDN1åŠ è½½æˆåŠŸ');
                window.QRCodeFallback = false; // ç¡®ä¿æ ‡è®°ä¸ºå·²åŠ è½½
            };
            script.onerror = function() {
                console.log('å¤‡ç”¨CDN1å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN2...');
                const script2 = document.createElement('script');
                script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js';
                script2.onload = function() {
                    console.log('âœ… å¤‡ç”¨CDN2åŠ è½½æˆåŠŸ');
                    window.QRCodeFallback = false; // ç¡®ä¿æ ‡è®°ä¸ºå·²åŠ è½½
                };
                script2.onerror = function() {
                    console.warn('âš ï¸ æ‰€æœ‰CDNéƒ½åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨åœ¨çº¿APIä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
                    // å»¶è¿Ÿè®¾ç½®fallbackï¼Œç»™æ›´å¤šæ—¶é—´è®©è„šæœ¬åŠ è½½
                    setTimeout(function() {
                        if (typeof QRCode === 'undefined') {
                            window.QRCodeFallback = true;
                            console.log('å·²åˆ‡æ¢åˆ°åœ¨çº¿APIæ¨¡å¼');
                        }
                    }, 1000);
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .qrcode-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .qrcode-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .qrcode-item h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .qrcode-item .content {
            color: #666;
            font-size: 12px;
            margin-bottom: 15px;
            word-break: break-all;
            padding: 5px;
            background: white;
            border-radius: 5px;
        }
        
        .qrcode-item canvas {
            width: 150px;
            height: 150px;
            margin: 10px auto;
            display: block;
            border: 5px solid white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .qrcode-item .loading {
            width: 150px;
            height: 150px;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 10px;
            color: #666;
        }
        
        .download-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .download-btn:hover {
            background: #5568d3;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .instructions h2 {
            color: #1976D2;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
            line-height: 2;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .custom-generator {
            background: #fff3e0;
            border-left: 4px solid #FF9800;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .custom-generator h2 {
            color: #F57C00;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #FF9800;
        }
        
        .generate-btn {
            padding: 12px 30px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .generate-btn:hover {
            background: #F57C00;
        }
        
        .custom-result {
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ åŒ»é™¢å¯¼èˆªäºŒç»´ç ç”Ÿæˆå™¨</h1>
        <p class="subtitle">ç”Ÿæˆå®šä½äºŒç»´ç ï¼Œç”¨äºæ‰«ç å®šä½åŠŸèƒ½ï¼ˆä»æ•°æ®åº“çœŸå®ä½ç½®æ•°æ®ç”Ÿæˆï¼‰</p>
        
        <!-- APIåœ°å€æ˜¾ç¤º -->
        <div id="apiInfo" style="text-align: center; margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 5px;">
            <strong>å½“å‰APIåœ°å€ï¼š</strong><span id="currentApiUrl" style="color: #1976D2; font-family: monospace;">åŠ è½½ä¸­...</span>
            <br><small style="color: #666;">ğŸ’¡ å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç¼–è¾‘HTMLæ–‡ä»¶ä¸­çš„ <code>API_BASE_URL</code> å˜é‡</small>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="generate-btn" onclick="refreshLocations()" style="background: #28a745;">
                ğŸ”„ åˆ·æ–°ä½ç½®æ•°æ®ï¼ˆä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼‰
            </button>
        </div>
        
        <div class="nodes-grid" id="qrcodeGrid">
            <!-- äºŒç»´ç å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="custom-generator">
            <h2>ğŸ“ è‡ªå®šä¹‰äºŒç»´ç ç”Ÿæˆ</h2>
            <div class="input-group">
                <label>èŠ‚ç‚¹IDï¼ˆmap_node_idï¼‰ï¼š</label>
                <input type="number" id="customNodeId" placeholder="ä¾‹å¦‚: 5ï¼ˆå¯¹åº”æ•°æ®åº“ä¸­çš„map_node_idï¼‰" min="1">
            </div>
            <div class="input-group">
                <label>ä½ç½®åç§°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                <input type="text" id="customNodeName" placeholder="ä¾‹å¦‚: é—¨è¯Šæ¥¼201å®¤ï¼ˆå¦‚æœä¸å¡«ï¼Œå°†ä½¿ç”¨'èŠ‚ç‚¹ID'ï¼‰">
            </div>
            <button class="generate-btn" onclick="generateCustomQR()">ç”ŸæˆäºŒç»´ç </button>
            <div class="custom-result" id="customResult"></div>
        </div>
        
        <div class="instructions">
            <h2>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h2>
            <ol>
                <li><strong>ç‚¹å‡»"ä¸‹è½½"æŒ‰é’®</strong>ä¿å­˜äºŒç»´ç å›¾ç‰‡</li>
                <li><strong>æ‰“å°äºŒç»´ç </strong>ï¼ˆå»ºè®®å°ºå¯¸ï¼š5cm Ã— 5cm æˆ–æ›´å¤§ï¼‰</li>
                <li><strong>åœ¨åŒ»é™¢å¯¹åº”ä½ç½®å¼ è´´</strong>ï¼ˆé«˜åº¦ï¼š1.5-2ç±³ï¼‰</li>
                <li>åœ¨å¯¼èˆªé¡µé¢ç‚¹å‡»<strong>"ğŸ“· æ‰«ç å®šä½"</strong>æ‰«æäºŒç»´ç </li>
                <li>ç³»ç»Ÿä¼šè‡ªåŠ¨å®šä½åˆ°å¯¹åº”ä½ç½®</li>
            </ol>
        </div>
    </div>
    
    <script>
        // ==================== APIé…ç½®åŒºåŸŸ ====================
        // ğŸ‘‡ è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹åç«¯APIåœ°å€
        // âœ… å½“å‰é…ç½®ï¼šæœ¬åœ°åç«¯ï¼ˆåç«¯è¿è¡Œåœ¨æœ¬åœ°ï¼Œæ•°æ®åº“åœ¨åä¸ºäº‘ï¼‰
        // æœ¬åœ°å¼€å‘ï¼šhttp://localhost:8080  â† å½“å‰ä½¿ç”¨ï¼ˆåç«¯æœåŠ¡åœ¨æœ¬åœ°ï¼‰
        // åä¸ºäº‘æœåŠ¡å™¨ï¼šhttp://123.249.30.241:8080ï¼ˆå¦‚æœåç«¯è¿è¡Œåœ¨åä¸ºäº‘ä¸Šï¼‰
        // å±€åŸŸç½‘IPï¼šhttp://172.20.10.3:8080ï¼ˆçœŸæœºè°ƒè¯•æ—¶ä½¿ç”¨ï¼‰
        // 
        // ğŸ’¡ è¯´æ˜ï¼š
        //    - åç«¯æœåŠ¡è¿è¡Œåœ¨æœ¬åœ°ï¼šlocalhost:8080
        //    - æ•°æ®åº“åœ¨åä¸ºäº‘ï¼š123.249.30.241:3306
        //    - HTMLæ–‡ä»¶åº”è¯¥è¿æ¥æœ¬åœ°åç«¯ï¼ˆä¸å°ç¨‹åºé…ç½®ä¸€è‡´ï¼‰
        const API_BASE_URL = 'http://localhost:8080';  // ğŸ‘ˆ æœ¬åœ°åç«¯åœ°å€ï¼ˆåç«¯åœ¨æœ¬åœ°ï¼Œæ•°æ®åº“åœ¨åä¸ºäº‘ï¼‰
        
        // ä»æ•°æ®åº“è·å–çš„èŠ‚ç‚¹åˆ—è¡¨ï¼ˆå°†ä»APIåŠ è½½ï¼‰
        let nodes = [];
        
        // ä»åç«¯APIè·å–æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ï¼ˆåŒ…æ‹¬locationå’Œé€”å¾„ç‚¹ï¼‰
        async function loadLocationsFromAPI() {
            try {
                console.log('å¼€å§‹ä»APIåŠ è½½èŠ‚ç‚¹æ•°æ®...');
                console.log('APIåœ°å€:', API_BASE_URL);
                
                // 1. è·å–æ‰€æœ‰locationï¼ˆç›®çš„åœ°ï¼‰
                const locationsUrl = `${API_BASE_URL}/api/locations`;
                console.log('æ­£åœ¨è¯·æ±‚:', locationsUrl);
                const locationResponse = await fetch(locationsUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors' // æ˜ç¡®æŒ‡å®šCORSæ¨¡å¼
                });
                
                console.log('Location APIå“åº”çŠ¶æ€:', locationResponse.status, locationResponse.statusText);
                
                let locationNodes = [];
                if (locationResponse.ok) {
                    const locations = await locationResponse.json();
                    console.log('è·å–åˆ°locationsæ•°é‡:', locations.length);
                    locationNodes = locations
                        .filter(loc => loc.mapNodeId != null && loc.mapNodeId > 0)
                        .map(loc => ({
                            nodeId: loc.mapNodeId,
                            name: loc.locationName || `${loc.building || ''}${loc.roomNumber || ''}`.trim() || `ä½ç½®${loc.locationId}`,
                            locationId: loc.locationId,
                            building: loc.building,
                            roomNumber: loc.roomNumber,
                            floorLevel: loc.floorLevel,
                            nodeType: 'ROOM',
                            typeName: 'è¯Šå®¤'
                        }));
                } else {
                    console.warn('Location APIè¿”å›é”™è¯¯çŠ¶æ€:', locationResponse.status);
                    const errorText = await locationResponse.text();
                    console.warn('é”™è¯¯è¯¦æƒ…:', errorText);
                }
                
                // 2. è·å–æ‰€æœ‰é€”å¾„ç‚¹ï¼ˆèµ°å»Šã€ç”µæ¢¯ã€æ¥¼æ¢¯ç­‰ï¼‰
                const waypointsUrl = `${API_BASE_URL}/api/map/nodes/waypoints`;
                console.log('æ­£åœ¨è¯·æ±‚:', waypointsUrl);
                const waypointResponse = await fetch(waypointsUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors' // æ˜ç¡®æŒ‡å®šCORSæ¨¡å¼
                });
                
                console.log('Waypoint APIå“åº”çŠ¶æ€:', waypointResponse.status, waypointResponse.statusText);
                
                let waypointNodes = [];
                if (waypointResponse.ok) {
                    const result = await waypointResponse.json();
                    console.log('Waypoint APIè¿”å›:', result);
                    if (result.code === '200' && result.data) {
                        waypointNodes = result.data.map(node => ({
                            nodeId: node.nodeId,
                            name: node.nodeName,
                            nodeType: node.nodeType || 'HALLWAY',
                            typeName: getNodeTypeName(node.nodeType),
                            floorLevel: node.floorLevel,
                            coordinatesX: node.coordinatesX,
                            coordinatesY: node.coordinatesY
                        }));
                    }
                } else {
                    console.warn('Waypoint APIè¿”å›é”™è¯¯çŠ¶æ€:', waypointResponse.status);
                    const errorText = await waypointResponse.text();
                    console.warn('é”™è¯¯è¯¦æƒ…:', errorText);
                }
                
                // 3. åˆå¹¶æ‰€æœ‰èŠ‚ç‚¹
                nodes = [...locationNodes, ...waypointNodes];
                
                console.log(`æˆåŠŸåŠ è½½ ${locationNodes.length} ä¸ªç›®çš„åœ°èŠ‚ç‚¹å’Œ ${waypointNodes.length} ä¸ªé€”å¾„ç‚¹`);
                return true;
            } catch (error) {
                console.error('ä»APIåŠ è½½èŠ‚ç‚¹æ•°æ®å¤±è´¥:', error);
                console.error('é”™è¯¯ç±»å‹:', error.name);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMsg = 'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = `âŒ åç«¯æœåŠ¡æœªè¿è¡Œæˆ–æ— æ³•è¿æ¥\n\nå½“å‰APIåœ°å€: ${API_BASE_URL}\n\nè¯·æ£€æŸ¥ï¼š\n1. Spring BootæœåŠ¡æ˜¯å¦åœ¨è¿è¡Œ\n2. APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆå½“å‰: ${API_BASE_URL}ï¼‰\n3. é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†è¿æ¥\n4. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰CORSé”™è¯¯\n\nğŸ’¡ æç¤ºï¼šå¦‚éœ€ä¿®æ”¹APIåœ°å€ï¼Œè¯·ç¼–è¾‘HTMLæ–‡ä»¶ä¸­çš„ API_BASE_URL å˜é‡`;
                } else if (error.message.includes('CORS')) {
                    errorMsg = `âŒ CORSè·¨åŸŸé”™è¯¯\n\nå½“å‰APIåœ°å€: ${API_BASE_URL}\n\nè¯·æ£€æŸ¥åç«¯CORSé…ç½®`;
                } else {
                    errorMsg = `âŒ é”™è¯¯: ${error.message}\n\nå½“å‰APIåœ°å€: ${API_BASE_URL}`;
                }
                
                // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç¤ºä¾‹æ•°æ®
                nodes = [
                    {nodeId: 1, name: "åŒ»é™¢å¤§é—¨", nodeType: 'ENTRANCE', typeName: 'å…¥å£'},
                    {nodeId: 2, name: "åˆ†è¯Šå°", nodeType: 'HALLWAY', typeName: 'èµ°å»Š'},
                    {nodeId: 3, name: "ç”µæ¢¯å£", nodeType: 'ELEVATOR', typeName: 'ç”µæ¢¯'},
                    {nodeId: 4, name: "å†…ç§‘è¯Šå®¤", nodeType: 'ROOM', typeName: 'è¯Šå®¤'},
                    {nodeId: 5, name: "å¤–ç§‘è¯Šå®¤", nodeType: 'ROOM', typeName: 'è¯Šå®¤'},
                ];
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                alert(errorMsg);
                return false;
            }
        }
        
        // è·å–èŠ‚ç‚¹ç±»å‹çš„ä¸­æ–‡åç§°
        function getNodeTypeName(nodeType) {
            const typeMap = {
                'ROOM': 'è¯Šå®¤',
                'HALLWAY': 'èµ°å»Š',
                'ELEVATOR': 'ç”µæ¢¯',
                'STAIRS': 'æ¥¼æ¢¯',
                'ENTRANCE': 'å…¥å£'
            };
            return typeMap[nodeType] || 'æœªçŸ¥';
        }
        
        // ä¸‹è½½äºŒç»´ç å›¾ç‰‡
        function downloadQRCode(canvas, filename) {
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/png');
        }
        
        // ä½¿ç”¨åœ¨çº¿APIç”ŸæˆäºŒç»´ç ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function generateQRCodeWithAPI(node, container) {
            const content = `HOSPITAL_NODE_${node.nodeId}`;
            const QR_API = "https://api.qrserver.com/v1/create-qr-code/";
            
            // åˆ›å»ºå®¹å™¨
            const item = document.createElement('div');
            item.className = 'qrcode-item';
            
            // æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = node.name;
            item.appendChild(title);
            
            // å†…å®¹æ˜¾ç¤º
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            contentDiv.textContent = content;
            item.appendChild(contentDiv);
            
            // ä½¿ç”¨imgæ ‡ç­¾åŠ è½½åœ¨çº¿APIç”Ÿæˆçš„äºŒç»´ç 
            const img = document.createElement('img');
            img.style.width = '150px';
            img.style.height = '150px';
            img.style.margin = '10px auto';
            img.style.display = 'block';
            img.style.border = '5px solid white';
            img.style.borderRadius = '10px';
            img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
            img.src = `${QR_API}?size=200x200&data=${encodeURIComponent(content)}`;
            img.alt = node.name;
            img.onerror = function() {
                item.innerHTML = '<div style="color: #dc3545; padding: 20px;">âŒ äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            };
            item.appendChild(img);
            
            // ä¸‹è½½æŒ‰é’®ï¼ˆä½¿ç”¨åœ¨çº¿APIçš„é«˜æ¸…ç‰ˆæœ¬ï¼‰
            const downloadBtn = document.createElement('a');
            downloadBtn.className = 'download-btn';
            downloadBtn.href = `${QR_API}?size=500x500&data=${encodeURIComponent(content)}`;
            downloadBtn.download = `qrcode_${node.nodeId}_${node.name}.png`;
            downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è½½äºŒç»´ç ';
            item.appendChild(downloadBtn);
            
            container.appendChild(item);
        }
        
        // ç”Ÿæˆå•ä¸ªäºŒç»´ç ï¼ˆä¼˜å…ˆä½¿ç”¨æœ¬åœ°åº“ï¼‰
        function generateQRCode(node, container) {
            const content = `HOSPITAL_NODE_${node.nodeId}`;
            
            // å¦‚æœQRCodeåº“æœªåŠ è½½ï¼Œä½¿ç”¨åœ¨çº¿API
            if (typeof QRCode === 'undefined' || window.QRCodeFallback) {
                generateQRCodeWithAPI(node, container);
                return;
            }
            
            // åˆ›å»ºå®¹å™¨
            const item = document.createElement('div');
            item.className = 'qrcode-item';
            
            // æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = node.name;
            item.appendChild(title);
            
            // å†…å®¹æ˜¾ç¤º
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            contentDiv.textContent = content;
            item.appendChild(contentDiv);
            
            // åŠ è½½æç¤º
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.textContent = 'ç”Ÿæˆä¸­...';
            item.appendChild(loading);
            
            // åˆ›å»ºcanvas
            const canvas = document.createElement('canvas');
            canvas.style.display = 'none';
            item.appendChild(canvas);
            
            // ç”ŸæˆäºŒç»´ç 
            try {
                QRCode.toCanvas(canvas, content, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) {
                        // å¦‚æœæœ¬åœ°ç”Ÿæˆå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åœ¨çº¿API
                        item.remove();
                        generateQRCodeWithAPI(node, container);
                        return;
                    }
                    
                    // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºcanvas
                    loading.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    // ä¸‹è½½æŒ‰é’®
                    const downloadBtn = document.createElement('a');
                    downloadBtn.className = 'download-btn';
                    downloadBtn.href = '#';
                    downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è½½äºŒç»´ç ';
                    downloadBtn.onclick = function(e) {
                        e.preventDefault();
                        downloadQRCode(canvas, `qrcode_${node.nodeId}_${node.name}.png`);
                    };
                    item.appendChild(downloadBtn);
                });
            } catch (error) {
                // å¦‚æœå‡ºé”™ï¼Œä½¿ç”¨åœ¨çº¿API
                item.remove();
                generateQRCodeWithAPI(node, container);
                return;
            }
            
            container.appendChild(item);
        }
        
        // ç”Ÿæˆæ‰€æœ‰äºŒç»´ç 
        function generateAllQRCodes() {
            const grid = document.getElementById('qrcodeGrid');
            grid.innerHTML = '';
            
            nodes.forEach((node, index) => {
                setTimeout(() => {
                    generateQRCode(node, grid);
                }, index * 100);
            });
        }
        
        // ç”Ÿæˆè‡ªå®šä¹‰äºŒç»´ç 
        async function generateCustomQR() {
            const nodeId = document.getElementById('customNodeId').value;
            const nodeName = document.getElementById('customNodeName').value;
            const resultDiv = document.getElementById('customResult');
            
            if (!nodeId) {
                alert('è¯·å¡«å†™èŠ‚ç‚¹IDï¼ˆmap_node_idï¼‰');
                return;
            }
            
            resultDiv.innerHTML = '';
            
            const node = {
                nodeId: parseInt(nodeId), 
                name: nodeName || `èŠ‚ç‚¹${nodeId}`
            };
            generateQRCode(node, resultDiv);
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('customNodeId').value = '';
            document.getElementById('customNodeName').value = '';
        }
        
        // åˆ·æ–°æŒ‰é’®ï¼šé‡æ–°ä»APIåŠ è½½æ•°æ®
        async function refreshLocations() {
            const grid = document.getElementById('qrcodeGrid');
            grid.innerHTML = '<div style="text-align: center; padding: 20px;">æ­£åœ¨ä»æ•°æ®åº“é‡æ–°åŠ è½½ä½ç½®æ•°æ®...</div>';
            
            const apiLoaded = await loadLocationsFromAPI();
            if (apiLoaded) {
                grid.innerHTML = '<div style="text-align: center; padding: 10px; color: #28a745; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; margin: 20px 0;">' +
                    `âœ… å·²ä»æ•°æ®åº“åŠ è½½ ${nodes.length} ä¸ªçœŸå®ä½ç½®èŠ‚ç‚¹</div>`;
                generateAllQRCodes();
            } else {
                grid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ</div>';
            }
        }
        
        // ç§»é™¤é¡µé¢åŠ è½½æ—¶çš„alertï¼ˆå¤ªçƒ¦äººï¼‰
        // ä¹‹å‰çš„alertå·²ç§»é™¤ï¼Œæ”¹ä¸ºåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæç¤º
        
        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆæ‰€æœ‰äºŒç»´ç 
        async function init() {
            // æ˜¾ç¤ºå½“å‰APIåœ°å€
            document.getElementById('currentApiUrl').textContent = API_BASE_URL;
            
            // å…ˆå°è¯•ä»APIåŠ è½½çœŸå®æ•°æ®
            const apiLoaded = await loadLocationsFromAPI();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const grid = document.getElementById('qrcodeGrid');
            if (!apiLoaded) {
                grid.innerHTML = `<div style="text-align: center; padding: 20px; color: #856404; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; margin: 20px 0;">` +
                    `âš ï¸ æ— æ³•è¿æ¥åˆ°åç«¯API (${API_BASE_URL})ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®ã€‚è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œã€‚<br>` +
                    `ğŸ’¡ å¦‚éœ€ä¿®æ”¹APIåœ°å€ï¼Œè¯·ç¼–è¾‘HTMLæ–‡ä»¶ä¸­çš„ <strong>API_BASE_URL</strong> å˜é‡</div>`;
            } else {
                grid.innerHTML = '<div style="text-align: center; padding: 10px; color: #28a745; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; margin: 20px 0;">' +
                    `âœ… å·²ä»æ•°æ®åº“åŠ è½½ ${nodes.length} ä¸ªçœŸå®ä½ç½®èŠ‚ç‚¹</div>`;
            }
            
            // ç­‰å¾…ä¸€ä¸‹ï¼Œè®©CDNæœ‰æ—¶é—´åŠ è½½ï¼ˆå¢åŠ åˆ°2ç§’ï¼Œç»™CDNæ›´å¤šæ—¶é—´ï¼‰
            setTimeout(function() {
                // æ£€æŸ¥äºŒç»´ç åº“æ˜¯å¦åŠ è½½æˆåŠŸ
                const qrCodeLoaded = typeof QRCode !== 'undefined';
                const usingFallback = window.QRCodeFallback === true;
                
                // å³ä½¿åº“æœªåŠ è½½ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨çº¿APIç”Ÿæˆ
                generateAllQRCodes();
                
                // å¦‚æœåº“æœªåŠ è½½ä¸”å·²åˆ‡æ¢åˆ°å¤‡ç”¨æ–¹æ¡ˆï¼Œæ˜¾ç¤ºæç¤ºï¼ˆä½†ä¸é˜»æ­¢ä½¿ç”¨ï¼‰
                if (!qrCodeLoaded && usingFallback) {
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; color: #856404;';
                    statusDiv.innerHTML = 'âš ï¸ æœ¬åœ°äºŒç»´ç åº“åŠ è½½å¤±è´¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°åœ¨çº¿APIç”Ÿæˆæ¨¡å¼ã€‚åŠŸèƒ½æ­£å¸¸ï¼Œä½†éœ€è¦ç½‘ç»œè¿æ¥ã€‚';
                    document.querySelector('.container').insertBefore(statusDiv, document.getElementById('qrcodeGrid'));
                } else if (!qrCodeLoaded) {
                    // å¦‚æœåº“æœªåŠ è½½ä½†è¿˜æ²¡è®¾ç½®fallbackï¼Œå¯èƒ½æ˜¯åŠ è½½æ—¶é—´ä¸å¤Ÿï¼Œå†ç­‰ä¸€ä¼š
                    setTimeout(function() {
                        if (typeof QRCode === 'undefined' && window.QRCodeFallback !== true) {
                            // æœ€ç»ˆç¡®è®¤åŠ è½½å¤±è´¥
                            window.QRCodeFallback = true;
                            const statusDiv = document.createElement('div');
                            statusDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; color: #856404;';
                            statusDiv.innerHTML = 'âš ï¸ æœ¬åœ°äºŒç»´ç åº“åŠ è½½å¤±è´¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°åœ¨çº¿APIç”Ÿæˆæ¨¡å¼ã€‚åŠŸèƒ½æ­£å¸¸ï¼Œä½†éœ€è¦ç½‘ç»œè¿æ¥ã€‚';
                            document.querySelector('.container').insertBefore(statusDiv, document.getElementById('qrcodeGrid'));
                        }
                    }, 2000); // å†ç­‰2ç§’
                }
            }, 2000); // å¢åŠ åˆ°2ç§’ï¼Œç»™CDNæ›´å¤šæ—¶é—´åŠ è½½
        }
        
        // ç­‰å¾…é¡µé¢å’Œåº“éƒ½åŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>






# åŠ å·åŠŸèƒ½å®ç°å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è¡¨ç»“æ„è°ƒæ•´ âœ…
**æ–‡ä»¶**: `sqlè¯­å¥/ä¿®æ”¹è¯­å¥/15_add_add_on_fields.sql`

#### ä¿®æ”¹å†…å®¹ï¼š
1. **schedules è¡¨**
   - `is_add_on_slot` - æ ‡è®°ä¸ºåŠ å·è™šæ‹Ÿå·æº
   - `reserved_for_patient_id` - é”å®šç»™ç‰¹å®šæ‚£è€…
   - `slot_application_id` - å…³è”åŠ å·ç”³è¯·ID

2. **appointments è¡¨**
   - `payment_deadline` - æ”¯ä»˜æˆªæ­¢æ—¶é—´ï¼ˆå…³é”®å­—æ®µï¼‰

3. **slot_application è¡¨**
   - `appointment_id` - å…³è”ç”Ÿæˆçš„é¢„çº¦ID

---

### ç¬¬äºŒæ­¥ï¼šå®ä½“ç±»è°ƒæ•´ âœ…

#### 1. Schedule.java
```java
private Boolean isAddOnSlot = false;
private Long reservedForPatientId;
private Integer slotApplicationId;
```

#### 2. Appointment.java
```java
private LocalDateTime paymentDeadline; // æ”¯ä»˜æˆªæ­¢æ—¶é—´
```

#### 3. SlotApplication.java
```java
private Integer appointmentId; // å…³è”ç”Ÿæˆçš„é¢„çº¦è®°å½•ID
```

---

### ç¬¬ä¸‰æ­¥ï¼šRepositoryå±‚ âœ…

#### AppointmentRepository.java
æ–°å¢æ–¹æ³•ï¼š
```java
// æŸ¥è¯¢è¶…æ—¶æœªæ”¯ä»˜çš„åŠ å·é¢„çº¦
List<Appointment> findExpiredAddOnPayments(
    AppointmentType appointmentType,
    AppointmentStatus status,
    LocalDateTime now
);

// æ ¹æ®é¢„çº¦ç±»å‹å’ŒçŠ¶æ€æŸ¥è¯¢
List<Appointment> findByAppointmentTypeAndStatus(
    AppointmentType appointmentType, 
    AppointmentStatus status
);
```

---

### ç¬¬å››æ­¥ï¼šServiceå±‚ âœ…

#### 1. AddOnSlotService.javaï¼ˆæ–°å»ºï¼‰â­
**æ ¸å¿ƒæœåŠ¡**ï¼Œå¤„ç†åŠ å·å®¡æ‰¹é€šè¿‡åçš„å®Œæ•´æµç¨‹ï¼š

```java
@Transactional
public Appointment processApprovedAddOn(SlotApplication application, Integer approverId) {
    // 1. æ›´æ–°ç”³è¯·çŠ¶æ€
    // 2. åˆ›å»ºè™šæ‹Ÿå·æºï¼ˆlockedçŠ¶æ€ï¼Œé”å®šç»™ç‰¹å®šæ‚£è€…ï¼‰
    // 3. è‡ªåŠ¨ç”Ÿæˆé¢„çº¦è®°å½•ï¼ˆPENDING_PAYMENTçŠ¶æ€ï¼‰
    // 4. è®¾ç½®æ”¯ä»˜æˆªæ­¢æ—¶é—´ï¼ˆNOW() + 24å°æ—¶ï¼‰
    // 5. å‘é€é€šçŸ¥ï¼ˆåŒ»ç”Ÿ + æ‚£è€…ï¼‰
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… å‚è€ƒå€™è¡¥çš„`notification_sent_at`æ¨¡å¼
- âœ… ä½¿ç”¨`payment_deadline`å­—æ®µ
- âœ… æ”¯ä»˜æœŸé™ï¼š24å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- âœ… äº‹åŠ¡ç®¡ç†ç¡®ä¿åŸå­æ€§

#### 2. SlotApplicationService.javaï¼ˆä¿®æ”¹ï¼‰
é›†æˆAddOnSlotServiceï¼š
```java
@Transactional
public SlotApplicationResponse updateSlotApplication(Integer id, SlotApplicationUpdateRequest request) {
    if (request.getStatus() == SlotApplicationStatus.APPROVED) {
        // è°ƒç”¨AddOnSlotServiceå¤„ç†å®Œæ•´æµç¨‹
        Appointment appointment = addOnSlotService.processApprovedAddOn(application, request.getApproverId());
    }
    // ...
}
```

---

### ç¬¬äº”æ­¥ï¼šå®šæ—¶ä»»åŠ¡ âœ…

#### AddOnPaymentExpirationTask.javaï¼ˆæ–°å»ºï¼‰â­
**å‚è€ƒ**: `WaitlistExpirationTask`

```java
@Scheduled(fixedRate = 60000) // æ¯60ç§’æ‰§è¡Œä¸€æ¬¡
@Transactional
public void checkExpiredAddOnPayments() {
    // 1. æŸ¥è¯¢ payment_deadline < NOW() çš„åŠ å·é¢„çº¦
    // 2. å–æ¶ˆé¢„çº¦ï¼ˆstatus = CANCELLEDï¼‰
    // 3. é‡Šæ”¾è™šæ‹Ÿå·æºï¼ˆstatus = cancelledï¼‰
    // 4. å‘é€è¶…æ—¶é€šçŸ¥ç»™æ‚£è€…
}
```

**æ‰§è¡Œé¢‘ç‡**: æ¯1åˆ†é’Ÿï¼ˆä¸å€™è¡¥ä¸€è‡´ï¼‰

---

## ğŸ”„ å®Œæ•´æµç¨‹

### å®¡æ‰¹é€šè¿‡æµç¨‹
```
ç®¡ç†å‘˜æ‰¹å‡†åŠ å·
    â†“
SlotApplicationService.updateSlotApplication()
    â†“
AddOnSlotService.processApprovedAddOn()
    â”œâ”€â†’ 1. æ›´æ–°ç”³è¯·çŠ¶æ€ï¼ˆAPPROVEDï¼‰
    â”œâ”€â†’ 2. åˆ›å»ºè™šæ‹Ÿå·æº
    â”‚   - is_add_on_slot = true
    â”‚   - reserved_for_patient_id = æ‚£è€…ID
    â”‚   - status = 'locked'
    â”œâ”€â†’ 3. ç”Ÿæˆé¢„çº¦è®°å½•
    â”‚   - appointment_type = 'ADD_ON'
    â”‚   - status = 'PENDING_PAYMENT'
    â”‚   - payment_deadline = NOW() + 24å°æ—¶
    â”œâ”€â†’ 4. å…³è”é¢„çº¦IDåˆ°ç”³è¯·
    â””â”€â†’ 5. å‘é€é€šçŸ¥ï¼ˆåŒ»ç”Ÿ + æ‚£è€…ï¼‰
```

### æ”¯ä»˜è¶…æ—¶å¤„ç†æµç¨‹
```
å®šæ—¶ä»»åŠ¡ï¼ˆæ¯1åˆ†é’Ÿï¼‰
    â†“
AddOnPaymentExpirationTask.checkExpiredAddOnPayments()
    â†“
æŸ¥è¯¢ payment_deadline < NOW()
    â”œâ”€â†’ 1. å–æ¶ˆé¢„çº¦ï¼ˆCANCELLEDï¼‰
    â”œâ”€â†’ 2. é‡Šæ”¾è™šæ‹Ÿå·æºï¼ˆcancelledï¼‰
    â””â”€â†’ 3. é€šçŸ¥æ‚£è€…ï¼ˆåŠ å·å·²å¤±æ•ˆï¼‰
```

### æ”¯ä»˜æˆåŠŸæµç¨‹
```
æ‚£è€…æ”¯ä»˜
    â†“
AddOnSlotService.handlePaymentSuccess()
    â”œâ”€â†’ 1. éªŒè¯æ”¯ä»˜æœŸé™
    â”œâ”€â†’ 2. æ›´æ–°é¢„çº¦çŠ¶æ€ï¼ˆscheduledï¼‰
    â”œâ”€â†’ 3. æ›´æ–°æ”¯ä»˜çŠ¶æ€ï¼ˆpaidï¼‰
    â”œâ”€â†’ 4. æ›´æ–°è™šæ‹Ÿå·æºå·²é¢„çº¦æ•°
    â””â”€â†’ 5. å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥
```

---

## ğŸ“Š æ•°æ®æµè½¬

### æ•°æ®åº“è¡¨å…³ç³»
```
slot_application (åŠ å·ç”³è¯·)
    â†“ appointment_id
    â†“ slot_application_id
    â†“
schedules (è™šæ‹Ÿå·æº)
    - is_add_on_slot = 1
    - reserved_for_patient_id = æ‚£è€…ID
    - status = 'locked'
    â†“ schedule_id
    â†“
appointments (é¢„çº¦è®°å½•)
    - appointment_type = 'ADD_ON'
    - status = 'PENDING_PAYMENT'
    - payment_deadline = æˆªæ­¢æ—¶é—´
```

---

## ğŸ¯ å…³é”®è®¾è®¡ç‚¹

### 1. å‚è€ƒå€™è¡¥æ¨¡å¼ âœ…
- **å€™è¡¥**: `notification_sent_at + 15åˆ†é’Ÿ`
- **åŠ å·**: `payment_deadlineï¼ˆç›´æ¥å­˜å‚¨æˆªæ­¢æ—¶é—´ï¼‰`
- **å®šæ—¶ä»»åŠ¡**: éƒ½æ˜¯æ¯1åˆ†é’Ÿæ‰§è¡Œ

### 2. ä¸æ–°å»ºè¡¨ âœ…
- å¤ç”¨ç°æœ‰çš„`schedules`å’Œ`appointments`è¡¨
- é€šè¿‡æ ‡è®°å­—æ®µåŒºåˆ†ï¼ˆ`is_add_on_slot`, `appointment_type`ï¼‰

### 3. è™šæ‹Ÿå·æº âœ…
- ç‰¹æ®Šçš„æ’ç­è®°å½•
- `status = 'locked'` å¯¹å¤–ä¸å¯è§
- `reserved_for_patient_id` é”å®šç»™ç‰¹å®šæ‚£è€…

### 4. äº‹åŠ¡ç®¡ç† âœ…
- æ•´ä¸ªå®¡æ‰¹æµç¨‹åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
- ç¡®ä¿åŸå­æ€§ï¼ˆè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼‰

### 5. é€šçŸ¥æœºåˆ¶ âœ…
- å®¡æ‰¹é€šè¿‡ï¼šé€šçŸ¥åŒ»ç”Ÿ + æ‚£è€…
- æ”¯ä»˜æˆåŠŸï¼šé€šçŸ¥æ‚£è€…
- æ”¯ä»˜è¶…æ—¶ï¼šé€šçŸ¥æ‚£è€…

---

## ğŸ“ é…ç½®å‚æ•°

### æ”¯ä»˜æœŸé™
```java
private static final int PAYMENT_DEADLINE_HOURS = 24; // 24å°æ—¶
```

### å®šæ—¶ä»»åŠ¡é¢‘ç‡
```java
@Scheduled(fixedRate = 60000) // æ¯60ç§’
```

---

## ğŸ” æ—¥å¿—è®°å½•

æ‰€æœ‰å…³é”®æ­¥éª¤éƒ½æœ‰è¯¦ç»†æ—¥å¿—ï¼š
```java
logger.info("å¼€å§‹å¤„ç†åŠ å·å®¡æ‰¹é€šè¿‡æµç¨‹ - applicationId: {}, patientId: {}", ...);
logger.info("åˆ›å»ºè™šæ‹Ÿå·æºæˆåŠŸ - scheduleId: {}", ...);
logger.info("ç”ŸæˆåŠ å·é¢„çº¦æˆåŠŸ - appointmentId: {}", ...);
logger.info("å¤„ç†è¶…æ—¶åŠ å·é¢„çº¦ - appointmentId: {}, deadline: {}", ...);
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¾ªç¯ä¾èµ–å¤„ç†**
   - `SlotApplicationService` ä½¿ç”¨setteræ³¨å…¥ `AddOnSlotService`
   - é¿å…æ„é€ å™¨æ³¨å…¥å¯¼è‡´çš„å¾ªç¯ä¾èµ–

2. **å¹¶å‘æ§åˆ¶**
   - ä½¿ç”¨`@Transactional`ç¡®ä¿äº‹åŠ¡éš”ç¦»
   - è™šæ‹Ÿå·æºåˆ›å»ºåœ¨äº‹åŠ¡ä¸­ï¼Œé˜²æ­¢é‡å¤åˆ›å»º

3. **å¼‚å¸¸å¤„ç†**
   - é€šçŸ¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
   - å•ä¸ªè¶…æ—¶è®°å½•å¤„ç†å¤±è´¥ä¸å½±å“å…¶ä»–è®°å½•

4. **æ•°æ®ä¸€è‡´æ€§**
   - å®šæ—¶ä»»åŠ¡å®šæœŸæ¸…ç†è¶…æ—¶æ•°æ®
   - æ”¯ä»˜å‰éªŒè¯æœŸé™

---

## ğŸ‰ ä¸‹ä¸€æ­¥ï¼ˆå¯é€‰ï¼‰

### å‰ç«¯å®ç°
1. **æ‚£è€…ç«¯**
   - åŠ å·é€šçŸ¥é¡µé¢
   - æ”¯ä»˜é¡µé¢
   - å€’è®¡æ—¶æ˜¾ç¤º

2. **ç®¡ç†å‘˜ç«¯**
   - å®¡æ‰¹æµç¨‹ä¼˜åŒ–ï¼ˆå·²å®ŒæˆåŸºç¡€åŠŸèƒ½ï¼‰
   - æ˜¾ç¤ºå…³è”çš„é¢„çº¦ä¿¡æ¯

### åŠŸèƒ½å¢å¼º
1. **æ”¯ä»˜é›†æˆ**
   - å¯¹æ¥çœŸå®æ”¯ä»˜ç½‘å…³
   - æ”¯ä»˜å›è°ƒå¤„ç†

2. **é€šçŸ¥å¢å¼º**
   - çŸ­ä¿¡é€šçŸ¥
   - å¾®ä¿¡é€šçŸ¥
   - é‚®ä»¶é€šçŸ¥

3. **æ•°æ®ç»Ÿè®¡**
   - åŠ å·ç”³è¯·ç»Ÿè®¡
   - æ”¯ä»˜æˆåŠŸç‡
   - è¶…æ—¶ç‡åˆ†æ

---

## âœ… éªŒè¯æ¸…å•

- [x] æ•°æ®åº“è¡¨ç»“æ„ä¿®æ”¹å®Œæˆ
- [x] å®ä½“ç±»å­—æ®µæ·»åŠ å®Œæˆ
- [x] RepositoryæŸ¥è¯¢æ–¹æ³•æ·»åŠ å®Œæˆ
- [x] AddOnSlotServiceåˆ›å»ºå®Œæˆ
- [x] å®šæ—¶ä»»åŠ¡åˆ›å»ºå®Œæˆ
- [x] SlotApplicationServiceé›†æˆå®Œæˆ
- [x] äº‹åŠ¡ç®¡ç†é…ç½®æ­£ç¡®
- [x] æ—¥å¿—è®°å½•å®Œå–„
- [x] å¼‚å¸¸å¤„ç†å®Œå–„

---

## ğŸš€ å¯åŠ¨éªŒè¯

### 1. å¯åŠ¨åç«¯
```bash
# ç¡®è®¤å®šæ—¶ä»»åŠ¡å¯åŠ¨
# æ—¥å¿—åº”æ˜¾ç¤ºï¼šå¼€å§‹æ‰§è¡ŒåŠ å·æ”¯ä»˜è¶…æ—¶å¤„ç†ä»»åŠ¡
```

### 2. æµ‹è¯•å®¡æ‰¹æµç¨‹
```bash
# 1. åŒ»ç”Ÿåˆ›å»ºåŠ å·ç”³è¯·
POST /api/slot-applications

# 2. ç®¡ç†å‘˜æ‰¹å‡†ç”³è¯·
PUT /api/slot-applications/{id}
{
  "status": "APPROVED",
  "approverId": 1,
  "approverComments": "æ‰¹å‡†"
}

# 3. æ£€æŸ¥æ•°æ®åº“
# - schedulesè¡¨åº”æœ‰æ–°çš„è™šæ‹Ÿå·æºï¼ˆis_add_on_slot=1ï¼‰
# - appointmentsè¡¨åº”æœ‰æ–°çš„é¢„çº¦ï¼ˆappointment_type='ADD_ON'ï¼‰
# - slot_applicationè¡¨çš„appointment_idåº”å·²å¡«å……
```

### 3. æµ‹è¯•è¶…æ—¶å¤„ç†
```bash
# 1. ä¿®æ”¹payment_deadlineä¸ºè¿‡å»æ—¶é—´
UPDATE appointments SET payment_deadline = '2025-01-01 00:00:00' WHERE appointment_id = ?;

# 2. ç­‰å¾…1åˆ†é’Ÿï¼Œå®šæ—¶ä»»åŠ¡åº”è‡ªåŠ¨å¤„ç†
# 3. æ£€æŸ¥é¢„çº¦çŠ¶æ€åº”å˜ä¸ºCANCELLED
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- `åŠ å·ä¸å€™è¡¥å®ç°å¯¹æ¯”.md` - è®¾è®¡å¯¹æ¯”æ–‡æ¡£
- `åŠ å·åŠŸèƒ½å®æ–½æŒ‡å—.md` - æ‰§è¡ŒæŒ‡å—
- `15_add_add_on_fields.sql` - SQLè„šæœ¬

---

## ğŸ¯ æ€»ç»“

åŠ å·åŠŸèƒ½åç«¯æ ¸å¿ƒé€»è¾‘å·²å…¨éƒ¨å®ç°å®Œæˆï¼

**æ ¸å¿ƒç‰¹æ€§**ï¼š
âœ… å‚è€ƒå€™è¡¥çš„æˆç†Ÿå®ç°
âœ… ä¸æ–°å»ºè¡¨ï¼Œå¤ç”¨ç°æœ‰ç»“æ„
âœ… è™šæ‹Ÿå·æºæœºåˆ¶
âœ… è‡ªåŠ¨æ”¯ä»˜è¶…æ—¶å¤„ç†
âœ… å®Œæ•´çš„äº‹åŠ¡ç®¡ç†
âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

**ä¸‹ä¸€æ­¥**ï¼š
- å‰ç«¯å®ç°ï¼ˆæ‚£è€…ç«¯æ”¯ä»˜é¡µé¢ï¼‰
- é›†æˆçœŸå®æ”¯ä»˜ç½‘å…³
- å®Œå–„é€šçŸ¥æœºåˆ¶

ğŸ‰ æ­å–œï¼åç«¯å®ç°å®Œæˆï¼
